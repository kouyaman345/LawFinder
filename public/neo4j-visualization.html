<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawFinder - Neo4jå‚ç…§é–¢ä¿‚å¯è¦–åŒ–ï¼ˆä½ç½®æƒ…å ±ä»˜ãï¼‰</title>
    <script src="https://unpkg.com/neo4j-driver"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .connection-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .connection-panel h2 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            flex: 1;
            min-width: 150px;
        }
        
        .form-group button {
            padding: 10px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .form-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .visualization-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .panel h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        #network {
            height: 500px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        
        #details {
            height: 500px;
            overflow-y: auto;
        }
        
        .detail-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .detail-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .detail-item .position-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .detail-item .position-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .detail-item .position-info .label {
            font-weight: bold;
            color: #666;
        }
        
        .detail-item .position-info .value {
            color: #333;
            font-family: monospace;
        }
        
        .stats-panel {
            grid-column: span 2;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .query-panel {
            grid-column: span 2;
        }
        
        .query-editor {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .query-result {
            margin-top: 15px;
            max-height: 400px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            .visualization-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-panel, .query-panel {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LawFinder Neo4j å‚ç…§é–¢ä¿‚å¯è¦–åŒ–</h1>
        
        <!-- æ¥ç¶šãƒ‘ãƒãƒ« -->
        <div class="connection-panel">
            <h2>Neo4jæ¥ç¶šè¨­å®š</h2>
            <div class="form-group">
                <input type="text" id="neo4j-url" value="bolt://localhost:7687" placeholder="Neo4j URL">
                <input type="text" id="neo4j-user" value="neo4j" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
                <input type="password" id="neo4j-password" value="lawfinder123" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button onclick="connectToNeo4j()">æ¥ç¶š</button>
            </div>
            <div id="connection-status"></div>
        </div>
        
        <!-- ã‚°ãƒ©ãƒ•ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ -->
        <div class="panel" style="margin-bottom: 20px;">
            <h3>ğŸ¯ ã‚°ãƒ©ãƒ•ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ</h3>
            <div class="form-group">
                <select id="graph-preset" onchange="loadGraphPreset()" style="min-width: 300px;">
                    <option value="enhanced">æ‹¡å¼µå‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆä½ç½®æƒ…å ±ä»˜ãï¼‰</option>
                    <option value="civil">æ°‘æ³•ã®å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</option>
                    <option value="commercial">å•†æ³•ã®å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</option>
                    <option value="criminal">åˆ‘æ³•ã®å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</option>
                    <option value="mutual">ç›¸äº’å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</option>
                    <option value="chain">å‚ç…§ãƒã‚§ãƒ¼ãƒ³ï¼ˆ3æ®µéšï¼‰</option>
                    <option value="hierarchy">æ³•ä»¤éšå±¤æ§‹é€ </option>
                    <option value="density">é«˜å¯†åº¦å‚ç…§ãƒãƒ¼ãƒ‰</option>
                </select>
                <button onclick="loadGraphPreset()">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
                <span id="graph-status" style="margin-left: 10px; color: #666;"></span>
            </div>
        </div>
        
        <!-- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚°ãƒªãƒƒãƒ‰ -->
        <div class="visualization-grid">
            <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚°ãƒ©ãƒ• -->
            <div class="panel">
                <h3>ğŸ“Š <span id="graph-title">å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆä½ç½®æƒ…å ±ä»˜ãï¼‰</span></h3>
                <div id="network"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>æ³•ä»¤</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196F3;"></div>
                        <span>æ¡æ–‡</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9800;"></div>
                        <span>é …</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9C27B0;"></div>
                        <span>æ‹¡å¼µå‚ç…§</span>
                    </div>
                </div>
            </div>
            
            <!-- è©³ç´°æƒ…å ±ãƒ‘ãƒãƒ« -->
            <div class="panel">
                <h3>ğŸ“ ä½ç½®æƒ…å ±è©³ç´°</h3>
                <div id="details">
                    <p style="color: #999; text-align: center; padding: 20px;">
                        ã‚°ãƒ©ãƒ•ã®ã‚¨ãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </p>
                </div>
            </div>
            
            <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
            <div class="panel stats-panel">
                <h3>ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <h4>æ‹¡å¼µå‚ç…§æ•°</h4>
                        <div class="value" id="enhanced-count">-</div>
                    </div>
                    <div class="stat-card">
                        <h4>å¹³å‡ä¿¡é ¼åº¦</h4>
                        <div class="value" id="avg-confidence">-</div>
                    </div>
                    <div class="stat-card">
                        <h4>æ³•ä»¤æ•°</h4>
                        <div class="value" id="law-count">-</div>
                    </div>
                    <div class="stat-card">
                        <h4>æ¡æ–‡æ•°</h4>
                        <div class="value" id="article-count">-</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="position-chart"></canvas>
                </div>
            </div>
            
            <!-- ã‚¯ã‚¨ãƒªå®Ÿè¡Œãƒ‘ãƒãƒ« -->
            <div class="panel query-panel">
                <h3>ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªå®Ÿè¡Œ</h3>
                <textarea class="query-editor" id="custom-query">
// ä½ç½®æƒ…å ±ä»˜ãå‚ç…§ã‚’å–å¾—
MATCH (source)-[r:REFERENCES]->(target)
WHERE r.enhanced = true
RETURN 
  source.lawId as å‚ç…§å…ƒæ³•ä»¤,
  source.number as å‚ç…§å…ƒæ¡æ–‡,
  r.sourceText as å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ,
  r.sourceStartPos as é–‹å§‹ä½ç½®,
  r.sourceEndPos as çµ‚äº†ä½ç½®,
  r.sourceLineNumber as è¡Œç•ªå·,
  target.lawId as å‚ç…§å…ˆæ³•ä»¤,
  target.number as å‚ç…§å…ˆæ¡æ–‡
LIMIT 10</textarea>
                <div class="form-group" style="margin-top: 10px;">
                    <button onclick="executeQuery()">ã‚¯ã‚¨ãƒªå®Ÿè¡Œ</button>
                    <select id="preset-queries" onchange="loadPresetQuery()">
                        <option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ã‚¨ãƒªã‚’é¸æŠ...</option>
                        <option value="enhanced">æ‹¡å¼µå‚ç…§ä¸€è¦§</option>
                        <option value="civil">æ°‘æ³•ã®å‚ç…§</option>
                        <option value="commercial">å•†æ³•ã®å‚ç…§</option>
                        <option value="mutual">ç›¸äº’å‚ç…§</option>
                        <option value="chain">å‚ç…§ãƒã‚§ãƒ¼ãƒ³</option>
                        <option value="stats">çµ±è¨ˆæƒ…å ±</option>
                    </select>
                </div>
                <div class="query-result" id="query-result"></div>
            </div>
        </div>
    </div>
    
    <script>
        let driver = null;
        let network = null;
        let nodes = null;
        let edges = null;
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ã‚¨ãƒª
        const presetQueries = {
            enhanced: `MATCH (source)-[r:REFERENCES]->(target)
WHERE r.enhanced = true
RETURN 
  source.lawId as å‚ç…§å…ƒæ³•ä»¤,
  source.number as å‚ç…§å…ƒæ¡æ–‡,
  r.sourceText as å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ,
  r.sourceStartPos as é–‹å§‹ä½ç½®,
  r.sourceEndPos as çµ‚äº†ä½ç½®,
  r.sourceLineNumber as è¡Œç•ªå·,
  target.lawId as å‚ç…§å…ˆæ³•ä»¤,
  target.number as å‚ç…§å…ˆæ¡æ–‡
LIMIT 20`,
            
            civil: `MATCH (civil:Law {id: '129AC0000000089'})-[:HAS_ARTICLE]->(article:Article)
OPTIONAL MATCH (article)-[r:REFERENCES]->(target)
WHERE r.enhanced = true
RETURN article.number as æ¡æ–‡, r.sourceText as å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ, 
       r.sourceStartPos as é–‹å§‹ä½ç½®, target.lawId as å‚ç…§å…ˆ, target.number as å‚ç…§å…ˆæ¡æ–‡
LIMIT 20`,
            
            commercial: `MATCH (commercial:Law {id: '132AC0000000048'})-[:HAS_ARTICLE]->(article:Article)
OPTIONAL MATCH (article)-[r:REFERENCES]->(target)
WHERE r.enhanced = true
RETURN article.number as æ¡æ–‡, r.sourceText as å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ,
       r.sourceStartPos as é–‹å§‹ä½ç½®, target.lawId as å‚ç…§å…ˆ, target.number as å‚ç…§å…ˆæ¡æ–‡
LIMIT 20`,
            
            mutual: `MATCH (a)-[r1:REFERENCES]->(b)
MATCH (b)-[r2:REFERENCES]->(a)
WHERE r1.enhanced = true AND r2.enhanced = true
RETURN a.lawId as æ³•ä»¤A, a.number as æ¡æ–‡A,
       b.lawId as æ³•ä»¤B, b.number as æ¡æ–‡B
LIMIT 10`,
            
            chain: `MATCH path = (start:Article)-[:REFERENCES*1..3]->(end:Article)
WHERE ALL(r IN relationships(path) WHERE r.enhanced = true)
RETURN length(path) as ãƒã‚§ãƒ¼ãƒ³é•·, 
       [n IN nodes(path) | n.lawId + ':' + n.number] as çµŒè·¯
LIMIT 10`,
            
            stats: `MATCH ()-[r:REFERENCES]->()
WHERE r.enhanced = true
RETURN 
  count(r) as æ‹¡å¼µå‚ç…§æ•°,
  avg(r.confidence) as å¹³å‡ä¿¡é ¼åº¦,
  min(r.sourceStartPos) as æœ€å°é–‹å§‹ä½ç½®,
  max(r.sourceEndPos) as æœ€å¤§çµ‚äº†ä½ç½®,
  avg(r.sourceLineNumber) as å¹³å‡è¡Œç•ªå·`
        };
        
        // Neo4jæ¥ç¶š
        async function connectToNeo4j() {
            const url = document.getElementById('neo4j-url').value;
            const user = document.getElementById('neo4j-user').value;
            const password = document.getElementById('neo4j-password').value;
            const statusDiv = document.getElementById('connection-status');
            
            try {
                driver = neo4j.driver(url, neo4j.auth.basic(user, password));
                const session = driver.session();
                
                // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                await session.run('RETURN 1');
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadData();
                await loadStats();
                
                statusDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†';
                
                session.close();
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ æ¥ç¶šå¤±æ•—: ${error.message}`;
                console.error('Connection error:', error);
            }
        }
        
        // ã‚°ãƒ©ãƒ•ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ã‚¨ãƒª
        const graphPresets = {
            enhanced: {
                title: 'æ‹¡å¼µå‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆä½ç½®æƒ…å ±ä»˜ãï¼‰',
                query: `MATCH (source)-[r:REFERENCES]->(target)
                        WHERE r.enhanced = true
                        RETURN source, r, target
                        LIMIT 100`
            },
            civil: {
                title: 'æ°‘æ³•ã®å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯',
                query: `MATCH (civil:Law {id: '129AC0000000089'})-[:HAS_ARTICLE]->(article:Article)
                        OPTIONAL MATCH (article)-[r:REFERENCES]->(target)
                        RETURN article as source, r, target
                        LIMIT 100`
            },
            commercial: {
                title: 'å•†æ³•ã®å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯',
                query: `MATCH (commercial:Law {id: '132AC0000000048'})-[:HAS_ARTICLE]->(article:Article)
                        OPTIONAL MATCH (article)-[r:REFERENCES]->(target)
                        RETURN article as source, r, target
                        LIMIT 100`
            },
            criminal: {
                title: 'åˆ‘æ³•ã®å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯',
                query: `MATCH (criminal:Law {id: '140AC0000000045'})-[:HAS_ARTICLE]->(article:Article)
                        OPTIONAL MATCH (article)-[r:REFERENCES]->(target)
                        RETURN article as source, r, target
                        LIMIT 100`
            },
            mutual: {
                title: 'ç›¸äº’å‚ç…§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯',
                query: `MATCH (a)-[r1:REFERENCES]->(b)
                        MATCH (b)-[r2:REFERENCES]->(a)
                        WHERE r1.enhanced = true OR r2.enhanced = true
                        RETURN a as source, r1 as r, b as target
                        UNION
                        MATCH (a)-[r1:REFERENCES]->(b)
                        MATCH (b)-[r2:REFERENCES]->(a)
                        WHERE r1.enhanced = true OR r2.enhanced = true
                        RETURN b as source, r2 as r, a as target
                        LIMIT 50`
            },
            chain: {
                title: 'å‚ç…§ãƒã‚§ãƒ¼ãƒ³ï¼ˆ3æ®µéšï¼‰',
                query: `MATCH path = (start:Article)-[:REFERENCES*1..3]->(end:Article)
                        WHERE ALL(r IN relationships(path) WHERE r.enhanced = true OR r.confidence > 0.8)
                        WITH path, nodes(path) as nodes, relationships(path) as rels
                        UNWIND range(0, size(nodes)-2) as i
                        RETURN nodes[i] as source, rels[i] as r, nodes[i+1] as target
                        LIMIT 100`
            },
            hierarchy: {
                title: 'æ³•ä»¤éšå±¤æ§‹é€ ',
                query: `MATCH (law:Law)-[:HAS_ARTICLE]->(article:Article)
                        WHERE law.id IN ['129AC0000000089', '132AC0000000048', '140AC0000000045']
                        OPTIONAL MATCH (article)-[:HAS_PARAGRAPH]->(paragraph:Paragraph)
                        WITH law, article, paragraph
                        RETURN law as source, 
                               {type: 'HAS_ARTICLE', properties: {type: 'structure'}} as r, 
                               article as target
                        UNION
                        MATCH (article:Article)-[:HAS_PARAGRAPH]->(paragraph:Paragraph)
                        RETURN article as source,
                               {type: 'HAS_PARAGRAPH', properties: {type: 'structure'}} as r,
                               paragraph as target
                        LIMIT 100`
            },
            density: {
                title: 'é«˜å¯†åº¦å‚ç…§ãƒãƒ¼ãƒ‰',
                query: `MATCH (article:Article)
                        WITH article, size((article)-[:REFERENCES]->()) as outDegree,
                             size((article)<-[:REFERENCES]-()) as inDegree
                        WHERE outDegree + inDegree > 3
                        MATCH (article)-[r:REFERENCES]-(connected)
                        RETURN article as source, r, connected as target
                        LIMIT 100`
            }
        };
        
        // ã‚°ãƒ©ãƒ•ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
        async function loadGraphPreset() {
            const preset = document.getElementById('graph-preset').value;
            const statusSpan = document.getElementById('graph-status');
            const titleSpan = document.getElementById('graph-title');
            
            if (!driver) {
                statusSpan.textContent = 'âš ï¸ å…ˆã«æ¥ç¶šã—ã¦ãã ã•ã„';
                statusSpan.style.color = 'red';
                return;
            }
            
            const presetConfig = graphPresets[preset];
            if (!presetConfig) return;
            
            statusSpan.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
            statusSpan.style.color = '#666';
            titleSpan.textContent = presetConfig.title;
            
            const session = driver.session();
            
            try {
                const result = await session.run(presetConfig.query);
                
                const nodeMap = new Map();
                const edgeList = [];
                
                result.records.forEach(record => {
                    const source = record.get('source');
                    const target = record.get('target');
                    const ref = record.get('r');
                    
                    if (source) {
                        const sourceId = generateNodeId(source);
                        if (!nodeMap.has(sourceId)) {
                            nodeMap.set(sourceId, createNodeData(source, sourceId));
                        }
                    }
                    
                    if (target) {
                        const targetId = generateNodeId(target);
                        if (!nodeMap.has(targetId)) {
                            nodeMap.set(targetId, createNodeData(target, targetId));
                        }
                    }
                    
                    if (source && target && ref) {
                        edgeList.push(createEdgeData(
                            generateNodeId(source),
                            generateNodeId(target),
                            ref
                        ));
                    }
                });
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ›´æ–°
                updateNetwork(Array.from(nodeMap.values()), edgeList);
                
                statusSpan.textContent = `âœ… ${result.records.length}ä»¶èª­ã¿è¾¼ã¿å®Œäº†`;
                statusSpan.style.color = 'green';
                
            } catch (error) {
                statusSpan.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusSpan.style.color = 'red';
                console.error('Graph preset error:', error);
            } finally {
                session.close();
            }
        }
        
        // ãƒãƒ¼ãƒ‰IDç”Ÿæˆ
        function generateNodeId(node) {
            if (!node) return 'unknown';
            const labels = node.labels || [];
            const props = node.properties || {};
            return `${labels[0] || 'Node'}_${props.id || props.lawId + '_' + props.number || Math.random()}`;
        }
        
        // ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        function createNodeData(node, id) {
            const labels = node.labels || [];
            const props = node.properties || {};
            return {
                id: id,
                label: props.number || props.id || props.name || 'Unknown',
                group: labels[0] || 'Unknown',
                title: `${labels[0]}: ${JSON.stringify(props, null, 2)}`
            };
        }
        
        // ã‚¨ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        function createEdgeData(sourceId, targetId, ref) {
            const props = ref.properties || {};
            return {
                from: sourceId,
                to: targetId,
                label: props.type || ref.type || 'REFERENCES',
                title: `å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ: ${props.sourceText || 'N/A'}
é–‹å§‹ä½ç½®: ${props.sourceStartPos || 'N/A'}
çµ‚äº†ä½ç½®: ${props.sourceEndPos || 'N/A'}
è¡Œç•ªå·: ${props.sourceLineNumber || 'N/A'}
ä¿¡é ¼åº¦: ${props.confidence || 'N/A'}`,
                color: props.enhanced ? '#9C27B0' : (ref.type === 'HAS_ARTICLE' || ref.type === 'HAS_PARAGRAPH' ? '#4CAF50' : '#999'),
                width: props.confidence ? props.confidence * 3 : 1,
                arrows: ref.type === 'REFERENCES' ? 'to' : '',
                data: props
            };
        }
        
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ›´æ–°
        function updateNetwork(nodeData, edgeData) {
            if (nodes) nodes.clear();
            if (edges) edges.clear();
            
            nodes.add(nodeData);
            edges.add(edgeData);
            
            if (network) {
                network.fit();
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            const preset = document.getElementById('graph-preset').value;
            const presetConfig = graphPresets[preset];
            const session = driver.session();
            
            try {
                // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨
                const result = await session.run(presetConfig.query);
                
                const nodeMap = new Map();
                const edgeList = [];
                
                result.records.forEach(record => {
                    const source = record.get('source');
                    const target = record.get('target');
                    const ref = record.get('r');
                    
                    // ã‚½ãƒ¼ã‚¹ãƒãƒ¼ãƒ‰è¿½åŠ 
                    const sourceId = `${source.labels[0]}_${source.properties.id || source.properties.lawId + '_' + source.properties.number}`;
                    if (!nodeMap.has(sourceId)) {
                        nodeMap.set(sourceId, {
                            id: sourceId,
                            label: source.properties.number || source.properties.id || 'Unknown',
                            group: source.labels[0],
                            title: `${source.labels[0]}: ${JSON.stringify(source.properties, null, 2)}`
                        });
                    }
                    
                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ãƒ‰è¿½åŠ 
                    const targetId = `${target.labels[0]}_${target.properties.id || target.properties.lawId + '_' + target.properties.number}`;
                    if (!nodeMap.has(targetId)) {
                        nodeMap.set(targetId, {
                            id: targetId,
                            label: target.properties.number || target.properties.id || 'Unknown',
                            group: target.labels[0],
                            title: `${target.labels[0]}: ${JSON.stringify(target.properties, null, 2)}`
                        });
                    }
                    
                    // ã‚¨ãƒƒã‚¸è¿½åŠ 
                    edgeList.push({
                        from: sourceId,
                        to: targetId,
                        label: ref.properties.type || 'REFERENCES',
                        title: `å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ: ${ref.properties.sourceText || 'N/A'}
é–‹å§‹ä½ç½®: ${ref.properties.sourceStartPos || 'N/A'}
çµ‚äº†ä½ç½®: ${ref.properties.sourceEndPos || 'N/A'}
è¡Œç•ªå·: ${ref.properties.sourceLineNumber || 'N/A'}
ä¿¡é ¼åº¦: ${ref.properties.confidence || 'N/A'}`,
                        color: ref.properties.enhanced ? '#9C27B0' : '#999',
                        width: ref.properties.confidence ? ref.properties.confidence * 3 : 1,
                        arrows: 'to',
                        data: ref.properties
                    });
                });
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œæˆ
                createNetwork(Array.from(nodeMap.values()), edgeList);
                
            } finally {
                session.close();
            }
        }
        
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œæˆ
        function createNetwork(nodeData, edgeData) {
            const container = document.getElementById('network');
            
            nodes = new vis.DataSet(nodeData);
            edges = new vis.DataSet(edgeData);
            
            const data = { nodes, edges };
            
            const options = {
                groups: {
                    Law: { color: { background: '#4CAF50' }, shape: 'box' },
                    Article: { color: { background: '#2196F3' }, shape: 'ellipse' },
                    Paragraph: { color: { background: '#FF9800' }, shape: 'diamond' },
                    Item: { color: { background: '#F44336' }, shape: 'triangle' }
                },
                physics: {
                    enabled: true,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -50,
                        springLength: 200,
                        springConstant: 0.05
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 0
                }
            };
            
            network = new vis.Network(container, data, options);
            
            // ã‚¨ãƒƒã‚¸ã‚¯ãƒªãƒƒã‚¯æ™‚ã®è©³ç´°è¡¨ç¤º
            network.on('selectEdge', function(params) {
                if (params.edges.length > 0) {
                    const edgeId = params.edges[0];
                    const edge = edges.get(edgeId);
                    showEdgeDetails(edge);
                }
            });
        }
        
        // ã‚¨ãƒƒã‚¸è©³ç´°è¡¨ç¤º
        function showEdgeDetails(edge) {
            const detailsDiv = document.getElementById('details');
            const data = edge.data || {};
            
            detailsDiv.innerHTML = `
                <div class="detail-item">
                    <h4>å‚ç…§æƒ…å ±</h4>
                    <p><strong>å‚ç…§ã‚¿ã‚¤ãƒ—:</strong> ${data.type || 'N/A'}</p>
                    <p><strong>å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ:</strong> ${data.sourceText || 'N/A'}</p>
                    <p><strong>ä¿¡é ¼åº¦:</strong> ${data.confidence ? (data.confidence * 100).toFixed(1) + '%' : 'N/A'}</p>
                    <p><strong>æ¤œå‡ºæ–¹æ³•:</strong> ${data.detectionMethod || 'N/A'}</p>
                    
                    <div class="position-info">
                        <span>
                            <span class="label">ğŸ“ é–‹å§‹ä½ç½®:</span>
                            <span class="value">${data.sourceStartPos || 'N/A'}</span>
                        </span>
                        <span>
                            <span class="label">ğŸ“ çµ‚äº†ä½ç½®:</span>
                            <span class="value">${data.sourceEndPos || 'N/A'}</span>
                        </span>
                        <span>
                            <span class="label">ğŸ“„ è¡Œç•ªå·:</span>
                            <span class="value">${data.sourceLineNumber || 'N/A'}</span>
                        </span>
                        <span>
                            <span class="label">ğŸ“ å‚ç…§é•·:</span>
                            <span class="value">${data.sourceEndPos && data.sourceStartPos ? 
                                (data.sourceEndPos - data.sourceStartPos) + ' æ–‡å­—' : 'N/A'}</span>
                        </span>
                    </div>
                </div>
            `;
        }
        
        // çµ±è¨ˆæƒ…å ±èª­ã¿è¾¼ã¿
        async function loadStats() {
            const session = driver.session();
            
            try {
                // çµ±è¨ˆã‚¯ã‚¨ãƒªå®Ÿè¡Œ
                const result = await session.run(`
                    MATCH (l:Law)
                    WITH count(l) as lawCount
                    MATCH (a:Article)
                    WITH lawCount, count(a) as articleCount
                    MATCH ()-[r:REFERENCES]->()
                    WHERE r.enhanced = true
                    WITH lawCount, articleCount, count(r) as enhancedCount, avg(r.confidence) as avgConfidence
                    RETURN lawCount, articleCount, enhancedCount, avgConfidence
                `);
                
                if (result.records.length > 0) {
                    const record = result.records[0];
                    document.getElementById('law-count').textContent = record.get('lawCount').toNumber();
                    document.getElementById('article-count').textContent = record.get('articleCount').toNumber();
                    document.getElementById('enhanced-count').textContent = record.get('enhancedCount').toNumber();
                    document.getElementById('avg-confidence').textContent = 
                        (record.get('avgConfidence') * 100).toFixed(1) + '%';
                }
                
                // ä½ç½®æƒ…å ±åˆ†å¸ƒã‚°ãƒ©ãƒ•
                await loadPositionChart();
                
            } finally {
                session.close();
            }
        }
        
        // ä½ç½®æƒ…å ±åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ
        async function loadPositionChart() {
            const session = driver.session();
            
            try {
                const result = await session.run(`
                    MATCH ()-[r:REFERENCES]->()
                    WHERE r.enhanced = true AND r.sourceLineNumber IS NOT NULL
                    RETURN r.sourceLineNumber as line, count(*) as count
                    ORDER BY line
                    LIMIT 20
                `);
                
                const labels = [];
                const data = [];
                
                result.records.forEach(record => {
                    labels.push(`è¡Œ ${record.get('line')}`);
                    data.push(record.get('count').toNumber());
                });
                
                const ctx = document.getElementById('position-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å‚ç…§æ•°',
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.5)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'è¡Œç•ªå·åˆ¥å‚ç…§åˆ†å¸ƒ'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } finally {
                session.close();
            }
        }
        
        // ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
        async function executeQuery() {
            const query = document.getElementById('custom-query').value;
            const resultDiv = document.getElementById('query-result');
            
            if (!driver) {
                resultDiv.innerHTML = '<p style="color: red;">å…ˆã«Neo4jã«æ¥ç¶šã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            const session = driver.session();
            
            try {
                resultDiv.innerHTML = '<p>å®Ÿè¡Œä¸­...</p>';
                
                const result = await session.run(query);
                
                if (result.records.length === 0) {
                    resultDiv.innerHTML = '<p>çµæœãªã—</p>';
                    return;
                }
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
                const keys = result.records[0].keys;
                let html = '<table><thead><tr>';
                keys.forEach(key => {
                    html += `<th>${key}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                result.records.forEach(record => {
                    html += '<tr>';
                    keys.forEach(key => {
                        const value = record.get(key);
                        html += `<td>${value === null ? 'NULL' : value}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            } finally {
                session.close();
            }
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ã‚¨ãƒªèª­ã¿è¾¼ã¿
        function loadPresetQuery() {
            const select = document.getElementById('preset-queries');
            const editor = document.getElementById('custom-query');
            
            if (select.value && presetQueries[select.value]) {
                editor.value = presetQueries[select.value];
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•æ¥ç¶šè©¦è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            // è‡ªå‹•æ¥ç¶šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®å ´åˆï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                setTimeout(() => {
                    connectToNeo4j();
                }, 500);
            }
        });
    </script>
</body>
</html>