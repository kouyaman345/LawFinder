# 相対参照解決システム実装報告書

## 実施日時
2025年8月22日

## 実装概要
「前項」「次条」などの相対参照を実際の条文番号に自動変換するシステムを実装しました。

## 実装ファイル

### 1. `/src/services/relative-reference-resolver.ts`
相対参照解決の中核となるサービスクラス

#### 主要機能
- **resolve()**: 単一の相対参照を解決
- **resolveMultiple()**: 複数の相対参照を一括解決
- **resolveContinuous()**: コンテキストを更新しながら連続解決

#### 対応パターン

##### 条文レベル
- 前条、次条、前二条、次三条
- 前数条、次数条

##### 項レベル
- 前項、次項、前二項、次三項
- 前各項（全ての前の項を対象）

##### 号レベル
- 前号、次号、前二号、次三号
- 前各号（全ての前の号を対象）

##### 複合パターン
- 前条第二項、次条第一項
- 前項第三号、次項第一号

##### 同一参照
- 同条、本条（現在の条文）
- 同項、本項（現在の項）
- 各項（全ての項）

### 2. `/tests/relative-reference-resolver.test.ts`
包括的なテストスイート（25テストケース）

## テスト結果

```
✅ 全25テストケース成功
- 条文レベルの相対参照: 5/5 成功
- 項レベルの相対参照: 5/5 成功
- 号レベルの相対参照: 3/3 成功
- 複合的な相対参照: 3/3 成功
- 同一参照: 4/4 成功
- バッチ解決: 1/1 成功
- 連続解決: 1/1 成功
- エッジケース: 3/3 成功
```

## 実装の特徴

### 1. コンテキスト認識
```typescript
interface CurrentContext {
  lawId: string;          // 現在の法令
  articleNumber: string;   // 現在の条文番号
  paragraphNumber?: number;// 現在の項番号
  itemNumber?: string;     // 現在の号番号
}
```

### 2. 信頼度スコア
各解決結果に信頼度スコアを付与：
- 0.95: 完全一致パターン
- 0.85: 複合パターン
- 0.30: 解決不可能な参照（エラー付き）

### 3. エラー処理
- 第1条で「前条」→ エラーメッセージ付きで低信頼度
- 範囲外の参照を適切に処理

### 4. 漢数字対応
「前二条」「第三項」などの漢数字を正確に処理

## detector.tsへの統合

```typescript
// 相対参照を検出して実際の条文番号に変換
if (relativeReferenceResolver) {
  const resolved = relativeReferenceResolver.resolve(
    matchedText,
    currentContext
  );
  
  if (resolved && resolved.confidence > 0.5) {
    // 解決された条文番号で参照を作成
    targetArticle = resolved.articleNumber;
    targetParagraph = resolved.paragraphNumber;
  }
}
```

## 活用例

### 入力テキスト
```
第90条第2項において「前項の規定は...」
```

### 解決結果
```javascript
{
  articleNumber: '90',
  paragraphNumber: 1,    // 前項 = 第1項
  articleDisplay: '第90条',
  confidence: 0.95
}
```

## 今後の展開

1. **Webインターフェースでの活用**
   - 相対参照を実際のリンクに自動変換
   - ツールチップで解決先を表示

2. **検索機能の強化**
   - 「前項」で検索→実際の条項番号でも検索

3. **Neo4jへの展開**
   - 相対参照を解決してグラフエッジを生成

## まとめ

相対参照解決システムの実装により、日本の法令文書で頻繁に使用される「前項」「次条」などの相対的な参照表現を、実際の条文番号に自動変換できるようになりました。これにより参照の追跡性と検索性が大幅に向上します。