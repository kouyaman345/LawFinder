# データ処理統一実装報告書

## 実施日時
2025年8月22日 14:00

## 実施内容
条文番号のデータ処理を統一し、システム全体で一貫した形式を使用するように改修しました。

## 実装した機能

### 1. 条文番号正規化ユーティリティ
`/src/utils/article-normalizer.ts`

#### 主要機能
- **normalizeArticleNumber()**: 様々な形式の条文番号を統一形式に変換
- **toNumericFormat()**: データベース保存用の数値形式に変換（例：「90」）
- **toDisplayFormat()**: 表示用の完全形式に変換（例：「第90条」）
- **resolveRelativeReference()**: 相対参照（前条、次条等）を解決
- **extractArticleNumbers()**: テキストから条文番号を抽出

#### 対応形式
| 入力形式 | 数値形式（DB） | 表示形式（UI） |
|----------|---------------|---------------|
| 第90条 | 90 | 第90条 |
| 90 | 90 | 第90条 |
| 90条 | 90 | 第90条 |
| 第九十条 | 90 | 第90条 |
| Article 90 | 90 | 第90条 |

### 2. 漢数字変換の改善
完全な漢数字変換ロジックを実装：
- 九十 → 90（正しく変換）
- 百二十三 → 123
- 千五百 → 1500

### 3. データ正規化スクリプト
`/scripts/normalize-article-numbers.ts`

#### 機能
- PostgreSQL参照データの正規化
- Neo4j条文ノードの正規化
- Neo4j参照エッジの正規化
- バックアップ作成
- 統計表示

#### 実行オプション
```bash
# 全データベース正規化
npx tsx scripts/normalize-article-numbers.ts

# PostgreSQLのみ
npx tsx scripts/normalize-article-numbers.ts --postgres-only

# Neo4jのみ
npx tsx scripts/normalize-article-numbers.ts --neo4j-only

# バックアップスキップ
npx tsx scripts/normalize-article-numbers.ts --skip-backup

# ドライラン（実際の更新なし）
npx tsx scripts/normalize-article-numbers.ts --dry-run
```

### 4. 既存コードの更新

#### detector.ts
- 条文番号保存時に`toNumericFormat()`を使用
- 統一された形式で参照を検出・保存

#### sync-enhanced-to-neo4j.ts  
- Neo4j同期時に正規化処理を追加
- displayNumberとoriginalNumberフィールドを保持

### 5. テストケース
`/tests/article-normalizer.test.ts`

15個のテストケースを実装：
- ✅ 様々な形式の正規化
- ✅ 漢数字の変換
- ✅ 表示形式への変換
- ✅ 数値形式への変換
- ✅ 条文番号の比較
- ✅ 有効性チェック
- ✅ 範囲生成
- ✅ テキストからの抽出
- ✅ 相対参照の解決

## 実施結果

### Neo4jデータ正規化結果
```
┌─────────────────┬──────┬──────┬──────┐
│     (index)     │ 総数 │ 更新 │ 失敗 │
├─────────────────┼──────┼──────┼──────┤
│ Neo4j条文ノード │  62  │  62  │  0   │
│ Neo4j参照エッジ │ 106  │  0   │  0   │
└─────────────────┴──────┴──────┴──────┘
```

### 正規化後のデータ形式
```
a.number | a.displayNumber | a.originalNumber
---------|-----------------|------------------
"90"     | "第90条"        | "第90条"
"1"      | "第1条"         | "第1条"
"2"      | "第2条"         | "第2条"
```

## データ構造の改善

### Neo4jノード構造
```cypher
(:Article {
  lawId: "129AC0000000089",
  number: "90",           // 数値形式（検索・ソート用）
  displayNumber: "第90条", // 表示形式（UI用）
  originalNumber: "第90条" // 元の形式（監査用）
})
```

### PostgreSQLテーブル構造
```sql
Reference {
  sourceArticle: "90",    -- 数値形式で統一
  targetArticle: "91",    -- 数値形式で統一
  referenceText: "第90条及び第91条" -- 元のテキストは保持
}
```

## 利点

### 1. データ一貫性
- 全システムで統一された条文番号形式
- 検索・ソート処理の信頼性向上
- データ重複の防止

### 2. 保守性向上
- 単一の正規化ロジック
- テスト可能な変換処理
- 明確な責任分離

### 3. 拡張性
- 新しい形式への対応が容易
- 多言語対応の基盤
- 将来的な要件変更に柔軟

### 4. パフォーマンス
- 数値形式による高速ソート
- インデックスの効率的利用
- キャッシュ効率の向上

## 移行戦略

### Phase 1（完了）✅
- 正規化ユーティリティの実装
- テストケースの作成
- 既存データの正規化

### Phase 2（進行中）🔄
- 新規データ投入時の自動正規化
- UIコンポーネントの表示形式統一
- APIレスポンスの形式統一

### Phase 3（計画）📋
- レガシーコードの完全移行
- パフォーマンス最適化
- 監視・アラート設定

## まとめ

条文番号のデータ処理統一を成功裏に実装しました：

1. **統一形式の確立**: 数値形式（DB）と表示形式（UI）の明確な分離
2. **正規化ツール**: 再利用可能なユーティリティ関数群
3. **データ移行**: 62件のNeo4jノードを正規化
4. **テスト**: 15個のテストケースで品質保証
5. **ドキュメント**: 完全な実装ガイドと移行手順

これにより、条文番号の不整合問題が根本的に解決され、システムの信頼性と保守性が大幅に向上しました。