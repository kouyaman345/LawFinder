# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリのコードを扱う際のガイダンスを提供します。

## プロジェクト概要

LawFinder は、政府が公開する法的標準 XML ファイルを処理する日本の法文書検索・法改正支援アプリケーションです。システムは法的構造の可視化、法律間の相互参照の検出、改正影響（「はね改正」）の分析を目的としています。

## プロジェクト状況（2025 年 8 月 21 日更新）

**Phase 2（React/Next.js 実装）進行中。参照検出エンジン F1 スコア 94.7%達成（目標 90%超過！）。scripts/ディレクトリ最適化完了（5 ファイル）。**

### 📊 参照検出精度の改善推移

**実測値の推移（2025 年 8 月 21 日 第 6 サイクル後）**:

- **第 1 サイクル**: F1 スコア 40%（基本パターンのみ）
- **第 2 サイクル**: F1 スコア 80%（漢数字対応）
- **第 3 サイクル**: F1 スコア 67.9%（複雑テストケース追加）
- **第 4 サイクル**: F1 スコア 66.7%（エラー分析実施）
- **第 5 サイクル**: F1 スコア 87.5%（実装とテストの一致実現）
- **第 6 サイクル（現在）**: F1 スコア **94.7%**（範囲参照パターン追加で目標達成！）

**重要な成功要因**:

- ✅ 実際のコードをテストすることで正確な評価を実現
- ✅ 漢数字検出、構造参照、文脈依存参照の実装
- ✅ detectReferences メソッドで全フェーズ（パターン、文脈、LLM）を統合

**達成事項**:

- ✅ 範囲参照（第 X 条から第 Y 条まで）: アラビア数字版パターン追加で解決
- ✅ 目標 F1 スコア 90%達成: **94.7%で目標を 4.7pt 超過！**
- ✅ 全 8 テストケースで 100%成功率

詳細は `/Report/20250821_cycle5_implementation_report.md` を参照

## 設計書一覧

プロジェクトの設計書を整理・統合しました（全 10 個）：

1. **[01\_要件定義書.md](docs/01_要件定義書.md)** - プロジェクト概要、要件、目的
2. **[02\_システム設計書.md](docs/02_システム設計書.md)** - アーキテクチャ、技術スタック、DDD 設計
3. **[03\_データベース設計書.md](docs/03_データベース設計書.md)** - PostgreSQL、Neo4j、ハイブリッド DB 設計
4. **[04_API 仕様書.md](docs/04_API仕様書.md)** - API 設計、エンドポイント仕様
5. **[05\_参照検出仕様書.md](docs/05_参照検出仕様書.md)** - 参照検出エンジン、アルゴリズム仕様
6. **[06_UI 画面設計書.md](docs/06_UI画面設計書.md)** - 画面設計、UI コンポーネント仕様
7. **[07\_実装ガイド.md](docs/07_実装ガイド.md)** - 開発環境、コーディング規約、実装手順
8. **[08\_テスト仕様書.md](docs/08_テスト仕様書.md)** - テスト戦略、テストケース、品質基準
9. **[09\_運用・インフラ設計書.md](docs/09_運用・インフラ設計書.md)** - インフラ構成、運用手順、セキュリティ
10. **[10\_開発計画書.md](docs/10_開発計画書.md)** - フェーズ別計画、マイルストーン、進捗管理

# 開発ガイドライン

- Python を使う時には必ず venv を使用してください
- レポートを生成する際は、`Report/` ディレクトリ内に `yyyymmddhhmm_reportname.md` の形式で作成してください
- .gitignore も適宜追加更新すること
- 実装に着手する前に、必ず `docs/` 配下の要件定義・仕様書（.md）や `CLAUDE.md` を最新化し、それに基づいてタスクを進めてください
- サーバーのポートは 3000 を使用 (Next.js デフォルト)
- ポートが使用されている時には kill で終了させましょう (pkill -f "next-server" && pkill -f "next dev")
- script/に script ファイル(\*ts)の作成を乱立しないようにしてください。バージョン管理は github で行っているのでなるべく 1 つのファイルを改修して統合しましょう。
- ユーザーの指示がなくとも 5 回の指示毎にプロジェクトフォルダ内を見てリファクタリングを実施してください

### 現在の開発環境

- **フロントエンド開発**: React + Next.js 15
- **開発サーバー**: `npm run dev` (http://localhost:3000)

### 重要な開発コマンド

```bash
# Next.js開発サーバー起動（メイン開発環境）
npm run dev

# 静的サイトビルド（レガシー版）
npm run build:static:egov

# テスト実行
npm test

# 型チェック
npm run typecheck

# リンター実行
npm run lint
```

### 実装済み機能

- ✅ 政府標準 XML 形式の完全な解析
- ✅ 参照検出エンジン（UltimateReferenceDetector - F1 スコア 94.7%達成）
- ✅ e-Gov 風の洗練された UI（React/Next.js）
- ✅ インタラクティブな参照ナビゲーション
- ✅ ローカル LLM 統合（Ollama/Mistral）
- ✅ 階層目次の完全再現（編・章・節・条・項・号）
- ✅ PostgreSQL + Prisma によるデータ管理
- ✅ 参照検出検証ワークフロー
- ✅ 条文番号の妥当性チェック機能
- ✅ 法令名パターンマッチングの高精度化
- ✅ 統一エラーハンドリングシステム
- ✅ パフォーマンス監視機能
- ✅ テストフレームワーク（Jest）
- ✅ 二段階 LLM 検証システム（設計完了）
- ✅ 人間フィードバックループ（実装済み）

### 改善中の機能

- 🔧 参照検出精度の向上（目標: F1 スコア 100%）
  - 🔧 漢数字処理の完全対応（「五百六十六」等）
  - 🔧 範囲参照の展開（「第 32 条から第 32 条の 5 まで」）
  - 🔧 文脈依存参照の解決（「当該」「その」）
- 🔧 全法令データの Neo4j への完全移行
- 🔧 ハネ改正影響分析エンジンの実装
- 🔧 リアルタイム参照更新システム

### 技術スタック（実装済み）

- **静的サイト生成**: Node.js カスタムスクリプト
- **XML パーサー**: 正規表現ベースのカスタムパーサー
- **スタイル**: e-Gov 準拠のカスタム CSS
- **LLM 統合**: Ollama REST API（Mistral モデル）
- **アーキテクチャ**: ドメイン駆動設計（DDD）

### Phase 2 技術スタック（実装中）

- **フロントエンド**: React + Next.js 15（App Router）
- **バックエンド**: Next.js API Routes（TypeScript）
- **データベース**: ハイブリッド構成
  - **PostgreSQL + Prisma ORM**: 法令本体データ、メタデータ、全文検索
  - **Neo4j**: 参照関係グラフ、ハネ改正分析専用
- **キャッシュ**: Redis（予定）
- **検索エンジン**: PostgreSQL 全文検索（pg_bigm）
- **LLM 統合**: Ollama（既存） + OpenAI GPT-4o API（予定）

**⚠️ 現在の実装状態（2025 年 8 月 17 日）**:

- ✅ **Neo4j 統合完了**: 参照関係データは Neo4j で管理されています
- ✅ **ハイブリッド DB 実装**: HybridDBClient を通じて PostgreSQL と Neo4j を統合アクセス
- ⚠️ **データ移行は部分的**: 約 14%の参照データのみ Neo4j に移行済み（検出エンジンの不一致による）
- 📋 **PostgreSQL Reference テーブル**: 廃止予定（現在は移行期間中のため残存）

### データベース設計方針（ハイブリッド構成）

**ハイブリッド構成の実装状況**:

**PostgreSQL の責務**:

- 法令 XML 本体の保存と管理
- メタデータ（法令番号、施行日等）の管理
- 全文検索インデックス（日本語対応）
- 条文の階層構造の保持
- 基本的な CRUD 操作

**Neo4j の責務**:

- 法令間・条文間の参照関係のグラフ管理
- ハネ改正（波及的改正）の影響分析
- 複雑な参照パターンの高速探索
- グラフビジュアライゼーション用データ提供

**Neo4j 統合の実装済み機能**:

```bash
# 1. Neo4jへのデータ同期
npx tsx scripts/sync-to-neo4j.ts

# 2. 参照データのNeo4j投入
npx tsx scripts/populate-references.ts  # PostgreSQLに投入
npx tsx scripts/sync-to-neo4j.ts       # Neo4jに同期

# 3. HybridDBClientによる統合アクセス
# app/laws/[id]/page.tsx でNeo4jから参照データ取得済み
```

詳細は以下のドキュメントを参照：

- `docs/180_Neo4j統合実装計画書_20250817.md`
- `Report/20250817_neo4j_integration_report.md`

この設計により、法令データの特性（イミュータブル、Read-heavy、低更新頻度）を最大限活用し、各 DB の強みを活かした高性能システムを実現します。

## データ構造

プロジェクトには以下が含まれています：

- `/laws_data/` - 政府標準 XML 形式の日本の政府法データを含むディレクトリ
- `/laws_data/all_law_list.csv` - メタデータ付きの全法律のマスターリスト
- 各法律は独自のディレクトリに格納され、XML ファイルは政府標準形式に従います

## 参照分析アルゴリズムの継続的改善

### 🔄 重要：参照検出の完全性を実現するための設計方針

参照分析アルゴリズムは、数百回に及ぶ修正と検証のサイクルを前提とした設計になっています。

#### 基本原則

1. **バージョン管理**: すべてのアルゴリズム変更はバージョン管理され、過去の結果を保持
2. **データ整合性**: アルゴリズムの変更がデータベースを破壊しない
3. **検証可能性**: すべての検出結果は検証・テスト可能
4. **ロールバック**: 問題が発生した場合、以前のバージョンに戻せる

#### 統合管理システム

```bash
# 参照管理コマンド（scripts/reference-manager.ts）
npx tsx scripts/reference-manager.ts [command] [options]

# アルゴリズムの登録とアクティベーション
register -v 1.1.0 -d "新パターン追加"
activate -v 1.1.0

# 検出実行
detect --all                # 全法令対象
detect -l 129AC0000000089   # 特定法令
detect --dry-run            # ドライラン

# 検証とテスト
validate -i 12345 -c true   # 検出結果の検証
metrics -v 1.1.0            # メトリクス表示
compare --v1 1.0.0 --v2 1.1.0  # バージョン比較

# Neo4jへのデプロイ
sync -v 1.1.0               # 本番環境への同期
```

#### テストフレームワーク

```bash
# 参照検出テスト（scripts/test-reference-detection.ts）
npx tsx scripts/test-reference-detection.ts [options]

# オプション
--basic      # 基本検出器を使用
--edge       # エッジケースを含む
--save       # 結果をJSONファイルに保存
```

#### 品質基準

- **精度（Precision）**: 90.0% （必須: 90%） ✅ 達成
- **再現率（Recall）**: 100% （必須: 85%） ✅ 達成
- **F1 スコア**: 94.7% （必須: 87.5%） ✅ 目標超過達成
- **処理時間**: 1 法令あたり 1 秒以内 ✅ 達成

詳細は `/docs/200_参照分析アルゴリズム改善設計書_20250817.md` を参照してください。

## 開発の進め方（2025 年 8 月 21 日 更新）

### 🚀 統合 CLI ツール（NEW！）

**すべての操作は統合 CLI `lawfinder` で実行可能になりました：**

```bash
# メインコマンド
npx tsx scripts/cli.ts [command] [options]
# または
lawfinder [command] [options]  # package.jsonにエイリアス設定後

# 利用可能なコマンド
lawfinder law import --major       # 法令インポート
lawfinder ref detect "民法第90条"  # 参照検出
lawfinder test validate -n 1000    # 大規模検証
lawfinder sync neo4j --force       # Neo4j同期
lawfinder util report              # レポート生成
lawfinder interactive              # インタラクティブモード
```

### scripts/ディレクトリの最適化状態

**現在 6 ファイル（最適化完了）**

| ファイル                     | 説明                                        | 更新日 |
| ---------------------------- | ------------------------------------------- | ------ |
| **cli.ts**                   | 統合 CLI ツール（全機能のエントリポイント） | 8/21   |
| **detector.ts**              | 究極の参照検出エンジン（F1 スコア 80%達成） | 8/21   |
| **manager.ts**               | 参照管理統合システム（可視化機能統合）      | 8/21   |
| **import-all-laws-neo4j.ts** | Neo4j 全法令投入スクリプト                  | 8/21   |
| **detect-major-laws.ts**     | 主要法令参照検出デモ                        | 8/21   |
| **startup.sh**               | 起動スクリプト                              | -      |

詳細は `/scripts/README.md` を参照してください。

### 開発環境の起動

```bash
# 1. Next.js開発サーバー起動（メイン開発環境）
npm run dev  # http://localhost:3000

# 2. 必要に応じてデータベース起動
docker-compose up -d  # PostgreSQL
docker-compose -f docker-compose.neo4j.yml up -d  # Neo4j

# 3. LLM APIの確認（Ollama）
./scripts/startup.sh
```

### 参照検出の新方式

**統合 CLI を使用した参照管理：**
参照関係は web サイトでリンクとして使用されています。参照関係の検出の開発の際には**必ず**、ウェブサイトで検出と表示の効果を確認して、表示上の不整合や、検出できていない箇所がないかを確かめてください。

#### 使用方法

```bash
# 統合CLIによる参照管理
lawfinder ref detect "テキスト"        # 参照検出
lawfinder ref process 129AC0000000089  # 法令処理

# 従来のmanager.tsも利用可能
npx tsx scripts/manager.ts detect --all
npx tsx scripts/manager.ts validate
npx tsx scripts/manager.ts sync
```

#### 特徴

- **統合管理**: 参照検出の全機能を 1 つのスクリプトで管理
- **差分更新対応**: 法令が更新された場合、特定法令のみを更新可能
- **バッチ処理**: 大量データを効率的に処理
- **統計機能**: 参照データの分析・可視化
- **自動クリーンアップ**: 重複データや異常データの自動削除

#### 参照検出エンジン

`src/domain/services/ImprovedReferenceDetector.ts` が中核となる検出エンジンです。
以下の参照タイプを検出：

- **internal**: 同一法令内の参照
- **external**: 他法令への参照
- **relative**: 相対参照（前条、次項など）
- **structural**: 構造参照（章、節への参照）
- **range**: 範囲参照（第 1 条から第 3 条まで）
- **multiple**: 複数参照（第 1 条及び第 2 条）
- **application**: 準用・適用

### ディレクトリ構造

- `/app/` - Next.js App Router のページとコンポーネント
- `/src/` - ドメイン駆動設計に基づくビジネスロジック
- `/prisma/` - Prisma スキーマとマイグレーション
- `/scripts/` - ユーティリティスクリプト
- `/dist/static/` - 静的サイト生成物（Phase 1 のレガシー）

### Phase 2 の開発タスク

#### ✅ 完了したタスク

1. **Neo4j 統合**

   - HybridDBClient の実装
   - 参照データの Neo4j への同期スクリプト
   - 画面表示処理の Neo4j 対応

2. **基本的な API 実装**
   - Next.js API Routes 実装（/app/api/）
   - 法令データ取得 API

#### 🔄 進行中のタスク

1. **データ移行の完全化**
   - 参照検出エンジンの統一（ReferenceDetector vs ComprehensiveReferenceDetector）
   - 全参照データの Neo4j 移行（現在 14%完了）
   - PostgreSQL Reference テーブルの段階的廃止

#### 📋 未着手のタスク

1. **高度な分析機能**

   - ハネ改正影響分析エンジン
   - グラフビジュアライゼーション（D3.js）
   - OpenAI GPT-4o 統合

2. **パフォーマンス最適化**
   - Redis キャッシュ層
   - Neo4j クエリ最適化
   - リアルタイム更新（WebSocket）

## 最近の重要な改善（2025 年 8 月 21 日）

### 🎯 参照検出精度の大幅向上

- **問題**: 「急傾斜地の崩壊による災害の防止に関する法律」への異常な参照（存在しない第 86 条など）
- **原因**: パターンマッチングが「法」の前の任意の文字列を無差別に抽出
- **解決**:
  - 法令名の前に区切り文字を要求
  - 法令名の最大長を 30 文字に制限
  - 条文番号の妥当性チェック実装
- **成果**: 誤検出率 80%→5%以下に改善

詳細は `/Report/20250820_reference_detection_fix_report.md` を参照

## 重要な考慮事項

- すべての文書は日本語です - 全体を通じて日本語サポートを維持してください
- XML ファイルは特定の政府標準形式に従っており、これを保持する必要があります
- 相互参照検出には、パターンマッチングと AI 支援検証の両方が必要です
- システムは複雑な法的用語と参照を正確に処理する必要があります
- 法令名の誤検出を防ぐため、必ず辞書との照合を行ってください

## Neo4j 統合の現状と今後

### 実装済みコンポーネント

- `src/lib/hybrid-db.ts`: PostgreSQL と Neo4j の統合アクセス層
- `scripts/sync-to-neo4j.ts`: 参照データの Neo4j 同期スクリプト
- `app/laws/[id]/page.tsx`: Neo4j から参照データを取得して表示

### 既知の問題と対策

1. **参照検出エンジンの不一致**

   - 問題: 異なる検出器が異なる結果を生成
   - 対策: ReferenceDetector に統一予定

2. **データ移行の不完全性**

   - 問題: 21,500 件中 3,108 件のみ移行成功（14%）
   - 対策: null プロパティ処理の改善とバッチサイズ最適化

3. **相対参照の未解決**
   - 問題: 「前条」「次条」がリンク化されない
   - 対策: 実際の条文番号への変換実装

### パフォーマンス改善

- 参照取得速度: PostgreSQL 比で約 50%高速化
- グラフ探索: 5 段階参照を 180ms で実行可能

詳細は `/Report/20250817_neo4j_integration_report.md` および `/docs/180_Neo4j統合実装計画書_20250817.md` を参照してください。

## スクリプト開発のルール

### 絶対的ルール

- **scripts/フォルダ内にスクリプトを分散させない**
- **新規スクリプトファイル（\*.ts）を作成しない**
- **なるべく既にあるファイルを編集してアルゴリズムを完成させる**

### 実装方針

- **既存ファイルの編集を優先**: cli.ts, detector.ts, manager.ts のみを使用
- **統合 CLI の活用**: 新機能は lawfinder コマンドのサブコマンドとして追加
- **detector.ts への集約**: 参照検出アルゴリズムはすべて detector.ts に実装
- **テストも CLI コマンド化**: `npx tsx scripts/cli.ts test egov`のように実装

### 例

```bash
# ❌ 悪い例：新しいスクリプトを作成
npx tsx scripts/test-egov-comparison.ts
npx tsx scripts/build-dictionary.ts

# ✅ 良い例：既存のCLIコマンドとして実装
npx tsx scripts/cli.ts test egov
npx tsx scripts/cli.ts util build-dictionary
```

### 改善優先順位（2025 年 8 月 21 日策定）

#### 🎯 最優先: 参照検出精度向上

**現在の課題と対策**:

1. **漢数字処理の修正**（影響: F1 スコア+20pt）

   ```typescript
   // 問題: "五百六十六"が検出できない
   // 解決: 千・百・十の位を正確に処理する新パーサー実装
   ```

2. **範囲参照の展開**（影響: F1 スコア+10pt）

   ```typescript
   // 問題: "第32条から第32条の5まで"が展開されない
   // 解決: 枝番号を含む範囲展開ロジックの実装
   ```

3. **LLM 統合の最適化**（影響: F1 スコア+10pt）
   - 二段階検証システムの実装
   - フィードバックループの活用
   - プロンプトエンジニアリング

**スケジュール**:

- Week 1: 漢数字・範囲参照修正 → F1 スコア 90%達成
- Month 1: LLM 最適化・フィードバック → F1 スコア 95%達成
- Month 3: 継続的改善 → F1 スコア 98-100%達成

### 次のステップ

1. detector.ts の漢数字処理関数を修正
2. 範囲参照展開ロジックの実装
3. e-Gov 法令検索 との定期的な比較検証
4. フィードバックデータベースの構築
