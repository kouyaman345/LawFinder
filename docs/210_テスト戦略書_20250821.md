# テスト戦略書

作成日: 2025年8月21日

## 1. 概要

本書は、LawFinderプロジェクトのテスト戦略を定義します。品質保証と継続的な改善を目的として、包括的なテスト体系を構築します。

## 2. テスト方針

### 2.1 基本方針

- **テスト駆動開発（TDD）**: 新機能開発時はテストファーストで実装
- **継続的テスト**: CIパイプラインでの自動テスト実行
- **カバレッジ目標**: 
  - 初期目標: 40%（達成済み）
  - 中期目標: 60%（2025年9月）
  - 最終目標: 80%（2025年12月）

### 2.2 テストピラミッド

```
         /\
        /  \  E2Eテスト (5%)
       /----\
      /      \  統合テスト (25%)
     /--------\
    /          \  ユニットテスト (70%)
   /____________\
```

## 3. テスト種別

### 3.1 ユニットテスト

**対象**:
- 参照検出エンジン（detector.ts）
- ユーティリティ関数
- ドメインロジック

**ツール**: Jest, ts-jest

**実装例**: `/tests/detector.test.ts`

```typescript
describe('UltimateReferenceDetector', () => {
  it('外部法令への参照を検出できる', async () => {
    const text = '民法第90条の規定により無効とする。';
    const refs = await detector.detectReferences(text);
    
    expect(refs).toHaveLength(1);
    expect(refs[0].type).toBe('external');
  });
});
```

### 3.2 統合テスト

**対象**:
- データベース操作
- Neo4j連携
- API エンドポイント

**ツール**: Jest, Supertest（API用）

**計画中のテスト**:
```typescript
describe('Neo4j Integration', () => {
  it('法令ノードを正しく作成できる', async () => {
    // Neo4jへの法令投入テスト
  });
});
```

### 3.3 E2Eテスト

**対象**:
- ユーザーシナリオ
- 画面遷移
- フルスタック機能

**ツール**: Playwright（予定）

### 3.4 パフォーマンステスト

**対象**:
- 参照検出速度
- メモリ使用量
- 大規模データ処理

**実装済み**: `performance-monitor.ts`

## 4. テストファイル構成

```
LawFinder/
├── tests/                    # テストルートディレクトリ
│   ├── unit/                # ユニットテスト
│   │   ├── detector.test.ts
│   │   └── utils/
│   ├── integration/         # 統合テスト
│   │   ├── database/
│   │   └── neo4j/
│   ├── e2e/                 # E2Eテスト
│   └── setup.ts            # テスト環境セットアップ
├── jest.config.js          # Jest設定
└── coverage/               # カバレッジレポート
```

## 5. テスト実行コマンド

```bash
# 全テスト実行
npm test

# ウォッチモード
npm run test:watch

# カバレッジ付き実行
npm run test:coverage

# 特定のテストのみ
npm test -- detector.test.ts

# デバッグモード
node --inspect-brk ./node_modules/.bin/jest --runInBand
```

## 6. CI/CD統合

### GitHub Actions設定（予定）

```yaml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: npm ci
      - run: npm test -- --coverage
      - uses: codecov/codecov-action@v2
```

## 7. モック戦略

### 7.1 データベースモック

```typescript
jest.mock('@prisma/client', () => ({
  PrismaClient: jest.fn(() => mockPrismaClient)
}));
```

### 7.2 外部APIモック

```typescript
jest.mock('neo4j-driver', () => ({
  driver: jest.fn(() => mockDriver)
}));
```

### 7.3 ファイルシステムモック

```typescript
jest.mock('fs', () => ({
  readFileSync: jest.fn(),
  writeFileSync: jest.fn()
}));
```

## 8. テストデータ管理

### 8.1 フィクスチャ

```typescript
// tests/fixtures/laws.ts
export const sampleLaws = {
  civil: {
    id: '129AC0000000089',
    name: '民法',
    articles: [...]
  }
};
```

### 8.2 ファクトリー

```typescript
// tests/factories/reference.factory.ts
export function createReference(overrides = {}) {
  return {
    type: 'external',
    targetLaw: '民法',
    confidence: 0.9,
    ...overrides
  };
}
```

## 9. 品質メトリクス

### 9.1 カバレッジ基準

| メトリクス | 現在 | 目標 |
|-----------|------|------|
| ライン | 40% | 60% |
| ブランチ | 35% | 55% |
| 関数 | 45% | 65% |
| ステートメント | 40% | 60% |

### 9.2 品質指標

- **テスト成功率**: 95%以上
- **テスト実行時間**: 3分以内
- **フレーキーテスト**: 0件

## 10. テストのベストプラクティス

### 10.1 命名規則

```typescript
// Good
it('should detect external law references with law number')

// Bad
it('test1')
```

### 10.2 AAA パターン

```typescript
it('should calculate correctly', () => {
  // Arrange
  const input = 'test data';
  
  // Act
  const result = processData(input);
  
  // Assert
  expect(result).toBe(expected);
});
```

### 10.3 独立性

- 各テストは独立して実行可能
- テスト間の依存関係を排除
- グローバル状態の変更を避ける

## 11. トラブルシューティング

### 11.1 よくある問題

**問題**: `Cannot find module`
**解決**: `tsconfig.json`のパス設定を確認

**問題**: メモリリーク
**解決**: `--detectLeaks`フラグを使用

**問題**: タイムアウト
**解決**: `jest.setTimeout(10000)`で延長

### 11.2 デバッグ手法

```bash
# Verbose出力
npm test -- --verbose

# 特定のテストのみ実行
npm test -- --testNamePattern="detect"

# デバッガー接続
node --inspect-brk node_modules/.bin/jest
```

## 12. 今後の計画

### Phase 1（2025年8月）✅
- Jestセットアップ
- 基本的なユニットテスト作成
- モック戦略の確立

### Phase 2（2025年9月）
- 統合テストの拡充
- CI/CD統合
- カバレッジ60%達成

### Phase 3（2025年10月）
- E2Eテスト導入
- パフォーマンステスト自動化
- カバレッジ80%達成

## 13. 参考資料

- [Jest公式ドキュメント](https://jestjs.io/)
- [Testing Library](https://testing-library.com/)
- [テストピラミッド](https://martinfowler.com/bliki/TestPyramid.html)

---

*文書作成: LawFinder開発チーム*