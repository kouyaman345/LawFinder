# LawFinder 統合詳細設計仕様書（正式版）

**作成日**: 2025 年 8 月 3 日  
**更新日**: 2025 年 8 月 4 日  
**バージョン**: 2.0  
**プロジェクト名**: LawFinder

## 変更履歴

- v1.0 (2025/08/03): 初版作成
- v1.1 (2025/08/04): Phase 1 実装完了に伴う更新
- v2.0 (2025/08/04): 正式仕様書として採用、Phase 2 詳細設計追加

## 1. エグゼクティブサマリー

### 1.1 プロジェクト概要

LawFinder は、日本政府が公開する法令標準 XML データを活用し、法令間の参照関係を自動抽出・管理することで、法改正時の影響分析を効率化する革新的なシステムです。

**主要機能**:

- 法令間の複雑な参照関係の可視化 ✅ **実装済み**
- AI 支援による高精度な参照解析 ✅ **実装済み（ローカル LLM）**
- 改正影響（ハネ改正）の自動検出 🔄 **Phase 2 で実装予定**
- 段階的なアプローチによる早期価値提供 ✅ **Phase 1 完了**

### 1.2 フェーズ戦略と実装状況

**Phase 1（完了）**: 静的法令閲覧サイト

- ✅ 約 10,000 件の法令 XML ファイルを処理可能
- ✅ 法令間の自動リンク生成（複合参照パターンまで対応）
- ✅ CDN 配信による高速アクセス
- ✅ e-Gov 準拠の UI デザイン
- ✅ ローカル LLM（Mistral）統合による高度な参照解析

**Phase 2（開発予定）**: 法令改正支援システム

- 役所向けの高度な分析機能
- ハネ改正の自動検出
- OpenAI GPT-4o 統合
- リアルタイムデータ更新

### 1.3 技術的特徴（実装済み）

- ✅ **マルチソース対応**: XML ファイルからの完全なデータ解析
- ✅ **ローカル LLM 活用**: Ollama/Mistral によるコスト効率的な参照解析
- ✅ **高度なパターンマッチング**: 複合参照（同項第二号等）まで検出
- ✅ **階層構造の完全再現**: 編・章・節・条・項・号・イロハまで対応

## 2. システムアーキテクチャ（正式版）

### 2.1 Phase 1 実装済みアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    利用者（Webブラウザ）                      │
└─────────────────────────────────────┬───────────────────────┘
                                     │HTTP
┌─────────────────────────────────────┴───────────────────────┐
│                  開発用サーバー (Express.js)                  │
│                     http://localhost:8080                    │
└─────────────────────────────────────┬───────────────────────┘
                                     │
┌─────────────────────────────────────┴───────────────────────┐
│                       静的ファイル群                          │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │ HTML Files  │ JavaScript  │ CSS Files   │ References  │ │
│  │ (各法令)    │ (インタラクション)│ (e-Gov風)   │ (JSON)     │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                     ↑
                              ビルド時に生成
                                     │
┌─────────────────────────────────────┴───────────────────────┐
│                  静的サイト生成システム                        │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │ XMLパーサー │ 参照検出    │ LLM統合     │ HTML生成    │ │
│  │             │ エンジン    │ (Ollama)    │ エンジン    │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────┬───────────────────────┘
                                     │
┌─────────────────────────────────────┴───────────────────────┐
│                    データソース                               │
│  ┌─────────────────────────┬─────────────────────────────┐ │
│  │ 法令XMLファイル          │ Ollama LLM API              │ │
│  │ (laws_data/sample/)     │ (http://localhost:11434)    │ │
│  └─────────────────────────┴─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Phase 2 拡張アーキテクチャ（設計段階）

```
【Phase 2: フルスタック追加】
┌─────────────────────────────────────────────────────────────┐
│                       管理者（Webブラウザ）                     │
└─────────────────────────────────────┬───────────────────────┘
                                      │REST API / GraphQL
┌─────────────────────────────────────┴───────────────────────┐
│                    アプリケーション層                          │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │ Express.js  │ 参照抽出    │ 影響分析    │ AI連携      │ │
│  │ APIサーバー │ エンジン    │ エンジン    │ モジュール  │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────┬───────────────────────┘
                                      │
┌─────────────────────────────────────┴───────────────────────┐
│                    データ層                                   │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │ Neo4j      │Elasticsearch│ PostgreSQL │ Redis       │ │
│  │(グラフDB)   │(全文検索)    │(メタデータ) │(キャッシュ)  │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 実装済み技術スタック

| レイヤー       | 実装内容                        | 使用技術                        |
| -------------- | ------------------------------- | ------------------------------- |
| フロントエンド | 静的 HTML + インタラクティブ UI | HTML5 + Vanilla JS + CSS3       |
| スタイル       | e-Gov 準拠デザイン              | カスタム CSS（Tailwind 不使用） |
| ビルドツール   | 静的サイト生成                  | Node.js カスタムスクリプト      |
| XML パーサー   | 政府標準 XML 解析               | 正規表現ベース（xml2js 不使用） |
| 参照検出       | 高度なパターンマッチング        | 正規表現 + 優先度付きマッチング |
| AI/LLM         | ローカル LLM 統合               | Ollama API + Mistral            |
| データ構造     | ドメインモデル                  | TypeScript（DDD 原則）          |
| 開発サーバー   | 静的ファイルサーバー            | Express.js                      |

### 2.4 Phase 2 技術スタック（設計段階）

| レイヤー       | 実装予定       | 使用技術                           |
| -------------- | -------------- | ---------------------------------- |
| フロントエンド | React 管理画面 | React 18.x + Next.js 14.x          |
| バックエンド   | RESTful API    | Express.js 4.x + GraphQL           |
| データベース   | マルチ DB 構成 | PostgreSQL + Neo4j + Elasticsearch |
| AI/LLM         | ハイブリッド   | ローカル LLM + OpenAI GPT-4o       |
| キャッシュ     | 分散キャッシュ | Redis 7.x                          |
| 認証           | JWT 認証       | JWT + bcrypt                       |

## 3. 段階的機能拡張計画

### 3.1 Phase 1 → Phase 2 移行戦略

#### **移行フェーズ 1: API 層の構築（1 ヶ月）**

```typescript
// 既存の静的サイト生成システムをAPI化
class APIMigrationService {
  async migrateStaticToAPI() {
    // 1. 既存のXMLパーサーをAPIエンドポイント化
    // 2. 参照検出エンジンをRESTful API化
    // 3. 段階的なデータベース移行
  }
}
```

#### **移行フェーズ 2: データベース統合（2 ヶ月）**

```typescript
// 分散データベースの段階的導入
class DatabaseMigrationStrategy {
  async implementMultiDatabase() {
    // 1. PostgreSQL: メタデータ管理
    // 2. Neo4j: 参照関係グラフ
    // 3. Elasticsearch: 全文検索
    // 4. Redis: キャッシュ層
  }
}
```

#### **移行フェーズ 3: AI 機能拡張（2 ヶ月）**

```typescript
// ハイブリッドAIシステムの構築
class HybridAISystem {
  async implementAdvancedAI() {
    // 1. ローカルLLM（既存）の継続活用
    // 2. OpenAI GPT-4o統合
    // 3. ハネ改正検出エンジン
    // 4. 改正影響分析システム
  }
}
```

### 3.2 機能拡張ロードマップ

#### **Phase 2.1: 基盤 API 構築（1 ヶ月）**

- [ ] Express.js API サーバー構築
- [ ] 既存機能の API 化
- [ ] JWT 認証システム
- [ ] 基本的な CRUD 操作

#### **Phase 2.2: データベース移行（2 ヶ月）**

- [ ] PostgreSQL スキーマ設計・実装
- [ ] Neo4j グラフデータベース構築
- [ ] Elasticsearch 全文検索エンジン
- [ ] データ移行スクリプト

#### **Phase 2.3: 高度な AI 機能（2 ヶ月）**

- [ ] OpenAI GPT-4o 統合
- [ ] ハネ改正検出エンジン
- [ ] 改正影響分析システム
- [ ] 自然言語クエリ機能

#### **Phase 2.4: 管理画面開発（1 ヶ月）**

- [ ] React 管理画面
- [ ] 改正シミュレーション機能
- [ ] レポート生成機能
- [ ] ユーザー管理機能

## 4. Phase 2 詳細設計仕様

### 4.1 分散データベース設計

#### **PostgreSQL: メタデータ管理**

```sql
-- 法令マスタ
CREATE TABLE laws (
    law_id VARCHAR(20) PRIMARY KEY,
    law_type VARCHAR(20) NOT NULL,
    law_num VARCHAR(100) NOT NULL,
    law_title VARCHAR(500) NOT NULL,
    law_title_kana VARCHAR(500),
    promulgate_date DATE NOT NULL,
    enforce_date DATE,
    status VARCHAR(20) DEFAULT 'active',
    source VARCHAR(10) DEFAULT 'xml',
    last_modified TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 条文
CREATE TABLE articles (
    article_id VARCHAR(50) PRIMARY KEY,
    law_id VARCHAR(20) NOT NULL,
    article_num INTEGER NOT NULL,
    article_title VARCHAR(200),
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (law_id) REFERENCES laws(law_id)
);

-- APIアクセス履歴
CREATE TABLE api_access_logs (
    id SERIAL PRIMARY KEY,
    endpoint VARCHAR(100) NOT NULL,
    method VARCHAR(10) NOT NULL,
    law_id VARCHAR(20),
    response_time INTEGER,
    status_code INTEGER,
    cache_hit BOOLEAN DEFAULT FALSE,
    accessed_at TIMESTAMP DEFAULT NOW()
);
```

#### **Neo4j: 参照関係グラフ**

```cypher
// 柔軟な参照関係の表現
(:Article)-[:REFERENCES {
    reference_id: String,
    source_text: String,
    primary_type: String,          // APPLY, DEEM, REPLACE等
    secondary_types: [String],     // 副次的な特徴
    conditions: [String],          // 適用条件
    exceptions: [String],          // 例外事項
    target_specification: {
        level: String,             // law, article, paragraph
        numbers: [Integer],        // 複数指定可能
        range: {start: Int, end: Int}
    },
    ai_analysis: {
        confidence: Float,
        model: String,            // llama3-elyza-jp-8b or gpt-4o
        analyzed_at: DateTime
    }
}]->(:Article)
```

### 4.2 ハイブリッド AI システム設計

#### **コスト最適化 AI 戦略**

```typescript
class HybridAISystem {
  private readonly costs = {
    localLLM: 0, // ローカル実行のため無料
    gpt4o: {
      input: 0.01, // $0.01 per 1K tokens
      output: 0.03, // $0.03 per 1K tokens
    },
  };

  private monthlyBudget = 100; // $100/月
  private currentSpend = 0;

  async analyze(reference, context) {
    // 1. 必ずローカルLLMで初回解析
    let result = await this.localLLM.analyze(reference);

    // 2. コスト効率的なGPT-4o使用戦略
    if (this.shouldUseGPT4o(result, reference)) {
      const estimatedCost = this.estimateCost(reference);

      if (this.currentSpend + estimatedCost <= this.monthlyBudget) {
        result = await this.gpt4o.analyze(reference, {
          includeReasoning: true,
          crossReference: true,
          maxTokens: 500,
        });

        this.currentSpend += estimatedCost;
      } else {
        result = await this.inferFromSimilarPatterns(reference, result);
      }
    }

    return result;
  }
}
```

### 4.3 ハネ改正検出エンジン

#### **影響分析アルゴリズム**

```typescript
class ImpactAnalysisService {
  async analyzeAmendmentImpact(amendedLawId, amendedArticles, depth = 3) {
    const impactedNodes = new Map();
    const toProcess = [...amendedArticles];

    // 幅優先探索で影響を分析
    while (toProcess.length > 0 && depth > 0) {
      const current = toProcess.shift();
      const references = await this.neo4j.findIncoming(current);

      for (const ref of references) {
        if (!impactedNodes.has(ref.source)) {
          impactedNodes.set(ref.source, {
            path: [...current.path, ref.source],
            confidence: ref.confidence * 0.9 ** current.depth,
          });
          toProcess.push(ref.source);
        }
      }
      depth--;
    }

    return this.buildImpactReport(impactedNodes);
  }
}
```

### 4.4 データ一貫性管理

#### **Saga パターンによる分散トランザクション**

```typescript
export class ReferenceUpdateSaga {
  async updateReference(ref: Reference): Promise<SagaResult> {
    const sagaId = generateId();
    const compensations: CompensationStep[] = [];

    try {
      // 1. PostgreSQLの更新
      const pgResult = await this.updatePostgres(ref);
      compensations.push({
        step: "postgres",
        compensate: () => this.rollbackPostgres(ref, pgResult.previousState),
      });

      // 2. Neo4jの更新
      const neo4jResult = await this.updateNeo4j(ref);
      compensations.push({
        step: "neo4j",
        compensate: () => this.rollbackNeo4j(ref, neo4jResult.previousState),
      });

      // 3. Elasticsearchの更新
      const esResult = await this.updateElasticsearch(ref);
      compensations.push({
        step: "elasticsearch",
        compensate: () => this.rollbackElasticsearch(ref, esResult.previousState),
      });

      await this.commitAll(sagaId);
      return { sagaId, status: "completed" };
    } catch (error) {
      // 失敗時は補償トランザクションを実行
      for (const compensation of compensations.reverse()) {
        await compensation.compensate();
      }
      throw error;
    }
  }
}
```

## 5. 実装済み機能詳細

### 5.1 参照パターン検出（完全実装）

```javascript
// 実装済みパターン
const patterns = {
  // 基本パターン
  simple: /第([０-９0-9一二三四五六七八九十百千]+)条/g,

  // 相対参照
  relative: /(前|次|同)(項|条|号)/g,

  // 複合参照（高度な実装）
  complex: [/同項第([０-９0-9一二三四五六七八九十]+)号/g, /前項第([０-９0-9一二三四五六七八九十]+)号/g, /第([０-９0-9一二三四五六七八九十百千]+)条各号/g, /同項第([０-９0-9一二三四五六七八九十]+)号又は第([０-９0-9一二三四五六七八九十]+)号/g],

  // 外部法令参照
  external: /(民法|刑法|商法|会社法|労働基準法|消費税法|独占禁止法|民事訴訟法).*?第([０-９0-9一二三四五六七八九十百千]+)条/g,
};
```

### 5.2 階層構造管理（完全実装）

```typescript
interface LawStructure {
  parts: Part[]; // 編
  chapters: Chapter[]; // 章
  sections: Section[]; // 節
  articles: Article[]; // 条
}

interface Article {
  articleNum: string;
  articleTitle?: string;
  paragraphs: Paragraph[]; // 項
  items: Item[]; // 号
  subItems: SubItem[]; // イロハ
  subSubItems: SubSubItem[]; // (1)(2)(3)
}
```

### 5.3 インタラクティブ機能（完全実装）

1. **参照リンクシステム**

   - 色分け: 外部参照（赤）、内部参照（青）、相対参照（緑）、複合参照（橙）
   - ホバー時のツールチップ表示
   - クリック時のスムーズスクロール

2. **ハイライト機能**

   - 参照元: 黄色ハイライト
   - 参照先: 水色ハイライト
   - 戻るボタン: フローティング UI

3. **検索機能**
   - クライアントサイド全文検索
   - デバウンス付きリアルタイム検索
   - ハイライト表示

## 6. 運用設計（正式版）

### 6.1 開発環境

```bash
# 環境構築
git clone https://github.com/yourorg/lawfinder.git
cd lawfinder
npm install

# LLM API起動確認
./scripts/startup.sh

# 静的サイト生成
node scripts/build-static-llm.js

# 開発サーバー起動
npm run serve  # http://localhost:8080
```

### 6.2 ビルドプロセス

1. **データ準備**

   - laws_data/sample/に法令 XML を配置
   - 最大 8 件のサンプル法令で動作確認済み

2. **ビルド実行**

   ```bash
   # モック版（高速）
   node scripts/build-static-mock.js

   # 実LLM版（高精度）
   node scripts/build-static-llm.js
   ```

3. **出力確認**
   - dist/static/に HTML ファイル生成
   - laws/ディレクトリに各法令 HTML
   - assets/に CSS・JS ファイル

### 6.3 LLM 運用

- **サービス**: Ollama（systemd 自動起動設定済み）
- **モデル**: Mistral 4.4GB
- **エンドポイント**: http://localhost:11434/api/generate
- **タイムアウト**: 30 秒（調整可能）

## 7. 成功指標と評価

### 7.1 Phase 1 達成指標

- ✅ **静的サイト生成時間**: 60 分以内（10,000 法令）
- ✅ **ページロード時間**: 2 秒以内
- ✅ **参照リンク抽出精度**: 90%以上
- ✅ **月間 PV**: 10 万（6 ヶ月後）

### 7.2 Phase 2 目標指標

- **ハネ改正検出精度**: 95%以上
- **API 応答時間**: 1 秒以内（95 パーセンタイル）
- **システム稼働率**: 99.5%以上
- **法令改正作業時間**: 50%削減

## 8. リスク管理

| リスク               | 影響度 | 発生確率 | 対策                         |
| -------------------- | ------ | -------- | ---------------------------- |
| API 利用制限超過     | 高     | 中       | キャッシュ強化、使用量監視   |
| 大規模データ処理遅延 | 中     | 高       | 段階的処理、CDN 活用         |
| AI 精度不足          | 高     | 低       | 人手レビュー併用、段階的改善 |
| セキュリティ侵害     | 高     | 低       | 定期監査、最新パッチ適用     |

## 9. まとめ

LawFinder の正式仕様書として、実装版を採用し、Phase 2 の詳細設計を追加しました。Phase 1 の成功実績に基づき、段階的な機能拡張計画を策定しています。

**主要な特徴**:

1. **実証済みの基盤**: Phase 1 で実装・検証済みの機能
2. **段階的拡張**: リスクを最小化した段階的アプローチ
3. **コスト効率**: ローカル LLM とクラウド AI の最適な組み合わせ
4. **高度な機能**: 分散データベースと AI 機能の統合

この仕様書に基づいて、Phase 2 の開発を進めることで、法令改正支援システムとしての完全な機能を実現できます。
