# LawFinder アーキテクチャ変更ガイド

**作成日**: 2025年8月5日  
**バージョン**: 2.0.0  
**ステータス**: Phase 2 移行完了

## 1. アーキテクチャの変更概要

### 1.1 Phase 1からPhase 2への移行

| 項目 | Phase 1 (旧) | Phase 2 (新) |
|------|-------------|-------------|
| アーキテクチャ | 静的サイト生成 | データベース駆動型Webアプリ |
| データ処理 | ビルド時に一括処理 | データベースで永続化 |
| フロントエンド | 静的HTML + Vanilla JS | React 19 + Next.js 15 |
| バックエンド | Node.jsスクリプト | Next.js API Routes |
| データストア | JSONファイル | SQLite/PostgreSQL |
| 検索機能 | クライアントサイド | サーバーサイドDB検索 |

### 1.2 主な変更理由

1. **スケーラビリティ**: 大規模データへの対応
2. **リアルタイム性**: 動的なデータ更新
3. **拡張性**: AI機能やグラフDBの統合準備
4. **保守性**: データとロジックの分離

## 2. 新しいアーキテクチャ詳細

### 2.1 データベース層（Prisma + SQLite/PostgreSQL）

#### スキーマ設計
```prisma
model Law {
  id                String    @id
  title             String
  articles          Article[]
  metadata          Json?
  enactStatements   Json?
  amendmentHistory  Json?
}

model Article {
  id                String    @id @default(uuid())
  lawId             String
  articleNumber     String
  articleTitle      String?
  content           String
  law               Law       @relation(fields: [lawId], references: [id])
  paragraphs        Paragraph[]
  referencesFrom    Reference[]
  referencesTo      Reference[]
}

model Reference {
  id                String    @id @default(uuid())
  fromArticleId     String
  toArticleId       String?
  referenceText     String
  referenceType     String
  confidence        Float?
}
```

#### データインポートフロー
1. XMLファイル読み込み
2. パース処理（Ruby/特殊文字対応）
3. データベースへの保存
4. 参照関係の検出・保存

### 2.2 API層（Next.js API Routes）

#### エンドポイント設計
```typescript
// 法令一覧
GET /api/laws
  ?page=1&limit=20&search=民法

// 法令詳細
GET /api/laws/[id]

// 参照関係
GET /api/references
  ?lawId=xxx&articleId=yyy
```

#### レスポンス形式
```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### 2.3 フロントエンド層（React + Next.js）

#### コンポーネント構成
```
app/
├── layout.tsx          # 共通レイアウト
├── page.tsx           # ホームページ
├── laws/
│   ├── page.tsx       # 法令一覧
│   └── [id]/
│       └── page.tsx   # 法令詳細
└── api/               # API Routes
```

#### 主要な技術選定
- **Next.js 15**: App Router、Server Components
- **React 19**: 最新の並行機能
- **Tailwind CSS**: ユーティリティベースのスタイリング
- **TypeScript**: 型安全性の確保

## 3. データフロー

### 3.1 初期セットアップ
```bash
# 1. データベース準備
npm run db:migrate    # テーブル作成
npm run db:generate   # Prismaクライアント生成

# 2. データインポート
npm run db:import     # XMLからDBへ

# 3. 開発サーバー起動
npm run dev:next
```

### 3.2 リクエストフロー
```
[ブラウザ] → [Next.js Pages] → [API Routes] → [Prisma] → [SQLite/PostgreSQL]
    ↑                                                            ↓
    └──────────────────── JSONレスポンス ←───────────────────────┘
```

## 4. 移行時の考慮事項

### 4.1 既存スクリプトの扱い

| スクリプト | 状態 | 今後の扱い |
|-----------|------|-----------|
| build-static-*.js | 維持 | レガシー機能として保持 |
| import-laws-to-db.ts | 新規 | メインのデータ管理 |
| parse-xml.js | 参照 | 共通パーサーとして活用 |

### 4.2 パフォーマンス最適化

1. **データベースインデックス**
   - law.title
   - law.lawNumber
   - article.lawId
   - reference.fromArticleId

2. **クエリ最適化**
   - 必要なフィールドのみ選択
   - 関連データの効率的な取得
   - ページネーション実装

3. **キャッシング戦略**（将来実装）
   - Redis導入
   - CDNキャッシュ
   - React Query/SWR

## 5. 将来の拡張計画

### 5.1 短期（3ヶ月）
- PostgreSQL本番環境構築
- Elasticsearch統合
- ユーザー認証機能

### 5.2 中期（6ヶ月）
- Neo4j参照グラフ
- OpenAI GPT-4o統合
- リアルタイム更新

### 5.3 長期（1年）
- マイクロサービス化
- Kubernetes展開
- 機械学習モデル統合

## 6. トラブルシューティング

### 6.1 よくある問題

**Q: Next.js 15でparamsエラーが出る**
```typescript
// 誤
{ params }: { params: { id: string } }

// 正
{ params }: { params: Promise<{ id: string }> }
const { id } = await params;
```

**Q: autoprefixerエラー**
```bash
npm install --save-dev autoprefixer
```

**Q: Prismaクライアントが見つからない**
```bash
npm run db:generate
```

### 6.2 デバッグコマンド

```bash
# データベース確認
npx prisma studio

# ログ確認
tail -f /tmp/nextjs.log

# API動作確認
curl http://localhost:3000/api/laws
```

## 7. まとめ

Phase 2への移行により、LawFinderは静的サイトからモダンなフルスタックアプリケーションへと進化しました。この新しいアーキテクチャは、今後の機能拡張とスケーラビリティを考慮した設計となっています。