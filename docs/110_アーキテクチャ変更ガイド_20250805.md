# LawFinder アーキテクチャ変更ガイド

**作成日**: 2025 年 8 月 5 日  
**バージョン**: 2.0.0  
**ステータス**: Phase 2 移行完了

## 1. アーキテクチャの変更概要

### 1.1 Phase 1 から Phase 2 への移行

| 項目           | Phase 1 (旧)           | Phase 2 (新)                  |
| -------------- | ---------------------- | ----------------------------- |
| アーキテクチャ | 静的サイト生成         | データベース駆動型 Web アプリ |
| データ処理     | ビルド時に一括処理     | データベースで永続化          |
| フロントエンド | 静的 HTML + Vanilla JS | React 19 + Next.js 15         |
| バックエンド   | Node.js スクリプト     | Next.js API Routes            |
| データストア   | JSON ファイル          | SQLite/PostgreSQL             |
| 検索機能       | クライアントサイド     | サーバーサイド DB 検索        |

### 1.2 主な変更理由

1. **スケーラビリティ**: 大規模データへの対応
2. **リアルタイム性**: 動的なデータ更新
3. **拡張性**: AI 機能やグラフ DB の統合準備
4. **保守性**: データとロジックの分離

## 2. 新しいアーキテクチャ詳細

### 2.1 データベース層（Prisma + SQLite/PostgreSQL）

#### スキーマ設計

```prisma
model Law {
  id                String    @id
  title             String
  articles          Article[]
  metadata          Json?
  enactStatements   Json?
  amendmentHistory  Json?
}

model Article {
  id                String    @id @default(uuid())
  lawId             String
  articleNumber     String
  articleTitle      String?
  content           String
  law               Law       @relation(fields: [lawId], references: [id])
  paragraphs        Paragraph[]
  referencesFrom    Reference[]
  referencesTo      Reference[]
}

model Reference {
  id                String    @id @default(uuid())
  fromArticleId     String
  toArticleId       String?
  referenceText     String
  referenceType     String
  confidence        Float?
}
```

#### データインポートフロー

1. XML ファイル読み込み
2. パース処理（Ruby/特殊文字対応）
3. データベースへの保存
4. 参照関係の検出・保存

### 2.2 API 層（Next.js API Routes）

#### エンドポイント設計

```typescript
// 法令一覧
GET /api/laws
  ?page=1&limit=20&search=民法

// 法令詳細
GET /api/laws/[id]

// 参照関係
GET /api/references
  ?lawId=xxx&articleId=yyy
```

#### レスポンス形式

```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### 2.3 フロントエンド層（React + Next.js）

#### コンポーネント構成

```
app/
├── layout.tsx          # 共通レイアウト
├── page.tsx           # ホームページ
├── laws/
│   ├── page.tsx       # 法令一覧
│   └── [id]/
│       └── page.tsx   # 法令詳細
└── api/               # API Routes
```

#### 主要な技術選定

- **Next.js 15**: App Router、Server Components
- **React 19**: 最新の並行機能
- **Tailwind CSS**: ユーティリティベースのスタイリング
- **TypeScript**: 型安全性の確保

## 3. データフロー

### 3.1 初期セットアップ

```bash
# 1. データベース準備
npm run db:migrate    # テーブル作成
npm run db:generate   # Prismaクライアント生成

# 2. データインポート
npm run db:import     # XMLからDBへ

# 3. 開発サーバー起動
npm run dev:next
```

### 3.2 リクエストフロー

```
[ブラウザ] → [Next.js Pages] → [API Routes] → [Prisma] → [SQLite/PostgreSQL]
    ↑                                                            ↓
    └──────────────────── JSONレスポンス ←───────────────────────┘
```

## 4. 移行時の考慮事項

### 4.1 既存スクリプトの扱い

| スクリプト           | 状態 | 今後の扱い             |
| -------------------- | ---- | ---------------------- |
| build-static-\*.js   | 維持 | レガシー機能として保持 |
| import-laws-to-db.ts | 新規 | メインのデータ管理     |
| parse-xml.js         | 参照 | 共通パーサーとして活用 |

### 4.2 パフォーマンス最適化

1. **データベースインデックス**

   - law.title
   - law.lawNumber
   - article.lawId
   - reference.fromArticleId

2. **クエリ最適化**

   - 必要なフィールドのみ選択
   - 関連データの効率的な取得
   - ページネーション実装

3. **キャッシング戦略**（将来実装）
   - Redis 導入
   - CDN キャッシュ
   - React Query/SWR

## 5. 将来の拡張計画

### 5.1 短期（3 ヶ月）

- PostgreSQL 本番環境構築
- Elasticsearch 統合
- ユーザー認証機能

### 5.2 中期（6 ヶ月）

- Neo4j 参照グラフ
- OpenAI GPT-4o 統合
- リアルタイム更新

### 5.3 長期（1 年）

- マイクロサービス化
- Kubernetes 展開
- 機械学習モデル統合

## 6. トラブルシューティング

### 6.1 よくある問題

**Q: Next.js 15 で params エラーが出る**

```typescript
// 誤
{ params }: { params: { id: string } }

// 正
{ params }: { params: Promise<{ id: string }> }
const { id } = await params;
```

**Q: autoprefixer エラー**

```bash
npm install --save-dev autoprefixer
```

**Q: Prisma クライアントが見つからない**

```bash
npm run db:generate
```

### 6.2 デバッグコマンド

```bash
# データベース確認
npx prisma studio

# ログ確認
tail -f /tmp/nextjs.log

# API動作確認
curl http://localhost:5000/api/laws
```

## 7. まとめ

Phase 2 への移行により、LawFinder は静的サイトからモダンなフルスタックアプリケーションへと進化しました。この新しいアーキテクチャは、今後の機能拡張とスケーラビリティを考慮した設計となっています。
