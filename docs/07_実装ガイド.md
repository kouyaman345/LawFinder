# 実装ガイド

## 1. 開発環境セットアップ

### 1.1 必要なソフトウェア
- Node.js 20.x 以上
- npm 10.x 以上
- Git
- Docker（データベース用）
- VSCode（推奨）

### 1.2 プロジェクト初期設定

```bash
# リポジトリのクローン
git clone https://github.com/your-org/lawfinder.git
cd lawfinder

# 依存関係のインストール
npm install

# 環境変数の設定
cp .env.example .env
# .envファイルを編集

# データベースの起動
docker-compose up -d

# Prismaのセットアップ
npx prisma generate
npx prisma migrate dev

# Neo4jの起動
docker-compose -f docker-compose.neo4j.yml up -d
```

## 2. 開発フロー

### 2.1 通常の開発作業

```bash
# 開発サーバー起動
npm run dev
# http://localhost:3000 でアクセス

# テスト実行
npm test

# 型チェック
npm run typecheck

# リンター実行
npm run lint
```

### 2.2 法令データのインポート

```bash
# 主要法令のインポート
npx tsx scripts/cli.ts law import --major

# 特定法令のインポート
npx tsx scripts/cli.ts law import -l 129AC0000000089

# 全法令のインポート（時間がかかる）
npx tsx scripts/cli.ts law import --all
```

### 2.3 参照検出の実行

```bash
# 参照検出実行
npx tsx scripts/cli.ts ref detect "民法第90条"

# 法令全体の参照処理
npx tsx scripts/cli.ts ref process 129AC0000000089

# Neo4jへの同期
npx tsx scripts/cli.ts sync neo4j
```

## 3. コーディング規約

### 3.1 TypeScriptコーディングスタイル

```typescript
// インターフェース名はPascalCase
interface LawReference {
  id: string;
  fromArticle: string;
  toArticle: string;
}

// クラス名はPascalCase
class ReferenceDetector {
  // プライベートプロパティは_プレフィックス
  private _cache: Map<string, Reference[]>;
  
  // メソッド名はcamelCase
  public detectReferences(text: string): Reference[] {
    // 変数名はcamelCase
    const references: Reference[] = [];
    // ...
    return references;
  }
}

// 定数はUPPER_SNAKE_CASE
const MAX_REFERENCE_LENGTH = 100;
```

### 3.2 Reactコンポーネント

```tsx
// コンポーネント名はPascalCase
export function LawContentView({ 
  lawId, 
  articles 
}: LawContentViewProps) {
  // フックの使用
  const [selectedArticle, setSelectedArticle] = useState<string>('');
  
  // イベントハンドラはhandleプレフィックス
  const handleArticleClick = (articleId: string) => {
    setSelectedArticle(articleId);
  };
  
  return (
    <div className="law-content">
      {articles.map(article => (
        <Article 
          key={article.id}
          article={article}
          onClick={handleArticleClick}
        />
      ))}
    </div>
  );
}
```

### 3.3 ファイル構成

```
/src
  /domain           # ドメイン層
    /models         # ドメインモデル
    /services       # ドメインサービス
    /repositories   # リポジトリインターフェース
  /application      # アプリケーション層
    /usecases       # ユースケース
    /dto            # データ転送オブジェクト
  /infrastructure   # インフラ層
    /db             # データベース実装
    /parsers        # XMLパーサー
/app                # Next.js App Router
  /api              # API Routes
  /components       # UIコンポーネント
  /laws             # 法令関連ページ
/scripts            # ユーティリティスクリプト
```

## 4. データベース操作

### 4.1 Prismaの使用

```typescript
// 法令データの取得
import { prisma } from '@/lib/prisma';

export async function getLaw(lawId: string) {
  const law = await prisma.law.findUnique({
    where: { id: lawId },
    include: {
      articles: {
        orderBy: { orderNumber: 'asc' },
        include: {
          paragraphs: true
        }
      }
    }
  });
  
  return law;
}
```

### 4.2 Neo4jの使用

```typescript
// 参照関係の取得
import neo4j from 'neo4j-driver';

const driver = neo4j.driver(
  process.env.NEO4J_URI!,
  neo4j.auth.basic(
    process.env.NEO4J_USER!,
    process.env.NEO4J_PASSWORD!
  )
);

export async function getReferences(lawId: string) {
  const session = driver.session();
  
  try {
    const result = await session.run(
      `
      MATCH (a:Article {lawId: $lawId})-[r:REFERENCES]->(target)
      RETURN a, r, target
      `,
      { lawId }
    );
    
    return result.records.map(record => ({
      from: record.get('a').properties,
      to: record.get('target').properties,
      type: record.get('r').properties.type
    }));
  } finally {
    await session.close();
  }
}
```

## 5. API実装

### 5.1 API Routeの作成

```typescript
// app/api/laws/[id]/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getLaw } from '@/lib/database';

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const law = await getLaw(params.id);
    
    if (!law) {
      return NextResponse.json(
        { error: 'Law not found' },
        { status: 404 }
      );
    }
    
    return NextResponse.json({
      success: true,
      data: law
    });
  } catch (error) {
    console.error('Error fetching law:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

## 6. テストの書き方

### 6.1 単体テスト

```typescript
// __tests__/reference-detector.test.ts
import { ReferenceDetector } from '@/domain/services/ReferenceDetector';

describe('ReferenceDetector', () => {
  let detector: ReferenceDetector;
  
  beforeEach(() => {
    detector = new ReferenceDetector();
  });
  
  describe('detectReferences', () => {
    it('内部参照を検出できる', () => {
      const text = '前条の規定により';
      const references = detector.detectReferences(text);
      
      expect(references).toHaveLength(1);
      expect(references[0].type).toBe('relative');
      expect(references[0].text).toBe('前条');
    });
    
    it('外部参照を検出できる', () => {
      const text = '民法第90条の規定';
      const references = detector.detectReferences(text);
      
      expect(references).toHaveLength(1);
      expect(references[0].type).toBe('external');
      expect(references[0].lawName).toBe('民法');
      expect(references[0].articleNumber).toBe('第90条');
    });
  });
});
```

## 7. デプロイ

### 7.1 ビルド

```bash
# プロダクションビルド
npm run build

# ビルド結果の確認
npm run start
```

### 7.2 Dockerイメージの作成

```dockerfile
# Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:20-alpine AS runner

WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./

EXPOSE 3000
CMD ["npm", "start"]
```

## 8. トラブルシューティング

### 8.1 よくある問題

#### ポートが使用中
```bash
# ポートを使用しているプロセスを終了
pkill -f "next-server"
pkill -f "next dev"
```

#### データベース接続エラー
```bash
# データベースの状態確認
docker-compose ps

# データベースの再起動
docker-compose restart
```

#### Prismaエラー
```bash
# Prismaクライアントの再生成
npx prisma generate

# マイグレーションの実行
npx prisma migrate dev
```