# 運用・インフラ設計書

## 1. インフラストラクチャ概要

### 1.1 システム構成
```
┌───────────────────────────────────────────┐
│                  Internet                     │
└────────────────────┬──────────────────────┘
                      │
            ┌─────────┴────────┐
            │   Load Balancer    │
            └─────┬─────┬─────┘
                  │       │
        ┌─────────┴─┐   ┌─┴─────────┐
        │   App #1    │   │   App #2    │
        │  (Next.js)  │   │  (Next.js)  │
        └─────┬──────┘   └──────┬─────┘
              │                     │
    ┌─────────┴──────────┬────────┴─────────┐
    │     PostgreSQL      │      Neo4j          │
    │     (Primary)       │   (Graph DB)        │
    └────────────────────┴────────────────────┘
```

### 1.2 環境構成

| 環境 | 用途 | URL |
|------|------|-----|
| 開発環境 | 開発・テスト | http://localhost:3000 |
| ステージング | 統合テスト | https://staging.lawfinder.jp |
| 本番環境 | プロダクション | https://lawfinder.jp |

## 2. サーバー設定

### 2.1 アプリケーションサーバー

#### 推奨スペック
- CPU: 4コア以上
- メモリ: 8GB以上
- ストレージ: 100GB SSD

#### Node.js設定
```javascript
// pm2.config.js
module.exports = {
  apps: [{
    name: 'lawfinder',
    script: 'npm',
    args: 'start',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    max_memory_restart: '1G',
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

### 2.2 データベースサーバー

#### PostgreSQL設定
```ini
# postgresql.conf
max_connections = 200
shared_buffers = 2GB
effective_cache_size = 6GB
maintenance_work_mem = 512MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
work_mem = 10MB
min_wal_size = 1GB
max_wal_size = 4GB
```

#### Neo4j設定
```properties
# neo4j.conf
dbms.memory.heap.initial_size=2g
dbms.memory.heap.max_size=4g
dbms.memory.pagecache.size=2g
dbms.connector.bolt.enabled=true
dbms.connector.http.enabled=true
dbms.security.auth_enabled=true
```

## 3. Docker構成

### 3.1 docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - NEO4J_URI=${NEO4J_URI}
    depends_on:
      - postgres
      - neo4j
    networks:
      - lawfinder-network

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=lawfinder
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=lawfinder
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - lawfinder-network

  neo4j:
    image: neo4j:5-community
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_dbms_memory_heap_max__size=4G
    volumes:
      - neo4j-data:/data
    networks:
      - lawfinder-network

volumes:
  postgres-data:
  neo4j-data:

networks:
  lawfinder-network:
    driver: bridge
```

## 4. 監視・ログ管理

### 4.1 監視項目

| 監視対象 | メトリクス | 闾値 |
|---------|----------|------|
| システム | CPU使用率 | 80% |
| システム | メモリ使用率 | 90% |
| システム | ディスク使用率 | 85% |
| アプリ | 応答時間 | 3秒 |
| アプリ | エラー率 | 1% |
| DB | コネクション数 | 180 |
| DB | クエリ時間 | 1秒 |

### 4.2 ログ管理

#### ログ種別
- **アクセスログ**: Nginx/Next.js
- **アプリケーションログ**: PM2/Winston
- **エラーログ**: Sentry（将来実装）
- **データベースログ**: PostgreSQL/Neo4j

#### ログローテーション
```bash
# logrotate設定
/var/log/lawfinder/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

## 5. バックアップ・リカバリ

### 5.1 バックアップ戦略

| 対象 | 頻度 | 保存先 | 保存期間 |
|------|------|---------|----------|
| データベース | 日次 | S3/ローカル | 30日 |
| アプリケーション | 週次 | Git | - |
| 設定ファイル | 変更時 | Git | - |
| ログ | 日次 | S3 | 90日 |

### 5.2 バックアップスクリプト

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"

# PostgreSQLバックアップ
pg_dump -h localhost -U lawfinder lawfinder | \
  gzip > "${BACKUP_DIR}/postgres_${DATE}.sql.gz"

# Neo4jバックアップ
neo4j-admin database dump neo4j \
  --to-path="${BACKUP_DIR}/neo4j_${DATE}.dump"

# S3にアップロード
aws s3 sync ${BACKUP_DIR} s3://lawfinder-backup/

# 古いバックアップを削除
find ${BACKUP_DIR} -mtime +30 -delete
```

### 5.3 リカバリ手順

1. **システム停止**
   ```bash
   pm2 stop all
   ```

2. **データベースリストア**
   ```bash
   # PostgreSQL
   gunzip < backup.sql.gz | psql -U lawfinder lawfinder
   
   # Neo4j
   neo4j-admin database load neo4j --from-path=backup.dump
   ```

3. **アプリケーション再起動**
   ```bash
   pm2 start all
   ```

## 6. セキュリティ

### 6.1 ネットワークセキュリティ

#### ファイアウォール設定
```bash
# UFW設定
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp  # SSH
ufw allow 80/tcp  # HTTP
ufw allow 443/tcp # HTTPS
ufw enable
```

#### SSL/TLS設定
```nginx
# nginx.conf
server {
    listen 443 ssl http2;
    server_name lawfinder.jp;
    
    ssl_certificate /etc/letsencrypt/live/lawfinder.jp/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lawfinder.jp/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
}
```

### 6.2 アプリケーションセキュリティ

- 環境変数の暗号化
- SQLインジェクション対策（Prisma ORM）
- XSS対策（React自動エスケープ）
- CSRF対策（Next.js組み込み）

## 7. 運用手順

### 7.1 日次作業

- [ ] システム監視チェック
- [ ] ログ確認
- [ ] バックアップ実行確認
- [ ] アラート対応

### 7.2 週次作業

- [ ] パフォーマンスレポート作成
- [ ] セキュリティアップデート確認
- [ ] データベース最適化

### 7.3 月次作業

- [ ] システムアップデート
- [ ] キャパシティプランニング
- [ ] ディザスタリカバリテスト

## 8. スケーリング

### 8.1 水平スケーリング

- ロードバランサーを使用した負荷分散
- ステートレス設計
- セッションのRedis管理（将来実装）

### 8.2 垂直スケーリング

- CPU/メモリの増強
- データベースのレプリケーション
- キャッシュ層の追加