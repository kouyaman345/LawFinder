# データベース設計書

**プロジェクト名**: LawFinder  
**作成日**: 2025年8月3日  
**バージョン**: 1.0  
**作成者**: システム設計チーム

## 1. 概要

### 1.1 目的
本書は、LawFinderシステムにおけるデータベース設計の詳細を定義する。法令データの構造化、参照関係の管理、検索性能の最適化を実現するためのデータベース構造を示す。

### 1.2 対象データベース
- **PostgreSQL 15.x**: メタデータ、ユーザー管理、トランザクションデータ
- **Neo4j 5.x**: 法令間の参照関係グラフ
- **Elasticsearch 8.x**: 全文検索インデックス
- **Redis 7.x**: キャッシュ、セッション管理

### 1.3 設計方針
- 正規化と性能のバランスを考慮した設計
- 将来の拡張性を確保
- データの整合性と一貫性を重視
- 大規模データ（10,000件以上の法令）に対応

## 2. エンティティ関係図（ER図）

### 2.1 概念ER図

```mermaid
erDiagram
    LAWS ||--o{ ARTICLES : has
    LAWS ||--o{ LAW_REVISIONS : has
    ARTICLES ||--o{ PARAGRAPHS : has
    PARAGRAPHS ||--o{ ITEMS : has
    ARTICLES ||--o{ REFERENCES : from
    ARTICLES ||--o{ REFERENCES : to
    LAWS ||--o{ LAW_ATTACHMENTS : has
    USERS ||--o{ USER_SESSIONS : has
    USERS ||--o{ AUDIT_LOGS : performs
    REFERENCES ||--|| AI_VALIDATIONS : has
    
    LAWS {
        string law_id PK
        string law_type
        string law_num
        string law_title
        date promulgate_date
        date enforce_date
    }
    
    ARTICLES {
        string article_id PK
        string law_id FK
        int article_num
        string article_title
        text content
    }
    
    REFERENCES {
        string reference_id PK
        string source_article_id FK
        string target_article_id FK
        string reference_type
        float confidence_score
    }
```

### 2.2 物理ER図（PostgreSQL）

```sql
-- 詳細は後述のDDLセクションを参照
```

## 3. テーブル定義（PostgreSQL）

### 3.1 法令マスタ（laws）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| law_id | VARCHAR(20) | NO | - | 法令ID（主キー） |
| law_type | VARCHAR(20) | NO | - | 法令種別 |
| law_num | VARCHAR(100) | NO | - | 法令番号 |
| law_title | VARCHAR(500) | NO | - | 法令名 |
| law_title_kana | VARCHAR(500) | YES | NULL | 法令名かな |
| law_title_abbrev | VARCHAR(200) | YES | NULL | 法令略称 |
| era | VARCHAR(20) | NO | - | 元号 |
| year | INTEGER | NO | - | 年 |
| num | INTEGER | NO | - | 号 |
| promulgate_date | DATE | NO | - | 公布日 |
| enforce_date | DATE | YES | NULL | 施行日 |
| repeal_date | DATE | YES | NULL | 廃止日 |
| status | VARCHAR(20) | NO | 'active' | 状態（active/repealed） |
| last_updated_date | DATE | YES | NULL | 最終更新日 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | NOW() | 更新日時 |

**インデックス**:
- PRIMARY KEY (law_id)
- INDEX idx_law_type (law_type)
- INDEX idx_law_status (status)
- INDEX idx_promulgate_date (promulgate_date)
- FULLTEXT INDEX idx_law_title (law_title)

### 3.2 条文（articles）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| article_id | VARCHAR(50) | NO | - | 条文ID（主キー） |
| law_id | VARCHAR(20) | NO | - | 法令ID（外部キー） |
| article_num | INTEGER | NO | - | 条番号 |
| article_num_branch | VARCHAR(10) | YES | NULL | 枝番（第3条の2など） |
| article_title | VARCHAR(200) | YES | NULL | 条見出し |
| content | TEXT | NO | - | 条文内容 |
| is_deleted | BOOLEAN | NO | FALSE | 削除フラグ |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | NOW() | 更新日時 |

**インデックス**:
- PRIMARY KEY (article_id)
- INDEX idx_law_article (law_id, article_num)
- FULLTEXT INDEX idx_article_content (content)

### 3.3 項（paragraphs）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| paragraph_id | VARCHAR(60) | NO | - | 項ID（主キー） |
| article_id | VARCHAR(50) | NO | - | 条文ID（外部キー） |
| paragraph_num | INTEGER | NO | - | 項番号 |
| content | TEXT | NO | - | 項内容 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |

**インデックス**:
- PRIMARY KEY (paragraph_id)
- INDEX idx_article_paragraph (article_id, paragraph_num)
- FULLTEXT INDEX idx_paragraph_content (content)

### 3.4 号（items）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| item_id | VARCHAR(70) | NO | - | 号ID（主キー） |
| paragraph_id | VARCHAR(60) | NO | - | 項ID（外部キー） |
| item_num | INTEGER | NO | - | 号番号 |
| content | TEXT | NO | - | 号内容 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |

**インデックス**:
- PRIMARY KEY (item_id)
- INDEX idx_paragraph_item (paragraph_id, item_num)

### 3.5 参照関係（references）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| reference_id | VARCHAR(50) | NO | - | 参照ID（主キー） |
| source_law_id | VARCHAR(20) | NO | - | 参照元法令ID |
| source_article_id | VARCHAR(50) | NO | - | 参照元条文ID |
| source_paragraph_id | VARCHAR(60) | YES | NULL | 参照元項ID |
| source_text | TEXT | NO | - | 参照元テキスト |
| target_law_id | VARCHAR(20) | YES | NULL | 参照先法令ID |
| target_article_id | VARCHAR(50) | YES | NULL | 参照先条文ID |
| target_paragraph_id | VARCHAR(60) | YES | NULL | 参照先項ID |
| reference_type | VARCHAR(30) | NO | - | 参照タイプ |
| reference_pattern | VARCHAR(50) | YES | NULL | 参照パターン |
| confidence_score | DECIMAL(3,2) | NO | 0.00 | 信頼度スコア |
| is_verified | BOOLEAN | NO | FALSE | 検証済みフラグ |
| extraction_method | VARCHAR(50) | NO | - | 抽出方法 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | NOW() | 更新日時 |

**インデックス**:
- PRIMARY KEY (reference_id)
- INDEX idx_source (source_article_id)
- INDEX idx_target (target_article_id)
- INDEX idx_reference_type (reference_type)
- INDEX idx_confidence (confidence_score)

### 3.6 AI検証結果（ai_validations）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| validation_id | VARCHAR(50) | NO | - | 検証ID（主キー） |
| reference_id | VARCHAR(50) | NO | - | 参照ID（外部キー） |
| model_name | VARCHAR(50) | NO | - | 使用モデル名 |
| model_version | VARCHAR(20) | NO | - | モデルバージョン |
| confidence_score | DECIMAL(3,2) | NO | - | AI信頼度スコア |
| is_valid | BOOLEAN | NO | - | 妥当性判定 |
| reasoning | TEXT | YES | NULL | 判定理由 |
| ambiguity_notes | TEXT | YES | NULL | 曖昧性の注記 |
| correction_suggestion | TEXT | YES | NULL | 修正提案 |
| validated_at | TIMESTAMP | NO | NOW() | 検証日時 |

**インデックス**:
- PRIMARY KEY (validation_id)
- UNIQUE INDEX idx_reference_validation (reference_id)
- INDEX idx_model (model_name, model_version)

### 3.7 法令改正履歴（law_revisions）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| revision_id | VARCHAR(50) | NO | - | 改正ID（主キー） |
| law_id | VARCHAR(20) | NO | - | 法令ID（外部キー） |
| revision_law_id | VARCHAR(20) | NO | - | 改正法令ID |
| revision_date | DATE | NO | - | 改正日 |
| revision_type | VARCHAR(30) | NO | - | 改正種別 |
| description | TEXT | YES | NULL | 改正内容説明 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |

**インデックス**:
- PRIMARY KEY (revision_id)
- INDEX idx_law_revision (law_id, revision_date)
- INDEX idx_revision_law (revision_law_id)

### 3.8 ユーザー（users）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| user_id | UUID | NO | gen_random_uuid() | ユーザーID（主キー） |
| email | VARCHAR(255) | NO | - | メールアドレス |
| name | VARCHAR(100) | NO | - | 氏名 |
| organization | VARCHAR(200) | YES | NULL | 所属組織 |
| role | VARCHAR(20) | NO | 'viewer' | ロール |
| is_active | BOOLEAN | NO | TRUE | 有効フラグ |
| last_login_at | TIMESTAMP | YES | NULL | 最終ログイン日時 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | NOW() | 更新日時 |

**インデックス**:
- PRIMARY KEY (user_id)
- UNIQUE INDEX idx_email (email)
- INDEX idx_role (role)
- INDEX idx_organization (organization)

### 3.9 監査ログ（audit_logs）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|----------|------|------------|------|
| log_id | BIGSERIAL | NO | - | ログID（主キー） |
| user_id | UUID | YES | NULL | ユーザーID |
| action | VARCHAR(50) | NO | - | アクション |
| resource_type | VARCHAR(50) | NO | - | リソースタイプ |
| resource_id | VARCHAR(100) | YES | NULL | リソースID |
| details | JSONB | YES | NULL | 詳細情報 |
| ip_address | INET | YES | NULL | IPアドレス |
| user_agent | TEXT | YES | NULL | ユーザーエージェント |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |

**インデックス**:
- PRIMARY KEY (log_id)
- INDEX idx_user_action (user_id, action)
- INDEX idx_created_at (created_at)
- INDEX idx_resource (resource_type, resource_id)

## 4. Neo4jグラフデータベース設計

### 4.1 ノード定義

#### Law（法令）ノード
```cypher
(:Law {
    law_id: String,          // 一意識別子
    law_type: String,        // 法令種別
    law_num: String,         // 法令番号
    law_title: String,       // 法令名
    promulgate_date: Date,   // 公布日
    enforce_date: Date,      // 施行日
    status: String           // 状態
})
```

#### Article（条文）ノード
```cypher
(:Article {
    article_id: String,      // 一意識別子
    article_num: Integer,    // 条番号
    article_title: String,   // 条見出し
    content: String          // 条文内容（検索用）
})
```

#### Paragraph（項）ノード
```cypher
(:Paragraph {
    paragraph_id: String,    // 一意識別子
    paragraph_num: Integer,  // 項番号
    content: String          // 項内容
})
```

#### Item（号）ノード
```cypher
(:Item {
    item_id: String,         // 一意識別子
    item_num: Integer,       // 号番号
    content: String          // 号内容
})
```

### 4.2 リレーションシップ定義

#### 構造的リレーションシップ
```cypher
// 法令と条文の関係
(:Law)-[:HAS_ARTICLE {position: Integer}]->(:Article)

// 条文と項の関係
(:Article)-[:HAS_PARAGRAPH {position: Integer}]->(:Paragraph)

// 項と号の関係
(:Paragraph)-[:HAS_ITEM {position: Integer}]->(:Item)
```

#### 参照リレーションシップ
```cypher
// 汎用参照関係
(:Article)-[:REFERENCES {
    reference_id: String,
    source_text: String,
    primary_type: String,        // APPLY, DEEM, REPLACE等
    secondary_types: [String],   // 副次的な特徴
    conditions: [String],        // 適用条件
    exceptions: [String],        // 例外事項
    confidence: Float,           // 信頼度スコア
    ai_verified: Boolean,        // AI検証済み
    extracted_at: DateTime,      // 抽出日時
    extraction_method: String    // 抽出方法
}]->(:Article)
```

### 4.3 インデックス設計（Neo4j）

```cypher
// ノードインデックス
CREATE INDEX law_id_index FOR (l:Law) ON (l.law_id);
CREATE INDEX article_id_index FOR (a:Article) ON (a.article_id);
CREATE INDEX paragraph_id_index FOR (p:Paragraph) ON (p.paragraph_id);
CREATE INDEX item_id_index FOR (i:Item) ON (i.item_id);

// 複合インデックス
CREATE INDEX law_status_index FOR (l:Law) ON (l.status);
CREATE INDEX article_num_index FOR (a:Article) ON (a.article_num);

// フルテキストインデックス
CALL db.index.fulltext.createNodeIndex("lawTitleIndex", ["Law"], ["law_title"]);
CALL db.index.fulltext.createNodeIndex("articleContentIndex", ["Article"], ["content"]);
```

## 5. Elasticsearchインデックス設計

### 5.1 法令インデックス（laws_index）

```json
{
  "mappings": {
    "properties": {
      "law_id": { "type": "keyword" },
      "law_type": { "type": "keyword" },
      "law_num": { "type": "keyword" },
      "law_title": {
        "type": "text",
        "analyzer": "kuromoji",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "law_title_kana": {
        "type": "text",
        "analyzer": "kuromoji_readingform"
      },
      "promulgate_date": { "type": "date" },
      "enforce_date": { "type": "date" },
      "status": { "type": "keyword" },
      "full_text": {
        "type": "text",
        "analyzer": "kuromoji"
      },
      "suggest": {
        "type": "completion",
        "analyzer": "kuromoji"
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "kuromoji": {
          "type": "custom",
          "tokenizer": "kuromoji_tokenizer",
          "filter": ["kuromoji_baseform", "ja_stop", "kuromoji_stemmer"]
        }
      }
    }
  }
}
```

### 5.2 条文インデックス（articles_index）

```json
{
  "mappings": {
    "properties": {
      "article_id": { "type": "keyword" },
      "law_id": { "type": "keyword" },
      "article_num": { "type": "integer" },
      "article_title": {
        "type": "text",
        "analyzer": "kuromoji"
      },
      "content": {
        "type": "text",
        "analyzer": "kuromoji",
        "term_vector": "with_positions_offsets",
        "highlight": {
          "type": "fvh"
        }
      },
      "references": {
        "type": "nested",
        "properties": {
          "target_law_id": { "type": "keyword" },
          "target_article_id": { "type": "keyword" },
          "reference_type": { "type": "keyword" },
          "confidence_score": { "type": "float" }
        }
      }
    }
  }
}
```

## 6. Redisキャッシュ設計

### 6.1 キャッシュキー設計

| キータイプ | キーフォーマット | TTL | 説明 |
|------------|------------------|-----|------|
| 法令詳細 | `law:{law_id}` | 24時間 | 法令の基本情報 |
| 条文詳細 | `article:{article_id}` | 24時間 | 条文の詳細情報 |
| 参照関係 | `ref:from:{article_id}` | 12時間 | 条文からの参照 |
| 逆参照 | `ref:to:{article_id}` | 12時間 | 条文への参照 |
| 検索結果 | `search:{hash}` | 1時間 | 検索結果キャッシュ |
| セッション | `session:{session_id}` | 30分 | ユーザーセッション |
| API制限 | `ratelimit:{user_id}:{endpoint}` | 1分 | APIレート制限 |

### 6.2 キャッシュ戦略

```javascript
// キャッシュ更新戦略
const cacheStrategies = {
  // Write-Through: 書き込み時に同時にキャッシュ更新
  writeThrough: ['law', 'article'],
  
  // Cache-Aside: 読み込み時にキャッシュ設定
  cacheAside: ['search', 'ref'],
  
  // Write-Behind: 非同期でキャッシュ更新
  writeBehind: ['statistics', 'analytics']
};
```

## 7. データベース最適化

### 7.1 パーティション設計

#### PostgreSQL パーティション
```sql
-- 監査ログの月次パーティション
CREATE TABLE audit_logs_2025_01 PARTITION OF audit_logs
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE audit_logs_2025_02 PARTITION OF audit_logs
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- 自動パーティション作成用の関数
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
    partition_date DATE;
    partition_name TEXT;
BEGIN
    partition_date := date_trunc('month', CURRENT_DATE + interval '1 month');
    partition_name := 'audit_logs_' || to_char(partition_date, 'YYYY_MM');
    
    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF audit_logs 
                    FOR VALUES FROM (%L) TO (%L)',
                    partition_name,
                    partition_date,
                    partition_date + interval '1 month');
END;
$$ LANGUAGE plpgsql;
```

### 7.2 インデックス最適化

```sql
-- 複合インデックスによる検索最適化
CREATE INDEX idx_law_search ON laws (status, law_type, promulgate_date DESC);

-- 部分インデックスによる容量削減
CREATE INDEX idx_active_laws ON laws (law_id) WHERE status = 'active';

-- カバリングインデックス
CREATE INDEX idx_article_covering ON articles (law_id, article_num) 
INCLUDE (article_title, content);
```

### 7.3 クエリ最適化

```sql
-- マテリアライズドビューによる集計高速化
CREATE MATERIALIZED VIEW law_statistics AS
SELECT 
    law_type,
    COUNT(*) as total_count,
    COUNT(CASE WHEN status = 'active' THEN 1 END) as active_count,
    COUNT(CASE WHEN status = 'repealed' THEN 1 END) as repealed_count,
    MAX(promulgate_date) as latest_promulgate_date
FROM laws
GROUP BY law_type
WITH DATA;

-- 定期的なリフレッシュ
CREATE OR REPLACE FUNCTION refresh_law_statistics()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY law_statistics;
END;
$$ LANGUAGE plpgsql;
```

## 8. データ移行・バックアップ設計

### 8.1 初期データ移行

```sql
-- 移行用のステージングテーブル
CREATE TABLE staging_laws (
    LIKE laws INCLUDING ALL
);

-- バルクインサート用の設定
ALTER TABLE staging_laws SET (autovacuum_enabled = false);
SET synchronous_commit = off;
SET maintenance_work_mem = '1GB';
```

### 8.2 バックアップ戦略

| データベース | バックアップ方式 | 頻度 | 保持期間 | 保存先 |
|-------------|----------------|------|----------|--------|
| PostgreSQL | pg_dump + WAL | 日次 | 30日 | S3 |
| Neo4j | neo4j-admin backup | 日次 | 30日 | S3 |
| Elasticsearch | Snapshot API | 週次 | 14日 | S3 |
| Redis | RDB + AOF | 時間毎 | 7日 | EBS |

### 8.3 リストア手順

```bash
# PostgreSQLリストア
pg_restore -d lawfinder -j 4 /backup/lawfinder_20250803.dump

# Neo4jリストア
neo4j-admin restore --from=/backup/neo4j_20250803.backup --database=neo4j

# Elasticsearchリストア
curl -X POST "localhost:9200/_snapshot/s3_backup/snapshot_20250803/_restore"

# Redisリストア
redis-cli --rdb /backup/redis_20250803.rdb
```

## 9. セキュリティ設計

### 9.1 アクセス制御

```sql
-- ロールベースアクセス制御
CREATE ROLE lawfinder_read;
CREATE ROLE lawfinder_write;
CREATE ROLE lawfinder_admin;

-- 読み取り専用権限
GRANT SELECT ON ALL TABLES IN SCHEMA public TO lawfinder_read;

-- 書き込み権限
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO lawfinder_write;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO lawfinder_write;

-- 管理者権限
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO lawfinder_admin;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO lawfinder_admin;
```

### 9.2 データ暗号化

```sql
-- 機密データの暗号化
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ユーザーデータの暗号化例
CREATE TABLE encrypted_user_data (
    user_id UUID PRIMARY KEY,
    encrypted_email BYTEA,
    encrypted_name BYTEA
);

-- 暗号化関数
CREATE OR REPLACE FUNCTION encrypt_pii(text_data TEXT)
RETURNS BYTEA AS $$
BEGIN
    RETURN pgp_sym_encrypt(text_data, current_setting('app.encryption_key'));
END;
$$ LANGUAGE plpgsql;
```

### 9.3 監査設定

```sql
-- 監査トリガー
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_logs (
        user_id,
        action,
        resource_type,
        resource_id,
        details,
        created_at
    ) VALUES (
        current_setting('app.current_user_id')::UUID,
        TG_OP,
        TG_TABLE_NAME,
        NEW.id,
        row_to_json(NEW),
        NOW()
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 主要テーブルへの監査トリガー適用
CREATE TRIGGER audit_laws_trigger
AFTER INSERT OR UPDATE OR DELETE ON laws
FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();
```

## 10. パフォーマンス監視

### 10.1 監視項目

| 項目 | 閾値 | アラート条件 |
|------|------|-------------|
| クエリ実行時間 | 1秒 | 95パーセンタイル > 1秒 |
| コネクション数 | 100 | アクティブ接続 > 80 |
| デッドロック | 0 | 発生時即時 |
| レプリケーション遅延 | 1秒 | 遅延 > 1秒 |
| ディスク使用率 | 80% | 使用率 > 80% |

### 10.2 パフォーマンス改善クエリ

```sql
-- スロークエリの特定
SELECT 
    query,
    mean_exec_time,
    calls,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 20;

-- インデックス使用状況
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan;

-- テーブル膨張の確認
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    n_live_tup,
    n_dead_tup,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_percent
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

## 11. 運用手順

### 11.1 日次メンテナンス

```sql
-- 統計情報の更新
ANALYZE;

-- 不要領域の回収
VACUUM ANALYZE;

-- インデックスの再構築（週次）
REINDEX DATABASE lawfinder CONCURRENTLY;
```

### 11.2 容量管理

```sql
-- データベースサイズ監視
SELECT 
    datname,
    pg_size_pretty(pg_database_size(datname)) as size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- テーブル別容量
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## 12. 障害対応

### 12.1 接続障害

```sql
-- 接続状態の確認
SELECT 
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change
FROM pg_stat_activity
WHERE state != 'idle';

-- 問題のある接続の強制切断
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'idle in transaction'
AND state_change < NOW() - INTERVAL '30 minutes';
```

### 12.2 レプリケーション障害

```sql
-- レプリケーション状態確認
SELECT 
    client_addr,
    state,
    sent_lsn,
    write_lsn,
    flush_lsn,
    replay_lsn,
    sync_state
FROM pg_stat_replication;
```

## 13. 改訂履歴

| バージョン | 日付 | 変更内容 |
|----------|------|----------|
| 1.0 | 2025-08-03 | 初版作成 |

## 付録A: DDLスクリプト

```sql
-- データベース作成
CREATE DATABASE lawfinder
    WITH 
    OWNER = lawfinder_admin
    ENCODING = 'UTF8'
    LC_COLLATE = 'ja_JP.UTF-8'
    LC_CTYPE = 'ja_JP.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;

-- スキーマ作成
CREATE SCHEMA IF NOT EXISTS public;

-- 拡張機能の有効化
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 全テーブルのDDLは上記セクション3を参照
```

## 付録B: サンプルクエリ

```sql
-- 法令の参照関係を取得
WITH RECURSIVE reference_chain AS (
    SELECT 
        r.reference_id,
        r.source_article_id,
        r.target_article_id,
        r.reference_type,
        1 as depth
    FROM references r
    WHERE r.source_article_id = '320AC0000000046_art2'
    
    UNION ALL
    
    SELECT 
        r.reference_id,
        r.source_article_id,
        r.target_article_id,
        r.reference_type,
        rc.depth + 1
    FROM references r
    INNER JOIN reference_chain rc ON r.source_article_id = rc.target_article_id
    WHERE rc.depth < 3
)
SELECT * FROM reference_chain;

-- 最も参照されている法令TOP10
SELECT 
    l.law_id,
    l.law_title,
    COUNT(DISTINCT r.reference_id) as reference_count
FROM laws l
INNER JOIN articles a ON l.law_id = a.law_id
INNER JOIN references r ON a.article_id = r.target_article_id
WHERE l.status = 'active'
GROUP BY l.law_id, l.law_title
ORDER BY reference_count DESC
LIMIT 10;
```