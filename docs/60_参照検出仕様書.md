# LawFinder 参照検出仕様書

## 概要

LawFinderは日本の法令文書内の参照関係を自動検出し、適切にリンク化する機能を提供します。本ドキュメントでは、参照検出の詳細仕様と実装方法について説明します。

## 参照タイプと表示仕様

### 1. 内部参照（internal-ref）
- **色**: 青色 (#0066cc)
- **対象**: 同一法令内の条文・項への参照
- **例**: 「第五条」「第十七条第二項」
- **リンク**: クリック可能（該当箇所へジャンプ）

### 2. 外部参照（external-ref）
- **色**: 赤色 (#dc3545)
- **対象**: 他の法令への参照
- **例**: 「民法第五百二十四条」「刑法第百条」
- **リンク**: 読み込まれている法令の場合はクリック可能

### 3. 相対参照（relative-ref）
- **色**: 緑色 (#28a745)
- **対象**: 相対的な位置関係を示す参照
- **例**: 「前項」「次項」「同項」「同条」
- **リンク**: 
  - 「前条」「次条」: 条文番号から計算してリンク生成
  - 「前項」「次項」: 項番号から計算してリンク生成
  - 「同項」: LLMによる文脈判断（実装予定）
  - 「同条」: 現在の条文へのリンク

### 4. 章参照（chapter-ref/relative-chapter-ref）
- **色**: 青色（内部参照として表示）
- **対象**: 章への参照
- **例**: 「第五章」「前章」「次章」
- **リンク**: 現在はハイライトのみ（将来的に章へのアンカーリンクを実装予定）

## 参照検出パターン

### 正規表現パターン

```javascript
const patterns = [
  // 条文＋項の参照（第十七条第二項など）
  { regex: /第([０-９0-9一二三四五六七八九十百千]+)条第([０-９0-9一二三四五六七八九十]+)項/g, type: 'INTERNAL_REFERENCE' },
  
  // 条文のみの参照
  { regex: /第([０-９0-9一二三四五六七八九十百千]+)条(?!第)/g, type: 'INTERNAL_REFERENCE' },
  
  // 章の参照（第五章、次章など）
  { regex: /第([０-９0-9一二三四五六七八九十百千]+)章/g, type: 'CHAPTER_REFERENCE' },
  { regex: /前章|次章/g, type: 'RELATIVE_CHAPTER_REFERENCE' },
  
  // 外部法令への参照
  { regex: /(法令名).*?第([０-９0-9一二三四五六七八九十百千]+)条/g, type: 'EXTERNAL_REFERENCE' },
  
  // 相対参照（前条、次条など）
  { regex: /前条|次条/g, type: 'RELATIVE_ARTICLE_REFERENCE' },
  { regex: /前項|次項|同項|同条/g, type: 'RELATIVE_REFERENCE' },
  
  // 複合参照
  { regex: /同項第([０-９0-9一二三四五六七八九十]+)号/g, type: 'COMPLEX_REFERENCE' },
  { regex: /前項第([０-９0-9一二三四五六七八九十]+)号/g, type: 'COMPLEX_REFERENCE' }
];
```

## 漢数字変換仕様

### 変換アルゴリズム

1. **基本漢数字の変換**
   - 一〜九: 1〜9
   - 十: 10
   - 百: 100
   - 千: 1000

2. **複合漢数字の処理**
   - 「二十二」→ 22
   - 「百二十三」→ 123
   - 「千五百」→ 1500

3. **全角数字の処理**
   - 全角数字（０-９）を半角数字（0-9）に変換

## リンク生成仕様

### アンカーID規則

1. **条文**: `#art{条文番号}`
   - 例: 第12条 → `#art12`

2. **項**: `#art{条文番号}-para{項番号}`
   - 例: 第12条第2項 → `#art12-para2`

3. **外部法令**: `{法令ID}.html#art{条文番号}`
   - 例: 民法第524条 → `129AC0000000089.html#art524`

### 相対参照の解決

1. **前条・次条**
   - 現在の条文番号 ± 1
   - 例: 第12条の「前条」→ `#art11`

2. **前項・次項**
   - 現在の項番号 ± 1
   - 例: 第12条第2項の「前項」→ `#art12-para1`

3. **同項**（LLM実装予定）
   - 文脈から参照先を特定
   - 直前に言及された項を追跡
   - 例: 「第17条第2項の規定により...同項の場合」→ `#art17-para2`

## 処理フロー

1. **Phase 1: 法令データの読み込み**
   - XMLファイルから法令構造を解析
   - 条文・項・号の階層構造を保持

2. **Phase 2: 参照関係の抽出**
   - 各条文のテキストから参照パターンを検出
   - 参照タイプを分類

3. **Phase 3: HTMLファイルの生成**
   - 参照をリンクまたはハイライトに変換
   - 重複処理を防ぐマーカーシステム

## 今後の拡張予定

### 1. LLMによる「同項」解析
- Ollama/Mistralを使用した文脈解析
- 参照先の自動特定
- 信頼度スコアの付与

### 2. 章・節・款へのナビゲーション
- 法令構造全体のアンカーリンク
- 目次からの直接ジャンプ

### 3. 参照グラフの可視化
- 法令間の参照関係をグラフ表示
- 循環参照の検出

### 4. 参照キャッシュシステム
- LLM解析結果の永続化
- 高速な参照解決

## 技術的制約

1. **項数の推定**
   - 現在は最大10項と仮定
   - 実際の項数は動的に取得する必要あり

2. **外部法令の識別**
   - 法令名の完全一致または部分一致で判定
   - より正確な法令ID管理が必要

3. **複雑な参照パターン**
   - 「前各号」「第一項各号」などの複数参照
   - 括弧内の参照の処理

## 参考資料

- e-Gov法令検索: https://laws.e-gov.go.jp
- 法令標準XMLスキーマ: https://elaws.e-gov.go.jp/file/XMLSchemaForJapaneseLaw_v3.xsd