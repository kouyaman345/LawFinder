# LawFinder 参照検出仕様書

**最終更新**: 2025年8月16日  
**バージョン**: 2.0

## 概要

LawFinderは日本の法令文書内の参照関係を自動検出し、適切にリンク化する機能を提供します。本ドキュメントでは、包括的参照検出エンジン（ComprehensiveReferenceDetector）の詳細仕様と実装方法について説明します。

## 参照タイプと検出仕様

### 1. 内部参照（internal）
- **対象**: 同一法令内の条文・項・号への参照
- **例**: 「第五条」「第十七条第二項」「第三号」
- **信頼度**: 0.95
- **実装**: ARTICLE_PATTERNS, PARAGRAPH_ITEM_PATTERNS

### 2. 外部参照（external）
- **対象**: 他の法令への参照
- **例**: 「民法第五百二十四条」「刑法第百条」
- **信頼度**: 0.85
- **実装**: EXTERNAL_LAW_PATTERNS

### 3. 相対参照（relative）
- **対象**: 相対的な位置関係を示す参照
- **例**: 「前項」「次項」「同項」「前条」「次条」
- **信頼度**: 0.90
- **実装**: RELATIVE_PATTERNS（動的距離計算対応）

### 4. 範囲参照（range）
- **対象**: 複数条文・項目の範囲指定
- **例**: 「第一条から第五条まで」「第一号乃至第三号」
- **信頼度**: 0.85
- **実装**: RANGE_PATTERNS

### 5. 列挙参照（multiple）
- **対象**: 複数条文・項目の列挙
- **例**: 「第一条、第三条及び第五条」
- **信頼度**: 0.80
- **実装**: MULTIPLE_PATTERNS

### 6. 構造参照（structural）
- **対象**: 編・章・節・款・目への参照
- **例**: 「第五章」「前章」「この節」
- **信頼度**: 0.85
- **実装**: STRUCTURE_PATTERNS

### 7. 準用・適用参照（application）
- **対象**: 準用・適用・読替規定
- **例**: 「前項の規定を準用する」「～の規定を適用する」
- **信頼度**: 0.75
- **実装**: APPLICATION_PATTERNS

## 参照検出パターン

### 正規表現パターン

```javascript
const patterns = [
  // 条文＋項の参照（第十七条第二項など）
  { regex: /第([０-９0-9一二三四五六七八九十百千]+)条第([０-９0-9一二三四五六七八九十]+)項/g, type: 'INTERNAL_REFERENCE' },
  
  // 条文のみの参照
  { regex: /第([０-９0-9一二三四五六七八九十百千]+)条(?!第)/g, type: 'INTERNAL_REFERENCE' },
  
  // 章の参照（第五章、次章など）
  { regex: /第([０-９0-9一二三四五六七八九十百千]+)章/g, type: 'CHAPTER_REFERENCE' },
  { regex: /前章|次章/g, type: 'RELATIVE_CHAPTER_REFERENCE' },
  
  // 外部法令への参照
  { regex: /(法令名).*?第([０-９0-9一二三四五六七八九十百千]+)条/g, type: 'EXTERNAL_REFERENCE' },
  
  // 相対参照（前条、次条など）
  { regex: /前条|次条/g, type: 'RELATIVE_ARTICLE_REFERENCE' },
  { regex: /前項|次項|同項|同条/g, type: 'RELATIVE_REFERENCE' },
  
  // 複合参照
  { regex: /同項第([０-９0-9一二三四五六七八九十]+)号/g, type: 'COMPLEX_REFERENCE' },
  { regex: /前項第([０-９0-9一二三四五六七八九十]+)号/g, type: 'COMPLEX_REFERENCE' }
];
```

## 漢数字変換仕様

### 変換アルゴリズム

1. **基本漢数字の変換**
   - 一〜九: 1〜9
   - 十: 10
   - 百: 100
   - 千: 1000

2. **複合漢数字の処理**
   - 「二十二」→ 22
   - 「百二十三」→ 123
   - 「千五百」→ 1500

3. **全角数字の処理**
   - 全角数字（０-９）を半角数字（0-9）に変換

## リンク生成仕様

### アンカーID規則

1. **条文**: `#art{条文番号}`
   - 例: 第12条 → `#art12`

2. **項**: `#art{条文番号}-para{項番号}`
   - 例: 第12条第2項 → `#art12-para2`

3. **外部法令**: `{法令ID}.html#art{条文番号}`
   - 例: 民法第524条 → `129AC0000000089.html#art524`

### 相対参照の解決

1. **前条・次条**
   - 現在の条文番号 ± 1
   - 例: 第12条の「前条」→ `#art11`

2. **前項・次項**
   - 現在の項番号 ± 1
   - 例: 第12条第2項の「前項」→ `#art12-para1`

3. **同項**（LLM実装予定）
   - 文脈から参照先を特定
   - 直前に言及された項を追跡
   - 例: 「第17条第2項の規定により...同項の場合」→ `#art17-para2`

## 処理フロー

1. **Phase 1: 法令データの読み込み**
   - XMLファイルから法令構造を解析
   - 条文・項・号の階層構造を保持

2. **Phase 2: 参照関係の抽出**
   - 各条文のテキストから参照パターンを検出
   - 参照タイプを分類

3. **Phase 3: HTMLファイルの生成**
   - 参照をリンクまたはハイライトに変換
   - 重複処理を防ぐマーカーシステム

## 現在の課題と改善計画

### 検出精度の課題

1. **大規模漢数字の変換**
   - 問題: 「七百九条」「千二十三条」が正しく変換されない
   - 対策: kanjiToNumber関数の拡張

2. **複数項目参照**
   - 問題: 「前三項」「第一項各号」が未対応
   - 対策: RELATIVE_PATTERNSの拡張

3. **括弧内参照**
   - 問題: 「（第十条を除く。）」が検出されない
   - 対策: 括弧内テキストの特別処理

4. **文脈依存参照**
   - 問題: 「同項」「同号」の参照先が不明確
   - 対策: LLMによる文脈解析の実装

### 改善計画

1. **Phase 1: 基本精度向上**（実施中）
   - 漢数字変換ロジックの改善
   - パターンマッチングの拡張
   - テストケースの充実

2. **Phase 2: LLM統合**
   - Ollama/Mistralによる文脈解析
   - 信頼度スコアリング
   - 曖昧性の解消

3. **Phase 3: グラフ分析**
   - Neo4jへの参照関係格納
   - 参照グラフの可視化
   - はね改正影響分析

## 技術的制約

1. **項数の推定**
   - 現在は最大10項と仮定
   - 実際の項数は動的に取得する必要あり

2. **外部法令の識別**
   - 法令名の完全一致または部分一致で判定
   - より正確な法令ID管理が必要

3. **複雑な参照パターン**
   - 「前各号」「第一項各号」などの複数参照
   - 括弧内の参照の処理

## 参考資料

- e-Gov法令検索: https://laws.e-gov.go.jp
- 法令標準XMLスキーマ: https://elaws.e-gov.go.jp/file/XMLSchemaForJapaneseLaw_v3.xsd