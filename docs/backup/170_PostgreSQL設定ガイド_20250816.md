# PostgreSQL設定ガイド

**作成日**: 2025年8月16日  
**プロジェクト**: LawFinder

## 問題の概要

LawFinderプロジェクトはPostgreSQLを使用するよう設計されていますが、現在のシステムでPostgreSQLの認証設定に問題があり、データベース接続ができない状況です。

## 必要な手動設定

以下の手順を**ターミナルで手動で実行**してください：

### 方法1: パスワード認証を使用（推奨）

```bash
# 1. PostgreSQLにpostgresユーザーとして接続
sudo -u postgres psql

# 2. 以下のSQLコマンドを順番に実行
CREATE USER lawfinder WITH PASSWORD 'lawfinder123';
CREATE DATABASE lawfinder OWNER lawfinder;
GRANT ALL PRIVILEGES ON DATABASE lawfinder TO lawfinder;
\q

# 3. 接続テスト（新しいターミナルで）
PGPASSWORD=lawfinder123 psql -U lawfinder -h localhost -d lawfinder -c "SELECT 1;"
```

### 方法2: 既存のpostgresユーザーを使用

```bash
# 1. postgresユーザーとしてデータベースを作成
sudo -u postgres createdb lawfinder

# 2. .envファイルを編集
# DATABASE_URL=postgresql://postgres@localhost/lawfinder
```

### 方法3: 現在のユーザーでデータベースを作成

```bash
# 1. 現在のユーザー用のPostgreSQLロールを作成
sudo -u postgres createuser --superuser $USER

# 2. データベースを作成
createdb lawfinder

# 3. .envファイルを編集
# DATABASE_URL=postgresql://$USER@localhost/lawfinder
```

## 設定後の手順

1. **`.env`ファイルの更新**
   ```
   DATABASE_URL=postgresql://lawfinder:lawfinder123@localhost:5432/lawfinder
   ```

2. **Prismaマイグレーションの実行**
   ```bash
   npx prisma migrate dev
   ```

3. **開発サーバーの再起動**
   ```bash
   npm run dev
   ```

## 一時的な回避策（SQLite使用）

PostgreSQLの設定が困難な場合、開発環境では一時的にSQLiteを使用できます：

1. **`.env`ファイルを編集**
   ```
   DATABASE_URL=file:./dev.db
   ```

2. **`prisma/schema.prisma`を編集**
   ```prisma
   datasource db {
     provider = "sqlite"
     url      = env("DATABASE_URL")
   }
   ```

3. **マイグレーション実行**
   ```bash
   npx prisma migrate dev
   ```

## トラブルシューティング

### エラー: "FATAL: password authentication failed"
- パスワードが正しくない、またはユーザーが存在しない
- 解決: 上記の手順でユーザーとデータベースを作成

### エラー: "FATAL: role does not exist"
- PostgreSQLユーザーが存在しない
- 解決: `sudo -u postgres createuser` でユーザーを作成

### エラー: "FATAL: Peer authentication failed"
- Unixソケット経由の認証に失敗
- 解決: `-h localhost` を追加してTCP/IP接続を使用

## 推奨事項

本番環境ではPostgreSQLが必須ですが、開発環境では以下の選択肢があります：

1. **PostgreSQL**（推奨）: 本番環境と同じ構成
2. **SQLite**: 簡単なセットアップ、単一ファイル
3. **Docker PostgreSQL**: 環境を汚さない、簡単に削除可能

## 参考リンク

- [PostgreSQL公式ドキュメント](https://www.postgresql.org/docs/)
- [Prisma PostgreSQL設定](https://www.prisma.io/docs/concepts/database-connectors/postgresql)