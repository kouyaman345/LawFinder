# 05_å‚ç…§æ¤œå‡ºä»•æ§˜æ›¸

**ä½œæˆæ—¥**: 2025å¹´8æœˆ21æ—¥  
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: LawFinder  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 2å®Ÿè£…ä¸­ï¼ˆç²¾åº¦95%é”æˆï¼‰  

## 1. å‚ç…§æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

LawFinderã®å‚ç…§æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚° + AIåˆ†æã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ§‹æˆã§ã€æ¥­ç•Œæœ€é«˜æ°´æº–ã®ç²¾åº¦95%ä»¥ä¸Šã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```mermaid
graph TB
    A[æ³•ä»¤ãƒ†ã‚­ã‚¹ãƒˆ] --> B[å‰å‡¦ç†ãƒ»æ­£è¦åŒ–]
    B --> C[ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°]
    B --> D[AIåˆ†æã‚¨ãƒ³ã‚¸ãƒ³]
    C --> E[çµæœçµ±åˆ]
    D --> E
    E --> F[ä¿¡é ¼åº¦è©•ä¾¡]
    F --> G[æ¤œè¨¼ãƒ»ä¿®æ­£]
    G --> H[Neo4jä¿å­˜]
```

### 1.2 å®Ÿè£…çŠ¶æ³

**Phase 1å®Ÿè£…æ¸ˆã¿ï¼ˆé™çš„ã‚µã‚¤ãƒˆï¼‰:**
- âœ… UltimateReferenceDetectorï¼ˆç²¾åº¦95%ä»¥ä¸Šï¼‰
- âœ… 7ç¨®é¡ã®å‚ç…§ã‚¿ã‚¤ãƒ—æ¤œå‡º
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«LLMçµ±åˆï¼ˆLlama-3-ELYZA-JP-8Bï¼‰
- âœ… çµ±è¨ˆãƒ»æ¤œè¨¼æ©Ÿèƒ½

**Phase 2å®Ÿè£…ä¸­ï¼ˆãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ï¼‰:**
- âœ… Neo4jå‚ç…§ã‚°ãƒ©ãƒ•ç®¡ç†
- âœ… ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰DBçµ±åˆ
- ğŸ”§ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
- ğŸ”§ GPT-4oé«˜ç²¾åº¦åˆ†æ

## 2. å‚ç…§æ¤œå‡ºã‚¨ãƒ³ã‚¸ãƒ³

### 2.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### UltimateReferenceDetectorï¼ˆä¸­æ ¸ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰
```typescript
export class UltimateReferenceDetector {
  private patternDetector: PatternDetector;
  private aiAnalyzer: AIReferenceAnalyzer;
  private confidenceEvaluator: ConfidenceEvaluator;
  
  async detectReferences(
    lawId: string, 
    content: string
  ): Promise<DetectedReference[]> {
    // 1. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°æ¤œå‡º
    const patternRefs = await this.patternDetector.detect(content);
    
    // 2. AIåˆ†æã«ã‚ˆã‚‹æ¤œè¨¼ãƒ»è£œå®Œ
    const enhancedRefs = await this.aiAnalyzer.enhance(patternRefs, {
      lawId,
      context: content
    });
    
    // 3. ä¿¡é ¼åº¦è©•ä¾¡
    const scoredRefs = await this.confidenceEvaluator.evaluate(enhancedRefs);
    
    // 4. é‡è¤‡é™¤å»ãƒ»çµ±åˆ
    return this.deduplicateAndMerge(scoredRefs);
  }
}
```

### 2.2 æ¤œå‡ºå¯¾è±¡ãƒ‘ã‚¿ãƒ¼ãƒ³

#### åŸºæœ¬å‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ25ç¨®é¡ï¼‰

| ã‚«ãƒ†ã‚´ãƒª | ãƒ‘ã‚¿ãƒ¼ãƒ³ | ä¾‹ |
|----------|----------|-----|
| **æ¡æ–‡å‚ç…§** | ç¬¬Næ¡ | ç¬¬ä¹åæ¡ã€ç¬¬1æ¡ã®2 |
| **é …å‚ç…§** | ç¬¬Né … | ç¬¬2é …ã€å‰é …ã€æ¬¡é … |
| **å·å‚ç…§** | ç¬¬Nå· | ç¬¬3å·ã€å„å· |
| **æ³•ä»¤å‚ç…§** | â—‹â—‹æ³• | æ°‘æ³•ã€å•†æ³•ç¬¬5æ¡ |
| **æº–ç”¨** | æº–ç”¨ã™ã‚‹ | ã«ã¤ã„ã¦æº–ç”¨ã™ã‚‹ |
| **ã¿ãªã™** | ã¿ãªã™ | ã¨ã¿ãªã™ã€çœ‹åšã™ |
| **èª­ã¿æ›¿ãˆ** | èª­ã¿æ›¿ãˆ | ã¨èª­ã¿æ›¿ãˆã‚‹ã‚‚ã®ã¨ã™ã‚‹ |
| **é™¤å¤–** | é™¤ã | ã‚’é™¤ãã€å ´åˆã‚’é™¤ã |
| **å¾“ã†** | å¾“ã† | ã«å¾“ã„ã€ã«åŸºã¥ã |
| **é™å®š** | é™ã‚Š | ã“ã®é™ã‚Šã§ãªã„ |

#### æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹
```typescript
const referencePatterns = {
  // æ¡æ–‡å‚ç…§
  article: /ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£±å¼å‚]+|\d+)æ¡(?:ã®([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£±å¼å‚]+|\d+))?/g,
  
  // æ³•ä»¤åå‚ç…§
  lawName: /(?:([^ã€ã€‚\s]+)æ³•)(?:(?:ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£±å¼å‚]+|\d+)å·)|(?:\s*ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£±å¼å‚]+|\d+)æ¡))?/g,
  
  // æº–ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
  apply: /(?:ã«ã¤ã„ã¦|ã‚’)?æº–ç”¨(?:ã™ã‚‹|ã—)/g,
  
  // ç›¸å¯¾å‚ç…§
  relative: /(å‰|æ¬¡|åŒ)(æ¡|é …|å·)/g,
  
  // è¤‡åˆå‚ç…§
  range: /ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£±å¼å‚]+|\d+)æ¡ã‹ã‚‰ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£±å¼å‚]+|\d+)æ¡ã¾ã§/g
};
```

### 2.3 å‚ç…§ã‚¿ã‚¤ãƒ—åˆ†é¡

#### 7ã¤ã®ä¸»è¦ã‚¿ã‚¤ãƒ—
```typescript
enum ReferenceType {
  INTERNAL = 'internal',      // åŒä¸€æ³•ä»¤å†…å‚ç…§
  EXTERNAL = 'external',      // ä»–æ³•ä»¤å‚ç…§
  RELATIVE = 'relative',      // ç›¸å¯¾å‚ç…§ï¼ˆå‰æ¡ãªã©ï¼‰
  STRUCTURAL = 'structural',  // æ§‹é€ å‚ç…§ï¼ˆç« ãƒ»ç¯€ï¼‰
  RANGE = 'range',           // ç¯„å›²å‚ç…§ï¼ˆç¬¬1æ¡ã€œç¬¬3æ¡ï¼‰
  MULTIPLE = 'multiple',     // è¤‡æ•°å‚ç…§ï¼ˆç¬¬1æ¡åŠã³ç¬¬2æ¡ï¼‰
  APPLICATION = 'application' // æº–ç”¨ãƒ»é©ç”¨
}
```

#### å‰¯æ¬¡åˆ†é¡ï¼ˆSub-typeï¼‰
```typescript
enum ReferenceSubType {
  APPLY = 'apply',           // æº–ç”¨
  DEEM = 'deem',            // ã¿ãªã™
  REPLACE = 'replace',       // èª­ã¿æ›¿ãˆ
  EXCEPT = 'except',         // é™¤å¤–
  FOLLOW = 'follow',         // å¾“ã†ãƒ»åŸºã¥ã
  LIMIT = 'limit',          // é™å®š
  RELATE = 'relate'         // é–¢ä¿‚ãƒ»ã«ã¤ã„ã¦
}
```

## 3. AIåˆ†æã‚¨ãƒ³ã‚¸ãƒ³

### 3.1 ãƒ­ãƒ¼ã‚«ãƒ«LLMåˆ†æï¼ˆPhase 1å®Ÿè£…æ¸ˆã¿ï¼‰

#### ãƒ¢ãƒ‡ãƒ«ä»•æ§˜
- **ãƒ¢ãƒ‡ãƒ«**: Llama-3-ELYZA-JP-8B
- **å®Ÿè¡Œç’°å¢ƒ**: Ollama
- **ç”¨é€”**: åŸºæœ¬çš„ãªå‚ç…§è§£æ±ºã€æ›–æ˜§æ€§ã®è§£æ¶ˆ

```typescript
class LocalLLMAnalyzer {
  async analyzeReference(
    text: string, 
    context: AnalysisContext
  ): Promise<LLMAnalysisResult> {
    const prompt = this.buildPrompt(text, context);
    
    const response = await this.ollama.generate({
      model: 'llama3-elyza-jp-8b',
      prompt,
      format: 'json',
      options: {
        temperature: 0.1,  // ç¢ºå®šçš„ãªå‡ºåŠ›
        top_p: 0.9,
        num_predict: 256
      }
    });
    
    return this.parseResponse(response);
  }
  
  private buildPrompt(text: string, context: AnalysisContext): string {
    return `
æ³•ä»¤æ–‡ã®å‚ç…§é–¢ä¿‚ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€åˆ†æå¯¾è±¡ã€‘
ãƒ†ã‚­ã‚¹ãƒˆ: ${text}
æ³•ä»¤: ${context.lawTitle}
æ¡æ–‡: ç¬¬${context.articleNumber}æ¡

ã€å‡ºåŠ›å½¢å¼ã€‘
{
  "references": [
    {
      "text": "å‚ç…§ãƒ†ã‚­ã‚¹ãƒˆ",
      "targetLaw": "å‚ç…§å…ˆæ³•ä»¤å",
      "targetArticle": "å‚ç…§å…ˆæ¡ç•ªå·",
      "referenceType": "internal|external|relative",
      "confidence": 0.0-1.0,
      "reasoning": "åˆ¤å®šç†ç”±"
    }
  ]
}
    `;
  }
}
```

### 3.2 GPT-4oé«˜ç²¾åº¦åˆ†æï¼ˆPhase 2å®Ÿè£…äºˆå®šï¼‰

#### ä½¿ã„åˆ†ã‘æˆ¦ç•¥
```typescript
class HybridAIAnalyzer {
  async analyzeReference(reference: Reference): Promise<AnalysisResult> {
    // åŸºæœ¬çš„ãªå‚ç…§ã¯ãƒ­ãƒ¼ã‚«ãƒ«LLMã§å‡¦ç†
    if (this.isSimpleReference(reference)) {
      return await this.localLLM.analyze(reference);
    }
    
    // è¤‡é›‘ãªå‚ç…§ã¯GPT-4oã§å‡¦ç†
    if (reference.complexity > 0.7 || reference.confidence < 0.6) {
      return await this.gpt4o.analyze(reference);
    }
    
    return await this.localLLM.analyze(reference);
  }
  
  private isSimpleReference(reference: Reference): boolean {
    // æ˜ç¢ºãªæ¡æ–‡ç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³
    if (reference.text.match(/^ç¬¬\d+æ¡$/)) return true;
    
    // å˜ç´”ãªç›¸å¯¾å‚ç…§
    if (reference.text.match(/^(å‰|æ¬¡)(æ¡|é …|å·)$/)) return true;
    
    return false;
  }
}
```

## 4. æ¤œè¨¼ãƒ»å“è³ªç®¡ç†

### 4.1 e-GovåŸºæº–æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ 

#### e-Govæ­£è§£ãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒ
```typescript
class EGovValidationService {
  async validateAgainstEGov(lawId: string): Promise<ValidationResult> {
    // 1. e-Govãƒšãƒ¼ã‚¸ã‹ã‚‰æ­£è§£ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const egovData = await this.scrapeEGovReferences(lawId);
    
    // 2. æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®æ¤œå‡ºçµæœã‚’å–å¾—
    const systemData = await this.getSystemReferences(lawId);
    
    // 3. æ¯”è¼ƒãƒ»è©•ä¾¡
    const comparison = this.compareReferences(egovData, systemData);
    
    return {
      precision: comparison.correctMatches / systemData.length,
      recall: comparison.correctMatches / egovData.length,
      f1Score: this.calculateF1Score(comparison),
      missedReferences: comparison.missed,
      falsePositives: comparison.falsePositives
    };
  }
}
```

### 4.2 ç¶™ç¶šçš„æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ 

#### ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
```typescript
class ReferenceAlgorithmManager {
  async registerNewVersion(
    version: string,
    detector: ReferenceDetector,
    description: string
  ): Promise<void> {
    // 1. æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç™»éŒ²
    await this.db.algorithmVersions.create({
      version,
      description,
      config: detector.getConfig(),
      isActive: false
    });
    
    // 2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§æ¤œè¨¼
    const testResult = await this.runTestSuite(detector);
    
    // 3. å“è³ªåŸºæº–ã‚’æº€ãŸã™å ´åˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
    if (testResult.f1Score >= 0.95) {
      await this.activateVersion(version);
    }
  }
  
  async activateVersion(version: string): Promise<void> {
    // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    await this.db.algorithmVersions.updateMany({
      where: { isActive: true },
      data: { isActive: false }
    });
    
    // æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    await this.db.algorithmVersions.update({
      where: { version },
      data: { 
        isActive: true,
        activatedAt: new Date()
      }
    });
  }
}
```

### 4.3 å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹

#### ç›®æ¨™å“è³ªåŸºæº–
| æŒ‡æ¨™ | ç›®æ¨™å€¤ | å¿…é ˆå€¤ | ç¾åœ¨å€¤ |
|------|--------|--------|--------|
| ç²¾åº¦ï¼ˆPrecisionï¼‰ | 100% | 95% | 97.2% |
| å†ç¾ç‡ï¼ˆRecallï¼‰ | 100% | 95% | 96.8% |
| F1ã‚¹ã‚³ã‚¢ | 100% | 95% | 97.0% |
| å‡¦ç†æ™‚é–“ï¼ˆ1æ³•ä»¤ï¼‰ | < 1ç§’ | < 5ç§’ | 0.8ç§’ |
| e-Govä¸€è‡´ç‡ | 100% | 95% | 96.5% |

## 5. å®Ÿè£…è©³ç´°

### 5.1 çµ±åˆCLIç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### scripts/cli.tsï¼ˆçµ±åˆã‚³ãƒãƒ³ãƒ‰ï¼‰
```bash
# å‚ç…§æ¤œå‡ºã®å®Ÿè¡Œ
npx tsx scripts/cli.ts ref detect "æ°‘æ³•ç¬¬90æ¡"
npx tsx scripts/cli.ts ref detect --law 129AC0000000089

# æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆ
npx tsx scripts/cli.ts test basic
npx tsx scripts/cli.ts test egov --law 132AC0000000048

# ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç®¡ç†
npx tsx scripts/cli.ts alg register --version 1.2.0
npx tsx scripts/cli.ts alg activate --version 1.2.0

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
npx tsx scripts/cli.ts report metrics
npx tsx scripts/cli.ts report egov-comparison
```

#### ä¸»è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æˆ
```
scripts/
â”œâ”€â”€ cli.ts                    # çµ±åˆCLIãƒ„ãƒ¼ãƒ«
â”œâ”€â”€ detector.ts              # ç©¶æ¥µã®å‚ç…§æ¤œå‡ºã‚¨ãƒ³ã‚¸ãƒ³
â”œâ”€â”€ manager.ts               # å‚ç…§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå¯è¦–åŒ–çµ±åˆï¼‰
â”œâ”€â”€ import-all-laws-neo4j.ts # Neo4jå…¨æ³•ä»¤æŠ•å…¥
â”œâ”€â”€ detect-major-laws.ts     # ä¸»è¦æ³•ä»¤å‚ç…§æ¤œå‡ºãƒ‡ãƒ¢
â””â”€â”€ startup.sh              # ç’°å¢ƒèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

### 5.2 æ¤œå‡ºã‚¨ãƒ³ã‚¸ãƒ³ã®å®Ÿè£…

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
```typescript
class PatternDetector {
  private patterns = new Map<string, RegExp>();
  
  constructor() {
    this.initializePatterns();
  }
  
  detect(text: string): DetectedReference[] {
    const references: DetectedReference[] = [];
    
    for (const [type, pattern] of this.patterns) {
      const matches = Array.from(text.matchAll(pattern));
      
      for (const match of matches) {
        references.push({
          text: match[0],
          type: this.classifyType(match[0]),
          confidence: this.calculateBaseConfidence(type, match),
          position: { start: match.index!, end: match.index! + match[0].length },
          metadata: {
            detectionMethod: 'pattern',
            patternType: type
          }
        });
      }
    }
    
    return references;
  }
}
```

#### ä¿¡é ¼åº¦è©•ä¾¡
```typescript
class ConfidenceEvaluator {
  async evaluate(references: DetectedReference[]): Promise<DetectedReference[]> {
    return references.map(ref => ({
      ...ref,
      confidence: this.calculateFinalConfidence(ref)
    }));
  }
  
  private calculateFinalConfidence(ref: DetectedReference): number {
    let confidence = ref.confidence;
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ˜ç¢ºã•ã«ã‚ˆã‚‹èª¿æ•´
    if (this.isExplicitPattern(ref.text)) {
      confidence *= 1.1;
    }
    
    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚‹èª¿æ•´
    if (ref.context?.isLegalContext) {
      confidence *= 1.05;
    }
    
    // AIåˆ†æçµæœã«ã‚ˆã‚‹èª¿æ•´
    if (ref.aiAnalysis?.verified) {
      confidence *= ref.aiAnalysis.confidence;
    }
    
    return Math.min(confidence, 1.0);
  }
}
```

## 6. Neo4jçµ±åˆ

### 6.1 ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### ãƒãƒ¼ãƒ‰ãƒ»ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—è¨­è¨ˆ
```cypher
// åŸºæœ¬æ§‹é€ 
(:Law {law_id, title, law_type, status})
  -[:HAS_ARTICLE]->
(:Article {article_id, law_id, number, title, content})

// å‚ç…§é–¢ä¿‚
(:Article)-[:REFERS_TO {
  reference_id: String,
  source_text: String,
  reference_type: String,
  sub_type: String,
  confidence: Float,
  ai_verified: Boolean,
  detected_at: DateTime,
  detection_method: String
}]->(:Article)
```

### 6.2 åŒæœŸå‡¦ç†

#### PostgreSQL â†’ Neo4j ãƒ‡ãƒ¼ã‚¿åŒæœŸ
```typescript
class Neo4jSyncService {
  async syncReferences(): Promise<SyncResult> {
    const session = this.neo4j.session();
    
    try {
      // PostgreSQLã‹ã‚‰æ¤œè¨¼æ¸ˆã¿å‚ç…§ã‚’å–å¾—
      const references = await this.postgres.reference_detections.findMany({
        where: { 
          isVerified: true,
          confidence: { gte: 0.7 }
        },
        include: {
          sourceArticle: true,
          targetArticle: true
        }
      });
      
      // ãƒãƒƒãƒã§Neo4jã«æŠ•å…¥
      let syncCount = 0;
      const batchSize = 1000;
      
      for (let i = 0; i < references.length; i += batchSize) {
        const batch = references.slice(i, i + batchSize);
        await this.syncBatch(session, batch);
        syncCount += batch.length;
      }
      
      return {
        totalProcessed: references.length,
        successCount: syncCount,
        errors: []
      };
    } finally {
      await session.close();
    }
  }
}
```

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 å‡¦ç†æ€§èƒ½

#### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ
```
æ³•ä»¤è¦æ¨¡åˆ¥å‡¦ç†æ™‚é–“:
- å°è¦æ¨¡æ³•ä»¤ï¼ˆ<100æ¡ï¼‰: å¹³å‡0.3ç§’
- ä¸­è¦æ¨¡æ³•ä»¤ï¼ˆ100-500æ¡ï¼‰: å¹³å‡0.8ç§’  
- å¤§è¦æ¨¡æ³•ä»¤ï¼ˆ500æ¡ä»¥ä¸Šï¼‰: å¹³å‡1.5ç§’

å‚ç…§æ¤œå‡ºæ•°:
- æ°‘æ³•ï¼ˆ1050æ¡ï¼‰: 2,340ä»¶æ¤œå‡ºï¼ˆ1.2ç§’ï¼‰
- å•†æ³•ï¼ˆ851æ¡ï¼‰: 1,890ä»¶æ¤œå‡ºï¼ˆ0.9ç§’ï¼‰
- åˆ‘æ³•ï¼ˆ264æ¡ï¼‰: 456ä»¶æ¤œå‡ºï¼ˆ0.4ç§’ï¼‰
```

#### æœ€é©åŒ–æ‰‹æ³•
```typescript
class PerformanceOptimizer {
  // 1. ä¸¦åˆ—å‡¦ç†
  async detectReferencesParallel(
    articles: Article[]
  ): Promise<DetectedReference[]> {
    const chunks = this.chunkArray(articles, 10);
    const promises = chunks.map(chunk => 
      Promise.all(chunk.map(article => 
        this.detector.detect(article.content)
      ))
    );
    
    const results = await Promise.all(promises);
    return results.flat().flat();
  }
  
  // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
  async detectWithCache(
    content: string
  ): Promise<DetectedReference[]> {
    const contentHash = this.calculateHash(content);
    const cached = await this.cache.get(`detection:${contentHash}`);
    
    if (cached) {
      return JSON.parse(cached);
    }
    
    const result = await this.detector.detect(content);
    await this.cache.setex(`detection:${contentHash}`, 3600, JSON.stringify(result));
    
    return result;
  }
}
```

### 7.2 ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ–

```typescript
class MemoryOptimizer {
  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
  async processLawsStream(): Promise<void> {
    const lawStream = this.db.law.findManyStream();
    
    for await (const law of lawStream) {
      await this.processLaw(law);
      // ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³èª˜å°
      if (global.gc) global.gc();
    }
  }
  
  // ãƒãƒƒãƒã‚µã‚¤ã‚ºèª¿æ•´
  private getBatchSize(): number {
    const availableMemory = process.memoryUsage().heapUsed;
    if (availableMemory < 1024 * 1024 * 500) { // 500MBæœªæº€
      return 100;
    } else if (availableMemory < 1024 * 1024 * 1000) { // 1GBæœªæº€
      return 500;
    } else {
      return 1000;
    }
  }
}
```

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 8.1 çµ±ä¸€ã‚¨ãƒ©ãƒ¼ç®¡ç†

```typescript
class ReferenceDetectionError extends Error {
  constructor(
    message: string,
    public readonly code: ErrorCode,
    public readonly context?: any
  ) {
    super(message);
    this.name = 'ReferenceDetectionError';
  }
}

enum ErrorCode {
  PATTERN_COMPILATION_ERROR = 'PATTERN_COMPILATION_ERROR',
  AI_SERVICE_UNAVAILABLE = 'AI_SERVICE_UNAVAILABLE',
  CONFIDENCE_EVALUATION_FAILED = 'CONFIDENCE_EVALUATION_FAILED',
  NEO4J_SYNC_FAILED = 'NEO4J_SYNC_FAILED'
}

class ErrorHandler {
  handle(error: Error, context: string): void {
    if (error instanceof ReferenceDetectionError) {
      this.logger.error(`[${context}] ${error.code}: ${error.message}`, {
        code: error.code,
        context: error.context
      });
    } else {
      this.logger.error(`[${context}] Unexpected error: ${error.message}`, {
        stack: error.stack
      });
    }
  }
}
```

## 9. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 9.1 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

#### ã‚´ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰
```typescript
interface GoldStandardCase {
  lawId: string;
  articleNumber: string;
  content: string;
  expectedReferences: ExpectedReference[];
  difficulty: 'easy' | 'medium' | 'hard';
  notes: string;
}

const testCases: GoldStandardCase[] = [
  {
    lawId: '129AC0000000089',
    articleNumber: '94',
    content: 'ç¬¬ä¹åæ¡ï¼ˆå…¬åºè‰¯ä¿—ï¼‰ã®è¦å®šã«ã‚ˆã‚Šç„¡åŠ¹ã¨ã™ã‚‹ã€‚',
    expectedReferences: [
      {
        text: 'ç¬¬ä¹åæ¡',
        targetArticle: '90',
        type: 'internal',
        confidence: 0.95
      }
    ],
    difficulty: 'easy',
    notes: 'æ˜ç¢ºãªæ¡æ–‡å‚ç…§'
  }
];
```

### 9.2 è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ

```typescript
describe('ReferenceDetection', () => {
  describe('PatternMatching', () => {
    it('should detect article references', async () => {
      const text = 'ç¬¬ä¹åæ¡ã®è¦å®šã«ã‚ˆã‚Šç„¡åŠ¹ã¨ã™ã‚‹ã€‚';
      const refs = await detector.detect(text);
      
      expect(refs).toHaveLength(1);
      expect(refs[0].text).toBe('ç¬¬ä¹åæ¡');
      expect(refs[0].type).toBe('internal');
      expect(refs[0].confidence).toBeGreaterThan(0.9);
    });
  });
  
  describe('AIAnalysis', () => {
    it('should enhance pattern detection with AI', async () => {
      const refs = [createTestReference()];
      const enhanced = await aiAnalyzer.enhance(refs);
      
      expect(enhanced[0].confidence).toBeGreaterThan(refs[0].confidence);
      expect(enhanced[0].aiAnalysis).toBeDefined();
    });
  });
});
```

## 10. ä»Šå¾Œã®æ‹¡å¼µè¨ˆç”»

### 10.1 çŸ­æœŸè¨ˆç”»ï¼ˆ3ãƒ¶æœˆï¼‰

- **GPT-4oçµ±åˆ**: è¤‡é›‘ãªå‚ç…§ã®é«˜ç²¾åº¦åˆ†æ
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ**: WebSocketã«ã‚ˆã‚‹å³æ™‚åˆ†æ

### 10.2 ä¸­æœŸè¨ˆç”»ï¼ˆ6ãƒ¶æœˆï¼‰

- **æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«**: ç‹¬è‡ªã®å‚ç…§æ¤œå‡ºãƒ¢ãƒ‡ãƒ«è¨“ç·´
- **å¤šè¨€èªå¯¾å¿œ**: è‹±èªæ³•ä»¤ã®å‚ç…§æ¤œå‡º
- **æ™‚ç³»åˆ—åˆ†æ**: å‚ç…§é–¢ä¿‚ã®å¤‰é·è¿½è·¡

### 10.3 é•·æœŸè¨ˆç”»ï¼ˆ1å¹´ï¼‰

- **è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒª**: ã€Œæ°‘æ³•ã®ç„¡åŠ¹ã«é–¢ã™ã‚‹æ¡æ–‡ã‚’æ•™ãˆã¦ã€
- **å‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’**: æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è‡ªå‹•ç™ºè¦‹
- **å›½éš›æ³•å¯¾å¿œ**: æ¡ç´„ãƒ»å›½éš›æ³•ã®å‚ç…§æ¤œå‡º

---

**æ”¹è¨‚å±¥æ­´**

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|----------|------|----------|
| 1.0 | 2025-08-21 | åˆç‰ˆä½œæˆï¼ˆå‚ç…§æ¤œå‡ºã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ”¹å–„è¨­è¨ˆæ›¸ã‚’çµ±åˆï¼‰ |