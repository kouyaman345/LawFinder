# 参照検出検証ワークフロー

**作成日**: 2025 年 8 月 6 日  
**プロジェクト**: LawFinder  
**目的**: 法令参照検出の抜け漏れを継続的に改善する

## 1. 概要

このワークフローは、法令参照検出アルゴリズムの精度を継続的に向上させるためのサイクルです。

```
[参照検出] → [Neo4j同期] → [HTML生成] → [Claude Code確認] → [フィードバック] → [アルゴリズム改善]
     ↑                                                                                    ↓
     └──────────────────────────────────────────────────────────────────────────────────┘
```

## 2. ワークフローの実行手順

### Step 1: 検証の実行

```bash
# 特定の法令（例：民法）で検証を実行
npm run validation:run 129AC0000000089

# 実行内容：
# - 参照を検出
# - Neo4jに同期
# - HTMLを生成
# - レポートを作成
```

### Step 2: HTML の確認（Claude Code）

生成された HTML ファイルが表示されます。

```
validation-reports/129AC0000000089_generated.html
```

**確認ポイント：**

1. 「第 ○ 条」などの条文参照がリンクになっているか
2. 「前項」「同号」などの相対参照が検出されているか
3. 「民法第 ○ 条」などの外部法令参照が認識されているか
4. 「準用する」「適用する」などの準用関係が検出されているか

### Step 3: 抜け漏れの記録

HTML を読んで、リンクになっていない参照を見つけたら、フィードバックファイルに記録します。

```json
// validation-reports/129AC0000000089_validation_feedback.json
{
  "lawId": "129AC0000000089",
  "timestamp": "2025-08-06T10:00:00.000Z",
  "missedReferences": [
    {
      "text": "第七百九条",
      "context": "第七百九条の規定により...",
      "type": "internal",
      "reason": "漢数字の変換エラー"
    },
    {
      "text": "前三項",
      "context": "前三項の規定は...",
      "type": "relative",
      "reason": "複数項への参照パターン未対応"
    }
  ],
  "notes": "全体的に漢数字の大きな数値（七百以上）の検出率が低い"
}
```

### Step 4: フィードバックの処理

```bash
# フィードバックを処理してアルゴリズム改善提案を生成
npm run validation:feedback 129AC0000000089
```

### Step 5: アルゴリズムの改善

フィードバックを基に `ComprehensiveReferenceDetector.ts` を改善します。

## 3. 主要コンポーネント

### 3.1 ComprehensiveReferenceDetector

- **場所**: `src/domain/services/ComprehensiveReferenceDetector.ts`
- **役割**: 参照パターンの検出
- **改善ポイント**: パターンの追加、信頼度の調整

### 3.2 sync-to-neo4j.ts

- **場所**: `scripts/sync-to-neo4j.ts`
- **役割**: Neo4j への参照関係の同期
- **改善ポイント**: 新しい参照タイプへの対応

### 3.3 reference-validation-workflow.ts

- **場所**: `scripts/reference-validation-workflow.ts`
- **役割**: 検証ワークフローの実行
- **改善ポイント**: レポート機能の拡張

## 4. よくある抜け漏れパターン

### 4.1 漢数字の大きな数値

- **問題**: 「七百九条」「千二十三条」などが検出されない
- **対策**: 漢数字変換ロジックの改善

### 4.2 複数項目への参照

- **問題**: 「前三項」「次の各号」などが検出されない
- **対策**: 複数参照パターンの追加

### 4.3 括弧内の参照

- **問題**: 「（第十条を除く。）」などが検出されない
- **対策**: 括弧内テキストの処理

### 4.4 複雑な準用表現

- **問題**: 「～については、～の規定を準用する」の複雑なパターン
- **対策**: 準用パターンの拡張

## 5. 検証対象の推奨法令

精度向上のため、以下の法令で検証することを推奨：

1. **民法** (129AC0000000089) - 最も参照が多い基本法
2. **会社法** (417AC0000000086) - 複雑な条文構造
3. **刑法** (140AC0000000045) - 準用・適用が多い
4. **商法** (132AC0000000048) - 外部参照が多い

## 6. 改善の追跡

### 改善履歴の記録

```bash
# 改善前後の比較
npm run validation:run 129AC0000000089
# → 検出数: 1,234件

# アルゴリズム改善後
npm run validation:run 129AC0000000089
# → 検出数: 1,456件 （+222件）
```

### 精度メトリクス

- **検出率**: 検出された参照数 / 実際の参照数
- **精度**: 正しい参照数 / 検出された参照数
- **F1 スコア**: 2 × (精度 × 検出率) / (精度 + 検出率)

## 7. トラブルシューティング

### Neo4j が起動していない

```bash
docker-compose up -d
```

### Next.js サーバーが起動していない

```bash
npm run dev
```

### HTML が生成されない

```bash
# 手動でHTMLを取得
curl http://localhost:5000/laws/129AC0000000089 > test.html
```

## 8. 今後の拡張

1. **自動検証**: 定期的に全法令を検証
2. **機械学習**: 見逃しパターンの自動学習
3. **ビジュアライゼーション**: 参照グラフの可視化
4. **レポート生成**: 精度向上レポートの自動生成

## 9. 関連ドキュメント

- [Neo4j データモデル設計書](./140_Neo4jデータモデル設計書_20250806.md)
- [参照検出仕様書](./60_参照検出仕様書.md)
- [ハイブリッド DB 設計根拠書](./150_ハイブリッドDB設計根拠書_20250806.md)
