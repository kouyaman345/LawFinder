# 08_テスト仕様書

**作成日**: 2025年8月21日  
**対象プロジェクト**: LawFinder  
**ステータス**: Phase 2実装中  

## 1. テスト概要

### 1.1 目的

LawFinderシステムの品質保証のため、包括的なテスト戦略を定義し、高品質なシステムの提供を保証する。

### 1.2 テスト方針

- **テスト駆動開発（TDD）**: 新機能開発時はテストファーストで実装
- **継続的テスト**: CI/CDパイプラインでの自動テスト実行
- **シフトレフト**: 開発初期段階からテストを実施
- **リスクベース**: 重要度の高い機能から優先的にテスト

### 1.3 品質目標

| メトリクス | 現在 | 目標 |
|-----------|------|------|
| テストカバレッジ | 40% | 80% |
| テスト成功率 | 95% | 99% |
| 重大バグ | 0件 | 0件 |
| 中程度バグ | 5件以下 | 3件以下 |

## 2. テスト戦略

### 2.1 テストピラミッド

```
         /\
        /  \  E2Eテスト (5%)
       /----\
      /      \  統合テスト (25%)
     /--------\
    /          \  ユニットテスト (70%)
   /____________\
```

### 2.2 テストレベル

| レベル | 説明 | 実施者 | カバレッジ目標 |
|--------|------|--------|----------------|
| ユニットテスト | 個別関数・クラスのテスト | 開発者 | 80%以上 |
| 統合テスト | モジュール間連携のテスト | 開発者/QA | 70%以上 |
| システムテスト | システム全体の機能テスト | QAチーム | 100% |
| 受入テスト | ユーザー要件の確認 | ユーザー/QA | 主要シナリオ100% |

### 2.3 テスト種類

| 種類 | 目的 | 頻度 | 自動化 |
|------|------|------|--------|
| 機能テスト | 機能要件の確認 | 継続的 | 80% |
| 回帰テスト | 既存機能の保証 | リリース前 | 100% |
| パフォーマンステスト | 性能要件の確認 | 週次 | 100% |
| セキュリティテスト | 脆弱性の検出 | 月次 | 70% |
| ユーザビリティテスト | 使いやすさの確認 | リリース前 | 0% |

## 3. ユニットテスト

### 3.1 対象モジュール

- 参照検出エンジン（UltimateReferenceDetector）
- ドメインモデル（Law, Article, Reference）
- ユーティリティ関数
- ビジネスロジック

### 3.2 テストフレームワーク

**使用ツール**: Jest + ts-jest

```typescript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/__tests__/**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/types/**/*'
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 80,
      statements: 80
    }
  }
};
```

### 3.3 テスト実装例

#### 参照検出エンジンのテスト

```typescript
// tests/unit/detector.test.ts
describe('UltimateReferenceDetector', () => {
  let detector: UltimateReferenceDetector;

  beforeEach(() => {
    detector = new UltimateReferenceDetector();
  });

  describe('外部参照の検出', () => {
    it('民法への参照を正しく検出できる', async () => {
      const text = '民法第90条の規定により無効とする。';
      const context = { sourceArticleId: 'test-1', lawId: 'test-law' };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(1);
      expect(references[0].referenceType).toBe('external');
      expect(references[0].referenceText).toBe('民法第90条');
      expect(references[0].confidence).toBeGreaterThan(0.8);
    });

    it('複数の法令参照を検出できる', async () => {
      const text = '民法第90条及び商法第32条の規定により';
      const context = { sourceArticleId: 'test-1', lawId: 'test-law' };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(2);
      expect(references[0].referenceText).toBe('民法第90条');
      expect(references[1].referenceText).toBe('商法第32条');
    });

    it('存在しない法令への参照は検出しない', async () => {
      const text = '存在しない法第1条の規定により';
      const context = { sourceArticleId: 'test-1', lawId: 'test-law' };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(0);
    });
  });

  describe('内部参照の検出', () => {
    it('同一法令内の条文参照を検出できる', async () => {
      const text = '第90条の規定により無効とする。';
      const context = { sourceArticleId: 'test-1', lawId: 'civil-code' };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(1);
      expect(references[0].referenceType).toBe('internal');
    });

    it('相対参照を正しく解決できる', async () => {
      const text = '前条の規定にかかわらず';
      const context = { 
        sourceArticleId: 'civil-code-91', 
        lawId: 'civil-code',
        articleNumber: 91 
      };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(1);
      expect(references[0].referenceType).toBe('relative');
      expect(references[0].targetArticleId).toBe('civil-code-90');
    });
  });

  describe('複合参照の検出', () => {
    it('同項第○号の参照を検出できる', async () => {
      const text = '同項第二号に規定する場合';
      const context = { 
        sourceArticleId: 'test-1', 
        lawId: 'test-law',
        paragraphNumber: 2
      };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(1);
      expect(references[0].referenceType).toBe('complex');
    });
  });

  describe('エッジケース', () => {
    it('空文字列に対してエラーを発生させない', async () => {
      const text = '';
      const context = { sourceArticleId: 'test-1', lawId: 'test-law' };

      const references = await detector.detect(text, context);

      expect(references).toHaveLength(0);
    });

    it('非常に長いテキストでも処理できる', async () => {
      const text = '第1条'.repeat(10000);
      const context = { sourceArticleId: 'test-1', lawId: 'test-law' };

      const references = await detector.detect(text, context);

      expect(references.length).toBeGreaterThan(0);
    });
  });
});
```

#### ドメインモデルのテスト

```typescript
// tests/unit/domain.test.ts
describe('Law Domain Model', () => {
  describe('Law Entity', () => {
    it('正しいLawIdで作成できる', () => {
      const lawId = new LawId('129AC0000000089');
      const lawInfo = new LawInfo('民法', '明治二十九年法律第八十九号');
      
      const law = Law.create(lawId, lawInfo);

      expect(law.getLawId().toString()).toBe('129AC0000000089');
    });

    it('無効なLawIdでエラーを発生させる', () => {
      expect(() => {
        new LawId('invalid-id');
      }).toThrow('Invalid LawId format');
    });
  });

  describe('Reference Value Object', () => {
    it('参照オブジェクトを正しく作成できる', () => {
      const reference = new Reference({
        sourceArticleId: 'source-1',
        targetArticleId: 'target-1',
        referenceType: ReferenceType.EXTERNAL_REFERENCE,
        confidence: 0.9
      });

      expect(reference.getConfidence()).toBe(0.9);
      expect(reference.getReferenceType()).toBe(ReferenceType.EXTERNAL_REFERENCE);
    });

    it('信頼度が範囲外の場合エラーを発生させる', () => {
      expect(() => {
        new Reference({
          sourceArticleId: 'source-1',
          targetArticleId: 'target-1',
          referenceType: ReferenceType.EXTERNAL_REFERENCE,
          confidence: 1.5
        });
      }).toThrow('Confidence must be between 0 and 1');
    });
  });
});
```

## 4. 統合テスト

### 4.1 対象範囲

- データベース操作（PostgreSQL, Neo4j）
- API エンドポイント
- 外部サービス連携
- HybridDBClient

### 4.2 テスト実装例

#### データベース統合テスト

```typescript
// tests/integration/database.test.ts
describe('Database Integration', () => {
  let prisma: PrismaClient;
  let hybridDB: HybridDBClient;

  beforeAll(async () => {
    prisma = new PrismaClient();
    hybridDB = new HybridDBClient();
    await setupTestDatabase();
  });

  afterAll(async () => {
    await cleanupTestDatabase();
    await prisma.$disconnect();
    await hybridDB.close();
  });

  describe('PostgreSQL Operations', () => {
    it('法令データを正しく保存・取得できる', async () => {
      const lawData = {
        lawId: 'TEST001',
        lawTitle: 'テスト法',
        lawNum: 'テスト法令第1号'
      };

      await prisma.law.create({ data: lawData });

      const retrieved = await prisma.law.findUnique({
        where: { lawId: 'TEST001' }
      });

      expect(retrieved).toMatchObject(lawData);
    });
  });

  describe('Neo4j Operations', () => {
    it('参照関係を正しく作成・取得できる', async () => {
      const reference = {
        sourceArticleId: 'test-source',
        targetArticleId: 'test-target',
        referenceType: 'external',
        confidence: 0.9
      };

      await hybridDB.createReference(reference);

      const references = await hybridDB.getReferences('test-source');
      expect(references).toContainEqual(
        expect.objectContaining(reference)
      );
    });
  });

  describe('Hybrid Operations', () => {
    it('PostgreSQLとNeo4jのデータを統合取得できる', async () => {
      const lawId = 'TEST002';
      
      // PostgreSQLに法令データ
      await prisma.law.create({
        data: { lawId, lawTitle: 'テスト法2', lawNum: 'テスト法令第2号' }
      });

      // Neo4jに参照関係
      await hybridDB.createReference({
        sourceArticleId: `${lawId}-art1`,
        targetArticleId: `${lawId}-art2`,
        referenceType: 'internal',
        confidence: 1.0
      });

      const lawWithReferences = await hybridDB.getLawWithReferences(lawId);

      expect(lawWithReferences.law.lawId).toBe(lawId);
      expect(lawWithReferences.references.length).toBeGreaterThan(0);
    });
  });
});
```

#### API統合テスト

```typescript
// tests/integration/api.test.ts
describe('API Integration', () => {
  let app: NextApiHandler;

  beforeAll(async () => {
    app = await createTestApp();
  });

  describe('Laws API', () => {
    it('GET /api/laws - 法令一覧を取得できる', async () => {
      const response = await request(app)
        .get('/api/laws')
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThan(0);
    });

    it('GET /api/laws/[id] - 特定の法令を取得できる', async () => {
      const lawId = '129AC0000000089';
      const response = await request(app)
        .get(`/api/laws/${lawId}`)
        .expect(200);

      expect(response.body).toHaveProperty('lawId', lawId);
      expect(response.body).toHaveProperty('lawTitle', '民法');
    });

    it('GET /api/laws/[id]/references - 参照関係を取得できる', async () => {
      const lawId = '129AC0000000089';
      const response = await request(app)
        .get(`/api/laws/${lawId}/references`)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      response.body.forEach(ref => {
        expect(ref).toHaveProperty('referenceType');
        expect(ref).toHaveProperty('confidence');
      });
    });
  });

  describe('Error Handling', () => {
    it('存在しない法令IDでエラーを返す', async () => {
      const response = await request(app)
        .get('/api/laws/NONEXISTENT')
        .expect(404);

      expect(response.body).toHaveProperty('error');
    });

    it('不正なパラメータでバリデーションエラーを返す', async () => {
      const response = await request(app)
        .post('/api/laws')
        .send({ invalid: 'data' })
        .expect(400);

      expect(response.body).toHaveProperty('error');
    });
  });
});
```

## 5. システムテスト・E2Eテスト

### 5.1 E2Eテストフレームワーク

**使用ツール**: Playwright

```typescript
// playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  timeout: 30000,
  retries: 2,
  use: {
    baseURL: 'http://localhost:3000',
    headless: true,
    viewport: { width: 1280, height: 720 },
    video: 'retain-on-failure',
    screenshot: 'only-on-failure'
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] }
    }
  ]
});
```

### 5.2 E2Eテスト実装例

```typescript
// tests/e2e/law-search.spec.ts
import { test, expect } from '@playwright/test';

test.describe('法令検索フロー', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('基本的な検索フロー', async ({ page }) => {
    // 検索実行
    await page.fill('[data-testid="search-input"]', '民法');
    await page.click('[data-testid="search-button"]');

    // 検索結果の確認
    await expect(page.locator('[data-testid="search-results"]')).toBeVisible();
    await expect(page.locator('[data-testid="search-results"] li').first())
      .toContainText('民法');

    // 法令詳細への遷移
    await page.click('[data-testid="search-results"] li:first-child');
    await expect(page.locator('[data-testid="law-title"]'))
      .toContainText('民法');
  });

  test('参照リンクナビゲーション', async ({ page }) => {
    await page.goto('/laws/129AC0000000089');
    
    // 参照リンクをクリック
    const referenceLink = page.locator('[data-testid="reference-link"]').first();
    await referenceLink.click();

    // 参照先にジャンプすることを確認
    await expect(page.locator('[data-testid="highlighted-article"]'))
      .toBeVisible();
    
    // 戻るボタンで元の位置に戻る
    await page.click('[data-testid="back-button"]');
    await expect(page.locator('[data-testid="reference-source"]'))
      .toBeVisible();
  });

  test('階層ナビゲーション', async ({ page }) => {
    await page.goto('/laws/129AC0000000089');

    // 目次の展開
    await page.click('[data-testid="chapter-toggle"]');
    await expect(page.locator('[data-testid="article-list"]'))
      .toBeVisible();

    // 条文へのジャンプ
    await page.click('[data-testid="article-link-90"]');
    await expect(page.locator('[data-testid="article-90"]'))
      .toBeInViewport();
  });
});

test.describe('改正影響分析', () => {
  test('ハネ改正検出フロー', async ({ page }) => {
    await page.goto('/admin/impact-analysis');
    
    // 改正対象の選択
    await page.selectOption('[data-testid="law-select"]', '129AC0000000089');
    await page.selectOption('[data-testid="article-select"]', '90');
    
    // 分析実行
    await page.click('[data-testid="analyze-button"]');
    
    // 分析結果の確認
    await expect(page.locator('[data-testid="analysis-results"]'))
      .toBeVisible({ timeout: 10000 });
    
    await expect(page.locator('[data-testid="impact-count"]'))
      .toContainText(/\d+/);
    
    // 結果のエクスポート
    const downloadPromise = page.waitForDownload();
    await page.click('[data-testid="export-button"]');
    const download = await downloadPromise;
    expect(download.suggestedFilename()).toMatch(/impact-analysis.*\.csv/);
  });
});

test.describe('レスポンシブデザイン', () => {
  test('モバイル表示での基本操作', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('/laws/129AC0000000089');

    // モバイルメニューの確認
    await page.click('[data-testid="mobile-menu-toggle"]');
    await expect(page.locator('[data-testid="mobile-menu"]')).toBeVisible();

    // 条文の表示確認
    await expect(page.locator('[data-testid="article-content"]'))
      .toBeVisible();
  });
});
```

## 6. パフォーマンステスト

### 6.1 性能要件

| メトリクス | 目標値 | 計測方法 |
|-----------|--------|----------|
| First Contentful Paint | < 1.5秒 | Lighthouse |
| Largest Contentful Paint | < 2.5秒 | Lighthouse |
| Time to Interactive | < 3.0秒 | Lighthouse |
| API応答時間 | < 500ms | Load Test |
| 同時接続数 | 100ユーザー | Load Test |

### 6.2 負荷テスト

```typescript
// tests/performance/load.test.ts
import { check } from 'k6';
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '2m', target: 20 }, // ramp up
    { duration: '5m', target: 20 }, // stay at 20 users
    { duration: '2m', target: 50 }, // ramp up to 50 users
    { duration: '5m', target: 50 }, // stay at 50 users
    { duration: '2m', target: 0 },  // ramp down
  ],
};

export default function() {
  // 法令一覧の取得
  let response = http.get('http://localhost:3000/api/laws');
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  // 法令詳細の取得
  response = http.get('http://localhost:3000/api/laws/129AC0000000089');
  check(response, {
    'law detail status is 200': (r) => r.status === 200,
    'law detail response time < 1s': (r) => r.timings.duration < 1000,
  });

  // 参照関係の取得
  response = http.get('http://localhost:3000/api/laws/129AC0000000089/references');
  check(response, {
    'references status is 200': (r) => r.status === 200,
    'references response time < 2s': (r) => r.timings.duration < 2000,
  });
}
```

### 6.3 パフォーマンス監視

```typescript
// src/lib/performance-monitor.ts
export class PerformanceMonitor {
  private static instance: PerformanceMonitor;
  
  static getInstance(): PerformanceMonitor {
    if (!this.instance) {
      this.instance = new PerformanceMonitor();
    }
    return this.instance;
  }
  
  async measureFunction<T>(
    functionName: string,
    fn: () => Promise<T>
  ): Promise<T> {
    const startTime = performance.now();
    const startMemory = process.memoryUsage();
    
    try {
      const result = await fn();
      
      const endTime = performance.now();
      const endMemory = process.memoryUsage();
      
      this.logMetrics({
        functionName,
        executionTime: endTime - startTime,
        memoryUsage: {
          heapUsed: endMemory.heapUsed - startMemory.heapUsed,
          heapTotal: endMemory.heapTotal - startMemory.heapTotal,
        }
      });
      
      return result;
    } catch (error) {
      const endTime = performance.now();
      this.logError(functionName, endTime - startTime, error);
      throw error;
    }
  }
  
  private logMetrics(metrics: any) {
    console.log(`[PERF] ${JSON.stringify(metrics)}`);
  }
  
  private logError(functionName: string, executionTime: number, error: any) {
    console.error(`[PERF ERROR] ${functionName}: ${executionTime}ms`, error);
  }
}
```

## 7. セキュリティテスト

### 7.1 脆弱性スキャン

**テスト項目**:
- SQLインジェクション
- クロスサイトスクリプティング（XSS）
- クロスサイトリクエストフォージェリ（CSRF）
- 認証・認可の不備
- 機密情報の露出

**使用ツール**: OWASP ZAP

```bash
# ZAP スキャンスクリプト
#!/bin/bash
zap-baseline.py -t http://localhost:3000 -J zap-report.json
zap-full-scan.py -t http://localhost:3000 -J zap-full-report.json
```

### 7.2 セキュリティテスト実装

```typescript
// tests/security/auth.test.ts
describe('認証・認可テスト', () => {
  test('未認証ユーザーは管理機能にアクセスできない', async () => {
    const response = await request(app)
      .get('/api/admin/users')
      .expect(401);

    expect(response.body).toHaveProperty('error', 'Unauthorized');
  });

  test('JWTトークンの改ざんを検出できる', async () => {
    const tamperedToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.invalid.signature';
    
    const response = await request(app)
      .get('/api/laws')
      .set('Authorization', `Bearer ${tamperedToken}`)
      .expect(401);
  });

  test('SQLインジェクション攻撃を防げる', async () => {
    const maliciousInput = "'; DROP TABLE laws; --";
    
    const response = await request(app)
      .get(`/api/laws/search?q=${encodeURIComponent(maliciousInput)}`)
      .expect(400);
  });
});
```

## 8. テスト環境とデータ管理

### 8.1 テスト環境構成

| 環境名 | 用途 | URL | 特徴 |
|--------|------|-----|------|
| 開発環境 | 開発中のテスト | localhost:3000 | 最新コード、不安定 |
| テスト環境 | QAテスト | test.lawfinder.jp | 安定版、本番相当データ |
| ステージング環境 | 最終確認 | staging.lawfinder.jp | 本番同等構成 |

### 8.2 テストデータ管理

```typescript
// tests/utils/test-data-factory.ts
export class TestDataFactory {
  static createLaw(overrides = {}): Law {
    return {
      lawId: faker.random.alphaNumeric(15),
      lawTitle: faker.lorem.words(3),
      lawNum: `${faker.date.past().getFullYear()}年法律第${faker.datatype.number({ min: 1, max: 200 })}号`,
      promulgateDate: faker.date.past(),
      enforceDate: faker.date.past(),
      ...overrides
    };
  }

  static createArticle(lawId: string, overrides = {}): Article {
    return {
      articleId: `${lawId}_art${faker.datatype.number({ min: 1, max: 100 })}`,
      lawId,
      articleNum: faker.datatype.number({ min: 1, max: 1000 }),
      content: faker.lorem.paragraphs(2),
      ...overrides
    };
  }

  static createReference(sourceId: string, targetId: string, overrides = {}): Reference {
    return {
      referenceId: faker.random.alphaNumeric(10),
      sourceArticleId: sourceId,
      targetArticleId: targetId,
      referenceType: faker.random.arrayElement(['external', 'internal', 'relative']),
      confidence: faker.datatype.float({ min: 0.7, max: 1.0 }),
      ...overrides
    };
  }
}

// テストデータのセットアップ
export async function setupTestData(): Promise<void> {
  const laws = Array.from({ length: 10 }, () => TestDataFactory.createLaw());
  
  for (const law of laws) {
    await prisma.law.create({ data: law });
    
    const articles = Array.from({ length: 50 }, (_, i) => 
      TestDataFactory.createArticle(law.lawId, { articleNum: i + 1 })
    );
    
    for (const article of articles) {
      await prisma.article.create({ data: article });
    }
  }
}
```

## 9. CI/CD統合とテスト自動化

### 9.1 GitHub Actions設定

```yaml
# .github/workflows/test.yml
name: Test Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run typecheck
      - run: npm run lint
      - run: npm run test:unit -- --coverage
      
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: true

  integration-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: lawfinder_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      neo4j:
        image: neo4j:5.3
        env:
          NEO4J_AUTH: neo4j/testpass
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpass 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npx prisma migrate dev
      - run: npm run test:integration

  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run build
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run E2E tests
        run: npm run test:e2e
      
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/

  performance-test:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      
      - run: npm ci
      - run: npm run build
      - run: npm start &
      
      - name: Wait for server
        run: npx wait-on http://localhost:3000
      
      - name: Run Lighthouse
        run: npm run test:lighthouse
      
      - uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: lighthouse-report.html
```

### 9.2 テスト実行コマンド

```json
// package.json scripts
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest --testPathPattern=unit",
    "test:integration": "jest --testPathPattern=integration",
    "test:e2e": "playwright test",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:lighthouse": "lighthouse http://localhost:3000 --output=html --output-path=lighthouse-report.html",
    "test:load": "k6 run tests/performance/load.test.js"
  }
}
```

## 10. テスト品質メトリクス

### 10.1 カバレッジ目標

| ファイル/ディレクトリ | 現在のカバレッジ | 目標 |
|---------------------|------------------|------|
| src/domain/ | 40% | 90% |
| src/infrastructure/ | 30% | 70% |
| src/lib/ | 50% | 80% |
| scripts/detector.ts | 70% | 95% |
| 全体 | 40% | 80% |

### 10.2 品質指標

- **テスト成功率**: 99%以上
- **テスト実行時間**: 5分以内
- **フレーキーテスト**: 0件
- **重大バグエスケープ**: 0件
- **コードレビューでのテストカバレッジチェック**: 必須

### 10.3 継続的改善

```typescript
// tests/utils/test-metrics.ts
export class TestMetrics {
  static async collectMetrics(): Promise<TestMetricsReport> {
    const coverage = await this.getCoverageData();
    const performance = await this.getPerformanceMetrics();
    const quality = await this.getQualityMetrics();

    return {
      coverage,
      performance,
      quality,
      generatedAt: new Date()
    };
  }

  static async generateReport(metrics: TestMetricsReport): Promise<void> {
    const reportPath = `reports/test-metrics-${Date.now()}.json`;
    await fs.writeFile(reportPath, JSON.stringify(metrics, null, 2));
    
    console.log(`Test metrics report generated: ${reportPath}`);
  }
}
```

---

**改訂履歴**

| バージョン | 日付 | 変更内容 |
|----------|------|----------|
| 1.0 | 2025-08-21 | 初版作成（テスト戦略、品質基準、CI/CD統合を包括的に統合） |