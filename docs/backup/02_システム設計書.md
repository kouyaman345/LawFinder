# システム設計書

## 1. アーキテクチャ概要

### 1.1 システム構成
```
┌─────────────────────────────────────────────┐
│          フロントエンド (React/Next.js)        │
├─────────────────────────────────────────────┤
│           APIレイヤー (Next.js API Routes)     │
├─────────────────────────────────────────────┤
│              ビジネスロジック層                │
│  ├─ Domain Services（参照検出エンジン）         │
│  ├─ Application Services（ユースケース）       │
│  └─ Infrastructure（データアクセス）           │
├─────────────────────────────────────────────┤
│                 データ層                       │
│  ├─ PostgreSQL（法令本体・メタデータ）          │
│  ├─ Neo4j（参照関係グラフ）                    │
│  └─ Redis（キャッシュ）※予定                  │
└─────────────────────────────────────────────┘
```

### 1.2 技術スタック

#### フロントエンド
- **フレームワーク**: React 19 + Next.js 15（App Router）
- **スタイリング**: Tailwind CSS + e-Gov準拠カスタムCSS
- **状態管理**: React Context API
- **UIコンポーネント**: @heroicons/react

#### バックエンド
- **ランタイム**: Node.js 20+
- **フレームワーク**: Next.js API Routes
- **言語**: TypeScript 5.3+
- **ORM**: Prisma 6.13

#### データベース
- **PostgreSQL 16**: 法令本体データ、全文検索（pg_bigm）
- **Neo4j 5.x**: 参照関係グラフ、ハネ改正分析
- **Redis**: セッション管理、キャッシュ（予定）

#### 外部連携
- **LLM**: Ollama（Mistralモデル）、OpenAI GPT-4o（予定）
- **データソース**: e-Gov法令API

## 2. ドメイン駆動設計（DDD）

### 2.1 ドメインモデル

#### エンティティ
```typescript
// 法令エンティティ
class Law {
  id: LawId              // 法令番号（例: 129AC0000000089）
  title: LawTitle        // 法令名
  enactmentDate: Date    // 公布日
  enforcementDate: Date  // 施行日
  articles: Article[]    // 条文リスト
  status: LawStatus      // 現行/廃止
}

// 条文エンティティ
class Article {
  id: ArticleId         // 条文ID
  number: string        // 条番号（第1条等）
  title?: string        // 条見出し
  content: string       // 条文内容
  paragraphs: Paragraph[] // 項リスト
  references: Reference[] // 参照リスト
}

// 参照エンティティ
class Reference {
  id: ReferenceId       // 参照ID
  fromArticle: ArticleId // 参照元
  toArticle: ArticleId   // 参照先
  type: ReferenceType    // 参照タイプ
  text: string          // 参照テキスト
}
```

#### 値オブジェクト
- `LawId`: 法令番号の値オブジェクト
- `ArticleId`: 条文IDの値オブジェクト
- `ReferenceType`: 参照タイプ（internal/external/relative等）

### 2.2 レイヤー構成

#### Domain層
- `/src/domain/models/`: ドメインモデル
- `/src/domain/services/`: ドメインサービス（参照検出ロジック）
- `/src/domain/repositories/`: リポジトリインターフェース

#### Application層
- `/src/application/usecases/`: ユースケース実装
- `/src/application/dto/`: データ転送オブジェクト

#### Infrastructure層
- `/src/infrastructure/db/`: データベース実装
- `/src/infrastructure/parsers/`: XMLパーサー
- `/src/infrastructure/external/`: 外部API連携

#### Presentation層
- `/app/`: Next.js App Router
- `/app/components/`: UIコンポーネント
- `/app/api/`: API Routes

## 3. コンポーネント設計

### 3.1 主要コンポーネント

#### 参照検出エンジン
- **UltimateReferenceDetector**: 統合参照検出エンジン（精度95%以上）
- **ReferenceValidator**: 参照妥当性検証
- **PatternMatcher**: パターンマッチング処理

#### データアクセス
- **HybridDBClient**: PostgreSQL/Neo4j統合クライアント
- **LawRepository**: 法令データリポジトリ
- **ReferenceRepository**: 参照データリポジトリ

#### UIコンポーネント
- **LawContentView**: 法令本文表示
- **TableOfContents**: 目次ナビゲーション
- **ReferenceLink**: インタラクティブ参照リンク

### 3.2 データフロー

```
1. ユーザーリクエスト
   ↓
2. Next.js App Router
   ↓
3. API Routes / Server Components
   ↓
4. Application Service（ユースケース）
   ↓
5. Domain Service（ビジネスロジック）
   ↓
6. Repository（データアクセス）
   ↓
7. Database（PostgreSQL/Neo4j）
```

## 4. セキュリティ設計

### 4.1 認証・認可
- セッション管理（Next.js組み込み）
- APIキー認証（外部API連携用）

### 4.2 データ保護
- HTTPS通信の強制
- SQLインジェクション対策（Prisma ORM使用）
- XSS対策（React自動エスケープ）

## 5. パフォーマンス設計

### 5.1 最適化戦略
- **SSG/ISR**: 静的生成とインクリメンタル再生成
- **キャッシュ**: CDNキャッシュ、データベースキャッシュ
- **遅延読み込み**: 大規模法令の段階的読み込み

### 5.2 スケーラビリティ
- 水平スケーリング対応（ステートレス設計）
- データベース接続プーリング
- バッチ処理による大量データ処理