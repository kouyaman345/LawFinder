# テスト仕様書

## 1. テスト戦略

### 1.1 テストレベル
1. **単体テスト**: 個々の関数・クラスのテスト
2. **統合テスト**: 複数コンポーネントの連携テスト
3. **E2Eテスト**: ユーザーシナリオベースのテスト
4. **パフォーマンステスト**: 応答時間・負荷テスト

### 1.2 テストカバレッジ目標
- コードカバレッジ: 80%以上
- ブランチカバレッジ: 70%以上
- 主要機能カバレッジ: 100%

## 2. テスト環境

### 2.1 テストフレームワーク
- **Jest**: 単体テスト・統合テスト
- **React Testing Library**: Reactコンポーネントテスト
- **Playwright**: E2Eテスト（将来実装）
- **k6**: パフォーマンステスト（将来実装）

### 2.2 テストデータ
```
/test-data
  /laws           # テスト用法令XML
  /references     # テスト用参照データ
  /fixtures       # モックデータ
```

## 3. 単体テスト

### 3.1 参照検出エンジン

#### テストケース
| ID | テスト項目 | 入力 | 期待結果 | 優先度 |
|----|---------|------|---------|--------|
| RD001 | 内部参照検出 | "前条の規定" | type: "relative" | 高 |
| RD002 | 外部参照検出 | "民法第90条" | type: "external" | 高 |
| RD003 | 範囲参照検出 | "第1条から第5条まで" | type: "range" | 中 |
| RD004 | 複数参照検出 | "第1条及び第3条" | type: "multiple" | 中 |
| RD005 | 準用参照検出 | "準用する" | type: "application" | 高 |
| RD006 | 無効な参照 | "第9999条" | 検出されない | 高 |
| RD007 | 曖昧な参照 | "法第1条" | 検出されない | 低 |

#### テストコード例
```typescript
describe('ReferenceDetector', () => {
  describe('内部参照検出', () => {
    test.each([
      ['前条', 'relative'],
      ['次条', 'relative'],
      ['前項', 'relative'],
      ['次項', 'relative']
    ])('%sを検出できる', (text, expectedType) => {
      const detector = new ReferenceDetector();
      const result = detector.detect(text);
      
      expect(result).toHaveLength(1);
      expect(result[0].type).toBe(expectedType);
    });
  });
});
```

### 3.2 XMLパーサー

#### テストケース
| ID | テスト項目 | 入力 | 期待結果 | 優先度 |
|----|---------|------|---------|--------|
| XP001 | 正常なXMLパース | 有効なXML | パース成功 | 高 |
| XP002 | 大規模XML | 10MBのXML | メモリエラーなし | 高 |
| XP003 | 無効なXML | 壊れたXML | エラーハンドリング | 中 |
| XP004 | 文字エンコーディング | Shift-JIS XML | 正しく変換 | 高 |

### 3.3 データベースアクセス

#### テストケース
| ID | テスト項目 | 操作 | 期待結果 | 優先度 |
|----|---------|------|---------|--------|
| DB001 | 法令保存 | INSERT | 正常保存 | 高 |
| DB002 | 法令取得 | SELECT | 正しいデータ | 高 |
| DB003 | 参照保存 | Neo4j CREATE | グラフ作成 | 高 |
| DB004 | トランザクション | BEGIN/COMMIT | 整合性保持 | 中 |

## 4. 統合テスト

### 4.1 APIエンドポイント

#### テストシナリオ
```typescript
describe('Laws API', () => {
  test('GET /api/laws - 法令一覧取得', async () => {
    const response = await fetch('/api/laws');
    const data = await response.json();
    
    expect(response.status).toBe(200);
    expect(data.success).toBe(true);
    expect(data.data.laws).toBeArray();
    expect(data.data.pagination).toBeDefined();
  });
  
  test('GET /api/laws/:id - 特定法令取得', async () => {
    const response = await fetch('/api/laws/129AC0000000089');
    const data = await response.json();
    
    expect(response.status).toBe(200);
    expect(data.data.id).toBe('129AC0000000089');
    expect(data.data.title).toBe('民法');
  });
  
  test('GET /api/laws/:id - 存在しない法令', async () => {
    const response = await fetch('/api/laws/INVALID');
    
    expect(response.status).toBe(404);
  });
});
```

### 4.2 ワークフローテスト

#### テストシナリオ
1. 法令XMLのインポート
2. 参照検出の実行
3. Neo4jへの同期
4. API経由でのデータ取得
5. 結果の検証

## 5. E2Eテスト（将来実装）

### 5.1 ユーザーシナリオ

#### シナリオ1: 法令検索と閲覧
```gherkin
Feature: 法令検索
  Scenario: キーワードで法令を検索
    Given トップページを開く
    When 検索ボックスに"民法"を入力
    And 検索ボタンをクリック
    Then 検索結果に"民法"が表示される
    When 民法をクリック
    Then 民法の詳細ページが表示される
```

#### シナリオ2: 参照ナビゲーション
```gherkin
Feature: 参照ナビゲーション
  Scenario: 参照リンクをクリック
    Given 民法第90条を表示
    When 参照リンク"前条"をクリック
    Then 民法第89条が表示される
```

## 6. パフォーマンステスト

### 6.1 応答時間テスト

| テスト項目 | 目標値 | 許容値 |
|---------|--------|--------|
| トップページ表示 | 1秒 | 3秒 |
| 法令検索 | 0.5秒 | 1秒 |
| 法令詳細表示 | 1秒 | 2秒 |
| 参照検出処理 | 1秒/法令 | 3秒/法令 |

### 6.2 負荷テスト

```javascript
// k6スクリプト例
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '5m', target: 100 }, // 100ユーザーまでランプアップ
    { duration: '10m', target: 100 }, // 100ユーザーで維持
    { duration: '5m', target: 0 }, // ランプダウン
  ],
  thresholds: {
    http_req_duration: ['p(95)<1000'], // 95%タイルが1秒以下
  },
};

export default function() {
  let response = http.get('http://localhost:3000/api/laws');
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 1000ms': (r) => r.timings.duration < 1000,
  });
}
```

## 7. テスト実行

### 7.1 コマンド

```bash
# 全テスト実行
npm test

# カバレッジ付き実行
npm run test:coverage

# 監視モード
npm run test:watch

# 特定ファイルのテスト
npm test -- reference-detector.test.ts
```

### 7.2 CI/CDパイプライン

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - run: npm ci
      - run: npm run typecheck
      - run: npm run lint
      - run: npm run test:coverage
      
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
```

## 8. 品質基準

### 8.1 合格基準
- 全テストがパス
- コードカバレッジ 80%以上
- 重要機能のカバレッジ 100%
- パフォーマンス基準を満たす

### 8.2 テストレビュー
- コードレビュー時にテストも確認
- 新機能には必ずテストを追加
- バグ修正時にはリグレッションテストを追加