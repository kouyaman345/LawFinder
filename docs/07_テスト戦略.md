# テスト戦略

## 1. 概要

LawFinderプロジェクトの包括的なテスト戦略を定義し、参照検出エンジンの品質を保証します。

## 2. テストレベル

### 2.1 単体テスト
- **対象**: 個々の関数・メソッド
- **カバレッジ目標**: 80%以上
- **フレームワーク**: Jest

### 2.2 統合テスト
- **対象**: モジュール間の連携
- **重点**: 参照検出エンジンとデータベース連携
- **実行環境**: Docker環境

### 2.3 E2Eテスト
- **対象**: ユーザーシナリオ全体
- **ツール**: Playwright/Cypress
- **カバレッジ**: 主要ユーザーフロー

## 3. 参照検出テストスイート

### 3.1 基本機能テスト（`test-real-detector.ts`）
- **テストケース数**: 8
- **達成F1スコア**: 90.0%
- **精度**: 81.8%
- **再現率**: 100%

### 3.2 エッジケーステスト（`test-edge-cases.ts`）
- **テストケース数**: 13
- **達成F1スコア**: 97.1%
- **成功率**: 100%（13/13）
- **カバー範囲**:
  - 省略形参照
  - 括弧内参照
  - 範囲参照
  - 準用・読替え
  - 複数法令参照

### 3.3 拡張パターンテスト（`test-extended-patterns.ts`）
- **テストケース数**: 20
- **達成F1スコア**: 90.4%
- **成功率**: 90%（18/20）
- **カテゴリ**:
  - 階層構造（100%成功）
  - 省略形（100%成功）
  - 範囲参照（100%成功）
  - 複数法令（50%成功）
  - 準用読替え（50%成功）
  - 特殊形式（100%成功）
  - 附則（100%成功）
  - 列挙並列（100%成功）
  - 文脈依存（100%成功）
  - エッジケース（100%成功）

### 3.4 実データ検証（`test-xml-direct.ts`）
- **検証法令数**: 6
- **総検出参照数**: 122
- **平均参照数/条文**: 2.54
- **処理速度**: 19ms/法令
- **エラー率**: 0%

### 3.5 統合テストスイート（`test-suite.ts`）
- **統合管理**: すべてのテストを一元実行
- **結果保存**: JSON形式でレポート生成
- **実行モード**:
  - basic: 基本機能のみ
  - edge: エッジケースのみ
  - extended: 拡張パターンのみ
  - real: 実データのみ
  - xml: XML直接検証のみ
  - all: すべて実行

## 4. パフォーマンステスト

### 4.1 処理速度基準
- **単一法令**: 100ms以内
- **大規模法令（1000条以上）**: 1秒以内
- **バッチ処理（100法令）**: 30秒以内

### 4.2 メモリ使用量
- **通常処理**: 200MB以内
- **大規模処理**: 1GB以内
- **メモリリーク**: なし

## 5. 品質基準

### 5.1 参照検出精度
| テストタイプ | 目標F1スコア | 現在のスコア | 状態 |
|------------|-------------|-------------|------|
| 基本機能 | 87.5% | 90.0% | ✅ 達成 |
| エッジケース | 90.0% | 97.1% | ✅ 達成 |
| 拡張パターン | 85.0% | 90.4% | ✅ 達成 |
| 実データ | 1.0件/条文 | 2.54件/条文 | ✅ 達成 |

### 5.2 コード品質
- **複雑度**: 10以下
- **重複コード**: 5%以下
- **テストカバレッジ**: 80%以上
- **型安全性**: 100%（TypeScript strict mode）

## 6. CI/CD統合

### 6.1 プルリクエスト時
```yaml
- 単体テスト実行
- 統合テスト実行
- コードカバレッジ確認
- ESLint/Prettier実行
```

### 6.2 マージ時
```yaml
- 全テストスイート実行
- パフォーマンステスト実行
- セキュリティスキャン
- デプロイ準備
```

## 7. テスト実行方法

### 7.1 個別テスト実行
```bash
# 基本テスト
npx tsx scripts/test-real-detector.ts

# エッジケーステスト
npx tsx scripts/test-edge-cases.ts

# 拡張パターンテスト
npx tsx scripts/test-extended-patterns.ts

# XML直接検証
npx tsx scripts/test-xml-direct.ts
```

### 7.2 統合実行
```bash
# すべてのテストを実行
npx tsx scripts/test-suite.ts

# 特定のテストタイプのみ
npx tsx scripts/test-suite.ts edge

# 結果を保存
npx tsx scripts/test-suite.ts --save
```

## 8. テストデータ管理

### 8.1 テストデータ配置
- `/laws_data/`: 実際の法令XMLファイル
- `/test/fixtures/`: テスト用固定データ
- `/test/mocks/`: モックデータ

### 8.2 データ生成
- 自動生成スクリプト使用
- シードデータから派生
- プライバシー配慮済み

## 9. 継続的改善

### 9.1 月次レビュー
- テスト結果の分析
- 失敗パターンの特定
- 新規テストケースの追加

### 9.2 四半期評価
- パフォーマンストレンド分析
- テストカバレッジ評価
- 戦略の見直し

## 10. トラブルシューティング

### 10.1 よくある問題
| 問題 | 原因 | 解決方法 |
|-----|------|---------|
| テスト失敗 | 環境依存 | Docker環境で実行 |
| タイムアウト | 大規模データ | タイムアウト値調整 |
| メモリ不足 | リーク | ガベージコレクション強制 |

### 10.2 デバッグ方法
```bash
# 詳細ログ出力
npm test -- --verbose

# 特定テストのみ実行
npm test -- --grep "pattern"

# デバッガ接続
node --inspect npx tsx scripts/test-suite.ts
```

---

最終更新: 2025年8月21日