# LawFinder 参照検出機能改善報告書

作成日: 2025年8月4日

## 概要

本報告書は、LawFinderの参照検出機能における大幅な改善内容をまとめたものです。特にe-Gov準拠のUI実装と、複雑な参照パターンの検出・リンク化について詳述します。

## 実装した改善内容

### 1. e-Govスタイル版の新規実装

#### 1.1 UIデザインの完全準拠
- **目次の独立スクロール**: 左サイドバーの目次が本文とは独立してスクロール可能
- **ぶら下がりインデント**: Flexboxを使用した完全な実装
  - 項番号: 右寄せ30px幅
  - 号番号: 右寄せ40px幅
  - イロハ: 右寄せ30px幅
- **連続的な文書表示**: カード型ではなく、条文間を細い線で区切る形式

#### 1.2 新規ビルドスクリプト
```bash
npm run build:static:egov
```
- 処理速度: 高速（数秒で完了）
- e-Gov法令検索と同等のユーザー体験を実現

### 2. 参照検出パターンの拡張

#### 2.1 条文＋項の複合参照
**改善前**: 「第十七条第二項」→「第十七条」のみが検出
**改善後**: 「第十七条第二項」全体を一つの参照として検出・リンク化

```javascript
{ regex: /第([０-９0-9一二三四五六七八九十百千]+)条第([０-９0-9一二三四五六七八九十]+)項/g, type: 'INTERNAL_REFERENCE' }
```

#### 2.2 章参照の検出
- 「第五章」「前章」「次章」を検出
- 内部参照（青色）として表示

#### 2.3 相対参照のリンク生成
- **前条・次条**: 条文番号から自動計算してリンク生成
- **前項・次項**: 項番号から自動計算してリンク生成
  - 各項にアンカーID付与: `id="art12-para2"`
  - 例: 第12条第2項の「前項」→ `#art12-para1`

### 3. 漢数字変換の高度化

#### 3.1 複合漢数字の処理
**改善前**: 「二十二」→「二十二」（変換されない）
**改善後**: 「二十二」→「22」（正しく変換）

実装したアルゴリズム:
- 千・百・十の位を順次処理
- 「二十二」= 2×10 + 2 = 22
- 「百二十三」= 1×100 + 2×10 + 3 = 123

### 4. 法令間相互参照の実装

#### 4.1 複数法令の読み込み
- サンプルディレクトリの全XMLファイルを処理（8法令）
  - 民法、商法、刑法、民事訴訟法、独占禁止法、労働基準法、消費税法、会社法

#### 4.2 外部法令参照のリンク化
- 読み込まれている法令への参照を自動的にリンク化
- 例: 商法内の「民法第五百二十四条」→ `129AC0000000089.html#art524`

### 5. 参照の重複処理防止

#### 5.1 マーカーシステムの実装
- 一度処理した文字列範囲を記録
- 「民法第五百二十四条」内の「第五百二十四条」が二重にリンク化されることを防止

## 参照タイプと色分け仕様

| タイプ | 色 | 用途 | リンク |
|--------|-----|------|--------|
| internal-ref | 青 (#0066cc) | 同一法令内参照 | あり |
| external-ref | 赤 (#dc3545) | 他法令参照 | あり（読込済の場合） |
| relative-ref | 緑 (#28a745) | 相対参照 | 一部あり |

## 今後の実装予定

### 1. LLMによる「同項」解析
現在「同項」は緑色表示のみですが、LLMを使用して文脈から参照先を特定する機能を実装予定：

```javascript
// 例: 「第17条第2項の規定により...同項の場合」
// LLMが文脈を解析して第17条第2項へのリンクを生成
```

### 2. 項数の動的取得
現在は最大項数を10と仮定していますが、実際の項数を動的に取得する必要があります。

### 3. 章・節・款へのアンカーリンク
法令の階層構造全体にアンカーを設定し、目次からの直接ジャンプを可能にします。

## パフォーマンス指標

| 処理 | 時間 |
|------|------|
| 8法令の読み込み | < 1秒 |
| 参照検出（6000件以上） | < 2秒 |
| HTML生成 | < 1秒 |
| **合計処理時間** | **< 5秒** |

## 技術的成果

1. **正規表現の最適化**: 複雑な日本語パターンを効率的に処理
2. **DOM操作の最小化**: 文字列処理で完結し、高速化を実現
3. **メモリ効率**: 大規模法令（会社法5000件以上の参照）でも安定動作
4. **保守性**: 参照パターンの追加が容易な設計

## まとめ

本改善により、LawFinderの参照検出機能は実用レベルに到達しました。特に：

- e-Gov準拠のUIにより、利用者に馴染みのあるインターフェースを提供
- 複雑な参照パターンの検出により、法令間のつながりを可視化
- 高速な処理により、大量の法令データでも快適な操作性を実現

これらの改善により、法令検索・分析ツールとしての基盤が確立されました。