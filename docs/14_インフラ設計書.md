# インフラ設計書

**プロジェクト名**: LawFinder  
**作成日**: 2025年8月3日  
**バージョン**: 1.0  
**作成者**: インフラチーム

## 1. 概要

### 1.1 目的
本書は、LawFinderシステムのインフラストラクチャ設計を定義する。高可用性、スケーラビリティ、セキュリティを確保したクラウドネイティブなアーキテクチャを提供する。

### 1.2 スコープ
- Phase 1: 静的サイトホスティング環境
- Phase 2: フルスタックアプリケーション環境
- 開発、ステージング、本番環境の構成
- 災害復旧（DR）およびバックアップ戦略

### 1.3 クラウドプロバイダー
- **メイン**: AWS（Amazon Web Services）
- **代替案**: GCP（Google Cloud Platform）
- **CDN**: CloudFront / Cloudflare

## 2. アーキテクチャ概要

### 2.1 Phase 1: 静的サイトアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        インターネット                         │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    CloudFlare CDN                            │
│  ・DDoS保護                                                  │
│  ・SSL/TLS終端                                               │
│  ・キャッシング                                              │
│  ・WAF                                                       │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    AWS CloudFront                            │
│  ・グローバル配信                                            │
│  ・圧縮配信                                                  │
│  ・カスタムエラーページ                                      │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      Amazon S3                               │
│  ┌─────────────────────────────────────┐                   │
│  │  静的ウェブサイトホスティング        │                   │
│  │  ・HTMLファイル（約10,000ファイル）  │                   │
│  │  ・JavaScript/CSS                    │                   │
│  │  ・検索インデックス（JSON）         │                   │
│  │  ・画像/アセット                    │                   │
│  └─────────────────────────────────────┘                   │
│                                                              │
│  バケット構成:                                               │
│  ・lawfinder-static-prod                                     │
│  ・lawfinder-static-staging                                  │
│  ・lawfinder-static-backup                                   │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 Phase 2: フルスタックアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        インターネット                         │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                     Route 53 (DNS)                           │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  CloudFront (CDN)                            │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Application Load Balancer (ALB)                 │
│  ・HTTPS終端                                                 │
│  ・パスベースルーティング                                    │
│  ・ヘルスチェック                                           │
└───────────────────────────┬─────────────────────────────────┘
                            │
         ┌──────────────────┴──────────────────┐
         ▼                                     ▼
┌─────────────────────┐             ┌─────────────────────┐
│   ECS Fargate       │             │   ECS Fargate       │
│  ┌───────────────┐  │             │  ┌───────────────┐  │
│  │ Frontend      │  │             │  │ API Server    │  │
│  │ (Next.js)     │  │             │  │ (Node.js)     │  │
│  └───────────────┘  │             │  └───────────────┘  │
│  Auto Scaling       │             │  Auto Scaling       │
└─────────────────────┘             └─────────────────────┘
         │                                     │
         └──────────────────┬──────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    データ層 (VPC内)                          │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │   RDS       │ DocumentDB/ │Elasticsearch│   Redis     │ │
│  │(PostgreSQL) │   Neo4j     │  Service    │ ElastiCache │ │
│  │ Multi-AZ    │             │             │             │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## 3. AWS リソース詳細設計

### 3.1 ネットワーク設計

#### 3.1.1 VPC構成

```yaml
VPC:
  Name: lawfinder-vpc
  CIDR: 10.0.0.0/16
  Region: ap-northeast-1 (東京)
  
  AvailabilityZones:
    - ap-northeast-1a
    - ap-northeast-1c
    - ap-northeast-1d

Subnets:
  Public:
    - Name: public-subnet-1a
      CIDR: 10.0.1.0/24
      AZ: ap-northeast-1a
    - Name: public-subnet-1c
      CIDR: 10.0.2.0/24
      AZ: ap-northeast-1c
    - Name: public-subnet-1d
      CIDR: 10.0.3.0/24
      AZ: ap-northeast-1d
      
  Private:
    - Name: private-subnet-1a
      CIDR: 10.0.11.0/24
      AZ: ap-northeast-1a
    - Name: private-subnet-1c
      CIDR: 10.0.12.0/24
      AZ: ap-northeast-1c
    - Name: private-subnet-1d
      CIDR: 10.0.13.0/24
      AZ: ap-northeast-1d
      
  Database:
    - Name: db-subnet-1a
      CIDR: 10.0.21.0/24
      AZ: ap-northeast-1a
    - Name: db-subnet-1c
      CIDR: 10.0.22.0/24
      AZ: ap-northeast-1c
```

#### 3.1.2 セキュリティグループ

```yaml
SecurityGroups:
  - Name: alb-sg
    Rules:
      Ingress:
        - Protocol: tcp
          Port: 443
          Source: 0.0.0.0/0
        - Protocol: tcp
          Port: 80
          Source: 0.0.0.0/0
      Egress:
        - Protocol: -1
          Port: -1
          Destination: 0.0.0.0/0
          
  - Name: ecs-frontend-sg
    Rules:
      Ingress:
        - Protocol: tcp
          Port: 3000
          Source: alb-sg
      Egress:
        - Protocol: -1
          Port: -1
          Destination: 0.0.0.0/0
          
  - Name: ecs-api-sg
    Rules:
      Ingress:
        - Protocol: tcp
          Port: 4000
          Source: alb-sg
      Egress:
        - Protocol: -1
          Port: -1
          Destination: 0.0.0.0/0
          
  - Name: rds-sg
    Rules:
      Ingress:
        - Protocol: tcp
          Port: 5432
          Source: ecs-api-sg
      Egress:
        - Protocol: -1
          Port: -1
          Destination: 0.0.0.0/0
```

### 3.2 コンピュート設計

#### 3.2.1 ECS Fargate設定

```yaml
ECS:
  Cluster:
    Name: lawfinder-cluster
    CapacityProviders:
      - FARGATE
      - FARGATE_SPOT
      
  Services:
    Frontend:
      Name: lawfinder-frontend
      TaskDefinition:
        Family: lawfinder-frontend
        CPU: 1024  # 1 vCPU
        Memory: 2048  # 2 GB
        Container:
          Name: frontend
          Image: lawfinder/frontend:latest
          Port: 3000
          Environment:
            - Name: NODE_ENV
              Value: production
            - Name: API_URL
              Value: https://api.lawfinder.jp
      DesiredCount: 2
      AutoScaling:
        MinCapacity: 2
        MaxCapacity: 10
        TargetCPU: 70
        TargetMemory: 80
        
    API:
      Name: lawfinder-api
      TaskDefinition:
        Family: lawfinder-api
        CPU: 2048  # 2 vCPU
        Memory: 4096  # 4 GB
        Container:
          Name: api
          Image: lawfinder/api:latest
          Port: 4000
          Secrets:
            - Name: DB_PASSWORD
              ValueFrom: arn:aws:secretsmanager:...
      DesiredCount: 3
      AutoScaling:
        MinCapacity: 3
        MaxCapacity: 20
        TargetCPU: 60
        TargetMemory: 70
```

### 3.3 データストア設計

#### 3.3.1 RDS (PostgreSQL)

```yaml
RDS:
  Engine: postgres
  EngineVersion: "15.3"
  InstanceClass: db.r6g.xlarge
  AllocatedStorage: 100  # GB
  StorageType: gp3
  IOPS: 3000
  MultiAZ: true
  BackupRetentionPeriod: 30  # days
  PreferredBackupWindow: "17:00-18:00"  # UTC (2:00-3:00 JST)
  PreferredMaintenanceWindow: "sun:18:00-sun:19:00"
  EnablePerformanceInsights: true
  Parameters:
    max_connections: 200
    shared_buffers: "2GB"
    effective_cache_size: "6GB"
    work_mem: "16MB"
    maintenance_work_mem: "512MB"
```

#### 3.3.2 Elasticsearch Service

```yaml
Elasticsearch:
  Version: "8.10"
  InstanceType: r6g.large.elasticsearch
  InstanceCount: 3
  DedicatedMasterEnabled: true
  DedicatedMasterType: r6g.large.elasticsearch
  DedicatedMasterCount: 3
  StorageType: gp3
  VolumeSize: 100  # GB per node
  VolumeIOPS: 3000
  AdvancedOptions:
    "rest.action.multi.allow_explicit_index": "true"
    "indices.fielddata.cache.size": "40%"
    "indices.query.bool.max_clause_count": "1024"
```

#### 3.3.3 ElastiCache (Redis)

```yaml
ElastiCache:
  Engine: redis
  EngineVersion: "7.0"
  NodeType: cache.r6g.xlarge
  NumCacheNodes: 3
  ParameterGroup: default.redis7.cluster.on
  AutomaticFailoverEnabled: true
  MultiAZEnabled: true
  SnapshotRetentionLimit: 7
  SnapshotWindow: "17:00-19:00"  # UTC
```

### 3.4 ストレージ設計

#### 3.4.1 S3バケット構成

```yaml
S3Buckets:
  - Name: lawfinder-static-prod
    Versioning: Enabled
    PublicAccessBlock: false  # 静的ホスティング用
    WebsiteConfiguration:
      IndexDocument: index.html
      ErrorDocument: error.html
    LifecycleRules:
      - Id: delete-old-versions
        NoncurrentVersionExpiration:
          NoncurrentDays: 30
          
  - Name: lawfinder-data-prod
    Versioning: Enabled
    PublicAccessBlock: true
    ServerSideEncryption: AES256
    LifecycleRules:
      - Id: archive-old-data
        Transitions:
          - Days: 90
            StorageClass: STANDARD_IA
          - Days: 180
            StorageClass: GLACIER
            
  - Name: lawfinder-backup-prod
    Versioning: Enabled
    PublicAccessBlock: true
    ServerSideEncryption: aws:kms
    ReplicationConfiguration:
      Role: arn:aws:iam::123456789012:role/replication
      Rules:
        - Id: backup-replication
          Status: Enabled
          Priority: 1
          Destination:
            Bucket: arn:aws:s3:::lawfinder-backup-dr
            StorageClass: GLACIER
```

## 4. セキュリティ設計

### 4.1 IAMロール設計

```yaml
IAMRoles:
  - Name: lawfinder-ecs-task-role
    TrustPolicy:
      Service: ecs-tasks.amazonaws.com
    Policies:
      - Name: S3Access
        Actions:
          - s3:GetObject
          - s3:PutObject
        Resources:
          - arn:aws:s3:::lawfinder-data-prod/*
      - Name: SecretsManagerAccess
        Actions:
          - secretsmanager:GetSecretValue
        Resources:
          - arn:aws:secretsmanager:*:*:secret:lawfinder/*
      - Name: CloudWatchLogs
        Actions:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
        Resources:
          - arn:aws:logs:*:*:*
          
  - Name: lawfinder-backup-role
    TrustPolicy:
      Service: backup.amazonaws.com
    Policies:
      - Name: BackupPolicy
        Actions:
          - rds:CreateDBSnapshot
          - rds:DescribeDBSnapshots
          - elasticache:CreateSnapshot
          - elasticache:DescribeSnapshots
        Resources: "*"
```

### 4.2 ネットワークセキュリティ

#### 4.2.1 WAF設定

```yaml
WAF:
  WebACL:
    Name: lawfinder-waf
    Rules:
      - Name: RateLimitRule
        Priority: 1
        Statement:
          RateBasedStatement:
            Limit: 2000
            AggregateKeyType: IP
        Action:
          Block: {}
          
      - Name: GeoMatchRule
        Priority: 2
        Statement:
          NotStatement:
            Statement:
              GeoMatchStatement:
                CountryCodes:
                  - JP
                  - US
        Action:
          Block: {}
          
      - Name: SQLInjectionRule
        Priority: 3
        Statement:
          ManagedRuleGroupStatement:
            VendorName: AWS
            Name: AWSManagedRulesSQLiRuleSet
        Action:
          Block: {}
```

#### 4.2.2 VPCフローログ

```yaml
VPCFlowLogs:
  TrafficType: ALL
  LogDestinationType: cloud-watch-logs
  LogGroupName: /aws/vpc/flowlogs
  RetentionInDays: 30
  LogFormat: ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${action}
```

### 4.3 暗号化設計

```yaml
Encryption:
  AtRest:
    RDS:
      Enabled: true
      KmsKeyId: alias/aws/rds
    S3:
      DefaultEncryption: AES256
      BucketKeyEnabled: true
    EBS:
      Encrypted: true
      KmsKeyId: alias/aws/ebs
    Elasticsearch:
      EncryptionAtRestEnabled: true
      NodeToNodeEncryptionEnabled: true
      
  InTransit:
    ALB:
      Protocol: HTTPS
      SSLPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06
    RDS:
      ForceSSL: true
    Elasticsearch:
      EnforceHTTPS: true
```

## 5. 監視・ログ設計

### 5.1 CloudWatch設定

```yaml
CloudWatch:
  Dashboards:
    - Name: lawfinder-overview
      Widgets:
        - Type: Line
          Metrics:
            - Namespace: AWS/ECS
              MetricName: CPUUtilization
              Dimensions:
                - Name: ServiceName
                  Value: lawfinder-api
        - Type: Number
          Metrics:
            - Namespace: AWS/ApplicationELB
              MetricName: TargetResponseTime
              Stat: Average
              
  Alarms:
    - Name: high-cpu-api
      MetricName: CPUUtilization
      Namespace: AWS/ECS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      
    - Name: rds-connection-count
      MetricName: DatabaseConnections
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 180
      ComparisonOperator: GreaterThanThreshold
      
  LogGroups:
    - Name: /ecs/lawfinder-api
      RetentionInDays: 30
    - Name: /ecs/lawfinder-frontend
      RetentionInDays: 14
    - Name: /aws/rds/instance/lawfinder-db/postgresql
      RetentionInDays: 7
```

### 5.2 アプリケーションログ

```yaml
Logging:
  Format: JSON
  Fields:
    - timestamp
    - level
    - message
    - request_id
    - user_id
    - ip_address
    - user_agent
    - response_time
    - status_code
    
  Levels:
    Production: INFO
    Staging: DEBUG
    Development: DEBUG
    
  Destinations:
    - CloudWatch Logs
    - S3 (長期保管)
```

### 5.3 メトリクス収集

```yaml
Metrics:
  Application:
    - Name: api_request_count
      Type: Counter
      Tags: [endpoint, method, status]
    - Name: api_request_duration
      Type: Histogram
      Tags: [endpoint, method]
    - Name: database_query_duration
      Type: Histogram
      Tags: [query_type]
    - Name: cache_hit_rate
      Type: Gauge
      Tags: [cache_name]
      
  Custom:
    - Name: law_search_count
      Type: Counter
      Tags: [search_type, result_count]
    - Name: reference_analysis_duration
      Type: Histogram
      Tags: [depth, law_count]
```

## 6. バックアップ・災害復旧設計

### 6.1 バックアップ戦略

```yaml
BackupStrategy:
  RDS:
    AutomatedBackups:
      RetentionPeriod: 30
      BackupWindow: "17:00-18:00"
    Snapshots:
      Frequency: Daily
      RetentionPeriod: 90
      CrossRegionCopy:
        Enabled: true
        DestinationRegion: ap-northeast-3
        
  Elasticsearch:
    Snapshots:
      Repository: s3://lawfinder-backup-prod/elasticsearch
      Frequency: Daily
      RetentionPeriod: 14
      
  S3:
    CrossRegionReplication:
      Enabled: true
      DestinationBucket: lawfinder-backup-dr
      DestinationRegion: ap-northeast-3
      
  ApplicationData:
    ExportFrequency: Weekly
    Format: JSON
    Destination: s3://lawfinder-backup-prod/exports/
```

### 6.2 災害復旧計画

```yaml
DisasterRecovery:
  RPO: 24 hours  # Recovery Point Objective
  RTO: 4 hours   # Recovery Time Objective
  
  Strategy: Pilot Light
  
  DRRegion: ap-northeast-3 (大阪)
  
  Components:
    Database:
      Method: Automated Backups + Read Replica
      SwitchoverTime: 30 minutes
      
    Application:
      Method: Pre-configured AMIs + Auto Scaling
      DeploymentTime: 45 minutes
      
    Static Assets:
      Method: S3 Cross-Region Replication
      SwitchoverTime: Immediate
      
  Procedures:
    - Step: Detect Failure
      Time: 0-15 minutes
      Actions:
        - CloudWatch Alarms trigger
        - Incident response team notified
        
    - Step: Assess Impact
      Time: 15-30 minutes
      Actions:
        - Determine scope of failure
        - Decision to activate DR
        
    - Step: Activate DR
      Time: 30-240 minutes
      Actions:
        - Promote RDS Read Replica
        - Deploy application stack
        - Update DNS records
        - Verify functionality
```

## 7. スケーリング設計

### 7.1 オートスケーリング設定

```yaml
AutoScaling:
  ECS:
    Frontend:
      MetricType: TargetTrackingScaling
      TargetValue: 70
      Metrics:
        - CPUUtilization
        - MemoryUtilization
      ScaleOutCooldown: 60
      ScaleInCooldown: 300
      
    API:
      MetricType: TargetTrackingScaling
      Policies:
        - Name: cpu-scaling
          MetricType: CPUUtilization
          TargetValue: 60
        - Name: request-count-scaling
          MetricType: RequestCountPerTarget
          TargetValue: 1000
          
  RDS:
    ReadReplicas:
      MinCount: 1
      MaxCount: 5
      Triggers:
        - CPUUtilization > 70%
        - ReadIOPS > 10000
        
  Elasticsearch:
    DataNodes:
      MinCount: 3
      MaxCount: 10
      Triggers:
        - CPUUtilization > 80%
        - JVMMemoryPressure > 85%
```

### 7.2 負荷分散設計

```yaml
LoadBalancing:
  ALB:
    Algorithm: least_outstanding_requests
    HealthCheck:
      Path: /health
      Interval: 30
      Timeout: 5
      HealthyThreshold: 2
      UnhealthyThreshold: 3
      
    TargetGroups:
      - Name: frontend-tg
        Port: 3000
        Protocol: HTTP
        DeregistrationDelay: 30
        
      - Name: api-tg
        Port: 4000
        Protocol: HTTP
        DeregistrationDelay: 60
        
  CrossZoneLoadBalancing: true
  ConnectionDraining:
    Enabled: true
    Timeout: 300
```

## 8. コスト最適化

### 8.1 リソース最適化

```yaml
CostOptimization:
  ComputeSavings:
    - Type: Fargate Spot
      Usage: 70%
      SavingsEstimate: 50%
      
    - Type: Reserved Instances
      Coverage:
        RDS: 100%
        ElastiCache: 100%
        Elasticsearch: 50%
      Term: 1 year
      PaymentOption: All Upfront
      SavingsEstimate: 30%
      
  StorageSavings:
    - Type: S3 Intelligent-Tiering
      ApplicableBuckets:
        - lawfinder-data-prod
      SavingsEstimate: 20%
      
    - Type: EBS gp3
      Migration: gp2 to gp3
      SavingsEstimate: 20%
      
  DataTransferSavings:
    - Type: VPC Endpoints
      Services:
        - S3
        - DynamoDB
      SavingsEstimate: $500/month
```

### 8.2 月間コスト見積もり

```yaml
MonthlyCostEstimate:
  Production:
    Compute:
      ECS Fargate: $500
      Load Balancers: $25
    Storage:
      RDS: $400
      Elasticsearch: $600
      S3: $100
      EBS: $50
    Network:
      Data Transfer: $200
      CloudFront: $100
    Others:
      Route53: $10
      CloudWatch: $50
    Total: $2,035/month
    
  Staging:
    Total: $500/month
    
  Development:
    Total: $200/month
    
  GrandTotal: $2,735/month
```

## 9. 環境別設定

### 9.1 本番環境

```yaml
Production:
  Characteristics:
    - High Availability (Multi-AZ)
    - Auto Scaling enabled
    - Full backup and DR
    - Enhanced monitoring
    - WAF protection
    
  Sizing:
    ECS:
      Frontend: 2-10 tasks
      API: 3-20 tasks
    RDS: db.r6g.xlarge (Multi-AZ)
    Elasticsearch: 3x r6g.large
    Redis: 3x cache.r6g.xlarge
```

### 9.2 ステージング環境

```yaml
Staging:
  Characteristics:
    - Single AZ deployment
    - Limited Auto Scaling
    - Daily backups only
    - Basic monitoring
    
  Sizing:
    ECS:
      Frontend: 1 task
      API: 2 tasks
    RDS: db.t3.medium
    Elasticsearch: 1x t3.medium
    Redis: 1x cache.t3.micro
```

### 9.3 開発環境

```yaml
Development:
  Characteristics:
    - Minimal resources
    - No HA requirements
    - On-demand only
    
  Sizing:
    ECS:
      Frontend: 1 task
      API: 1 task
    RDS: db.t3.micro
    Elasticsearch: 1x t3.small
    Redis: 1x cache.t3.micro
```

## 10. デプロイメント設計

### 10.1 CI/CDパイプライン

```yaml
CICD:
  Source:
    Provider: GitHub
    Branches:
      Production: main
      Staging: staging
      Development: develop
      
  Build:
    Provider: GitHub Actions
    Steps:
      - Checkout code
      - Run tests
      - Build Docker images
      - Push to ECR
      - Update task definitions
      
  Deploy:
    Strategy: Blue/Green
    Provider: ECS with CodeDeploy
    ValidationTests:
      - Health check endpoints
      - Smoke tests
      - Performance tests
    RollbackTriggers:
      - Error rate > 5%
      - Response time > 3s
```

### 10.2 インフラストラクチャ as Code

```yaml
IaC:
  Tool: Terraform
  StateBackend: S3 + DynamoDB
  
  Modules:
    - networking/
      - vpc.tf
      - subnets.tf
      - security_groups.tf
    - compute/
      - ecs.tf
      - auto_scaling.tf
    - data/
      - rds.tf
      - elasticsearch.tf
      - redis.tf
    - monitoring/
      - cloudwatch.tf
      - alarms.tf
      
  Environments:
    Managed: [dev, staging, prod]
    Workspaces: true
```

## 11. 運用手順書

### 11.1 日次運用

```yaml
DailyOperations:
  - Task: バックアップ確認
    Time: 09:00 JST
    Actions:
      - RDS自動バックアップの確認
      - S3レプリケーション状態の確認
      
  - Task: 監視ダッシュボード確認
    Time: 09:30 JST
    Actions:
      - CloudWatchダッシュボードの確認
      - アラート履歴の確認
      
  - Task: コスト確認
    Time: 10:00 JST
    Actions:
      - Cost Explorerで前日のコスト確認
      - 異常な増加がないか確認
```

### 11.2 週次運用

```yaml
WeeklyOperations:
  - Task: セキュリティ監査
    Day: Monday
    Actions:
      - GuardDuty findings確認
      - Security Hub compliance確認
      - IAM Access Analyzer確認
      
  - Task: パフォーマンスレビュー
    Day: Wednesday
    Actions:
      - RDS Performance Insights確認
      - ECS Container Insights確認
      - 最適化提案の検討
      
  - Task: バックアップテスト
    Day: Friday
    Actions:
      - RDSスナップショットからの復元テスト
      - S3オブジェクトの復元テスト
```

## 12. トラブルシューティング

### 12.1 一般的な問題と対処

| 問題 | 症状 | 対処方法 |
|------|------|----------|
| ECSタスク起動失敗 | タスクがPENDING状態で停止 | 1. CloudWatchログ確認<br>2. タスク定義の確認<br>3. IAMロール権限確認 |
| RDS接続エラー | Connection timeout | 1. セキュリティグループ確認<br>2. RDSステータス確認<br>3. 接続数上限確認 |
| ALBヘルスチェック失敗 | Unhealthy targets | 1. アプリケーションログ確認<br>2. ヘルスチェックパス確認<br>3. タイムアウト設定確認 |
| 高レイテンシ | 応答時間 > 3秒 | 1. CloudWatch Insightsで分析<br>2. RDS slow query log確認<br>3. オートスケーリング確認 |

### 12.2 緊急時対応

```yaml
IncidentResponse:
  Severity1:  # サービス全体停止
    ResponseTime: 15 minutes
    Escalation:
      - OnCall Engineer
      - Team Lead
      - CTO
    Actions:
      - 影響範囲の特定
      - 暫定対処の実施
      - ステークホルダーへの連絡
      
  Severity2:  # 部分的な機能停止
    ResponseTime: 30 minutes
    Escalation:
      - OnCall Engineer
      - Team Lead
    Actions:
      - 影響機能の切り離し
      - 代替手段の提供
      
  Severity3:  # パフォーマンス劣化
    ResponseTime: 1 hour
    Escalation:
      - OnCall Engineer
    Actions:
      - メトリクス分析
      - スケーリング調整
```

## 13. セキュリティ運用

### 13.1 定期的なセキュリティタスク

```yaml
SecurityOperations:
  Daily:
    - GuardDuty findings review
    - WAF blocked requests analysis
    - Failed login attempts monitoring
    
  Weekly:
    - Security patches assessment
    - IAM permissions audit
    - Unused resources cleanup
    
  Monthly:
    - Penetration testing
    - Compliance report generation
    - Security training
    
  Quarterly:
    - Full security audit
    - DR drill execution
    - Access key rotation
```

### 13.2 コンプライアンス

```yaml
Compliance:
  Standards:
    - ISO 27001
    - PCI DSS (該当する場合)
    - 個人情報保護法
    
  Controls:
    - データ暗号化（保存時・転送時）
    - アクセスログの記録
    - 定期的な脆弱性スキャン
    - インシデント対応手順
    
  Audit:
    Frequency: Annual
    Scope:
      - Infrastructure security
      - Application security
      - Data protection
      - Access management
```

## 14. 改訂履歴

| バージョン | 日付 | 変更内容 |
|----------|------|----------|
| 1.0 | 2025-08-03 | 初版作成 |

## 付録A: Terraformサンプルコード

```hcl
# VPC設定
module "vpc" {
  source = "terraform-aws-modules/vpc/aws"
  version = "~> 5.0"
  
  name = "lawfinder-vpc"
  cidr = "10.0.0.0/16"
  
  azs             = ["ap-northeast-1a", "ap-northeast-1c", "ap-northeast-1d"]
  private_subnets = ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]
  public_subnets  = ["10.0.11.0/24", "10.0.12.0/24", "10.0.13.0/24"]
  database_subnets = ["10.0.21.0/24", "10.0.22.0/24", "10.0.23.0/24"]
  
  enable_nat_gateway = true
  enable_vpn_gateway = false
  enable_dns_hostnames = true
  enable_dns_support = true
  
  tags = {
    Environment = var.environment
    Project = "LawFinder"
  }
}

# ECS Cluster
resource "aws_ecs_cluster" "main" {
  name = "lawfinder-${var.environment}"
  
  setting {
    name  = "containerInsights"
    value = "enabled"
  }
  
  tags = {
    Environment = var.environment
    Project = "LawFinder"
  }
}
```

## 付録B: 監視ダッシュボード設定

```json
{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["AWS/ECS", "CPUUtilization", "ServiceName", "lawfinder-api"],
          [".", "MemoryUtilization", ".", "."]
        ],
        "period": 300,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "ECS API Service Metrics"
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["AWS/ApplicationELB", "TargetResponseTime", "LoadBalancer", "app/lawfinder-alb/*"],
          [".", "RequestCount", ".", ".", { "stat": "Sum" }]
        ],
        "period": 60,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "ALB Performance"
      }
    }
  ]
}
```