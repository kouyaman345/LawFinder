# インフラ設計書

**プロジェクト名**: LawFinder  
**作成日**: 2025年8月3日  
**バージョン**: 1.0  
**作成者**: インフラチーム

## 1. 概要

### 1.1 目的
本書は、LawFinderシステムのインフラストラクチャ設計を定義する。高可用性、スケーラビリティ、セキュリティを確保したクラウドネイティブなアーキテクチャを提供する。

### 1.2 スコープ
- Phase 1: 静的サイトホスティング環境
- Phase 2: フルスタックアプリケーション環境
- 開発、ステージング、本番環境の構成
- 災害復旧（DR）およびバックアップ戦略

### 1.3 クラウドプロバイダー
- **メイン**: Azure
- **CDN**: Azure Front Door

## 2. アーキテクチャ概要

### 2.1 Phase 1: 静的サイトアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        インターネット                         │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    CloudFlare CDN                            │
│  ・DDoS保護                                                  │
│  ・SSL/TLS終端                                               │
│  ・キャッシング                                              │
│  ・WAF                                                       │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  Azure Front Door                            │
│  ・グローバル配信                                            │
│  ・圧縮配信                                                  │
│  ・カスタムエラーページ                                      │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Azure Blob Storage                         │
│  ┌─────────────────────────────────────┐                   │
│  │  静的ウェブサイトホスティング        │                   │
│  │  ・HTMLファイル（約10,000ファイル）  │                   │
│  │  ・JavaScript/CSS                    │                   │
│  │  ・検索インデックス（JSON）         │                   │
│  │  ・画像/アセット                    │                   │
│  └─────────────────────────────────────┘                   │
│                                                              │
│  コンテナー構成:                                             │
│  ・lawfinder-static-prod                                     │
│  ・lawfinder-static-staging                                  │
│  ・lawfinder-static-backup                                   │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 Phase 2: フルスタックアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        インターネット                         │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Azure DNS                                  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                Azure Front Door (CDN)                        │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│         Azure Application Gateway / Load Balancer            │
│  ・HTTPS終端                                                 │
│  ・パスベースルーティング                                    │
│  ・ヘルスチェック                                           │
└───────────────────────────┬─────────────────────────────────┘
                            │
         ┌──────────────────┴──────────────────┐
         ▼                                     ▼
┌─────────────────────┐             ┌─────────────────────┐
│ Container Instances │             │ Container Instances │
│  ┌───────────────┐  │             │  ┌───────────────┐  │
│  │ Frontend      │  │             │  │ API Server    │  │
│  │ (Next.js)     │  │             │  │ (Node.js)     │  │
│  └───────────────┘  │             │  └───────────────┘  │
│  Auto Scaling       │             │  Auto Scaling       │
└─────────────────────┘             └─────────────────────┘
         │                                     │
         └──────────────────┬──────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    データ層 (VNet内)                         │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │Azure Database│ Cosmos DB/  │Azure        │Azure Cache  │ │
│  │for PostgreSQL│   Neo4j     │Cognitive    │for Redis    │ │
│  │ Zone         │             │Search       │             │ │
│  │ Redundant    │             │             │             │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## 3. Azure リソース詳細設計

### 3.1 ネットワーク設計

#### 3.1.1 VPC構成

```yaml
VNet:
  Name: lawfinder-vnet
  AddressSpace: 10.0.0.0/16
  Location: japaneast (東日本)
  
  AvailabilityZones:
    - Zone 1
    - Zone 2
    - Zone 3

Subnets:
  Public:
    - Name: public-subnet-1
      AddressPrefix: 10.0.1.0/24
      Zone: 1
    - Name: public-subnet-2
      AddressPrefix: 10.0.2.0/24
      Zone: 2
    - Name: public-subnet-3
      AddressPrefix: 10.0.3.0/24
      Zone: 3
      
  Private:
    - Name: private-subnet-1
      AddressPrefix: 10.0.11.0/24
      Zone: 1
    - Name: private-subnet-2
      AddressPrefix: 10.0.12.0/24
      Zone: 2
    - Name: private-subnet-3
      AddressPrefix: 10.0.13.0/24
      Zone: 3
      
  Database:
    - Name: db-subnet-1
      AddressPrefix: 10.0.21.0/24
      Zone: 1
    - Name: db-subnet-2
      AddressPrefix: 10.0.22.0/24
      Zone: 2
```

#### 3.1.2 ネットワークセキュリティグループ

```yaml
NetworkSecurityGroups:
  - Name: appgw-nsg
    Rules:
      Inbound:
        - Priority: 100
          Protocol: tcp
          Port: 443
          Source: Internet
        - Priority: 101
          Protocol: tcp
          Port: 80
          Source: Internet
      Outbound:
        - Priority: 100
          Protocol: Any
          Port: Any
          Destination: Any
          
  - Name: container-frontend-nsg
    Rules:
      Inbound:
        - Priority: 100
          Protocol: tcp
          Port: 3000
          Source: appgw-nsg
      Outbound:
        - Priority: 100
          Protocol: Any
          Port: Any
          Destination: Any
          
  - Name: container-api-nsg
    Rules:
      Inbound:
        - Priority: 100
          Protocol: tcp
          Port: 4000
          Source: appgw-nsg
      Outbound:
        - Priority: 100
          Protocol: Any
          Port: Any
          Destination: Any
          
  - Name: database-nsg
    Rules:
      Inbound:
        - Priority: 100
          Protocol: tcp
          Port: 5432
          Source: container-api-nsg
      Outbound:
        - Priority: 100
          Protocol: Any
          Port: Any
          Destination: Any
```

### 3.2 コンピュート設計

#### 3.2.1 Container Instances設定

```yaml
ContainerInstances:
  ResourceGroup:
    Name: lawfinder-containers-rg
    Location: japaneast
      
  Containers:
    Frontend:
      Name: lawfinder-frontend
      ContainerGroup:
        Name: lawfinder-frontend-group
        CPU: 1  # 1 vCPU
        Memory: 2  # 2 GB
        Container:
          Name: frontend
          Image: lawfinder.azurecr.io/frontend:latest
          Port: 3000
          Environment:
            - Name: NODE_ENV
              Value: production
            - Name: API_URL
              Value: https://api.lawfinder.jp
      InstanceCount: 2
      AutoScaling:
        MinReplicas: 2
        MaxReplicas: 10
        Rules:
          - MetricType: CPU
            Threshold: 70
          - MetricType: Memory
            Threshold: 80
        
    API:
      Name: lawfinder-api
      ContainerGroup:
        Name: lawfinder-api-group
        CPU: 2  # 2 vCPU
        Memory: 4  # 4 GB
        Container:
          Name: api
          Image: lawfinder.azurecr.io/api:latest
          Port: 4000
          SecureEnvironment:
            - Name: DB_PASSWORD
              SecureValue: KeyVaultSecret
      InstanceCount: 3
      AutoScaling:
        MinReplicas: 3
        MaxReplicas: 20
        Rules:
          - MetricType: CPU
            Threshold: 60
          - MetricType: Memory
            Threshold: 70
```

### 3.3 データストア設計

#### 3.3.1 Azure Database for PostgreSQL

```yaml
AzurePostgreSQL:
  ServerName: lawfinder-db
  Version: "15"
  Tier: GeneralPurpose
  ComputeGeneration: Gen5
  VCores: 4
  StorageMB: 102400  # 100 GB
  StorageIOPS: 3000
  HighAvailability:
    Mode: ZoneRedundant
    StandbyAvailabilityZone: 2
  BackupRetentionDays: 30
  GeoRedundantBackup: Enabled
  MaintenanceWindow:
    DayOfWeek: 0  # Sunday
    StartHour: 18
    StartMinute: 0
  ServerParameters:
    max_connections: 200
    shared_buffers: 524288  # 2GB in 8KB pages
    effective_cache_size: 1572864  # 6GB in 8KB pages
    work_mem: 16384  # 16MB in KB
    maintenance_work_mem: 524288  # 512MB in KB
```

#### 3.3.2 Azure Cognitive Search

```yaml
CognitiveSearch:
  ServiceName: lawfinder-search
  Sku: Standard3  # S3
  ReplicaCount: 3
  PartitionCount: 1
  HostingMode: Default
  Location: japaneast
  Features:
    - SemanticSearch: Enabled
    - KnowledgeStore: Enabled
    - PrivateEndpoints: Enabled
  Limits:
    MaxFieldsPerIndex: 1000
    MaxIndexesPerService: 200
    MaxIndexerDatasources: 30
    MaxIndexers: 30
    MaxSkillsetsPerService: 30
    MaxSynonymMaps: 30
```

#### 3.3.3 Azure Cache for Redis

```yaml
AzureRedis:
  Name: lawfinder-cache
  Sku:
    Name: Premium
    Family: P
    Capacity: 3  # P3
  RedisVersion: "6.0"
  EnableNonSslPort: false
  ShardCount: 3
  ZoneRedundancy: Enabled
  RedisConfiguration:
    maxmemory-policy: allkeys-lru
    maxfragmentationmemory-reserved: 50
    maxmemory-reserved: 50
  PersistenceSettings:
    RdbEnabled: true
    RdbFrequency: 60  # minutes
    RdbStorageConnectionString: DefaultEndpointsProtocol=https
```

### 3.4 ストレージ設計

#### 3.4.1 Blob Storageコンテナー構成

```yaml
BlobContainers:
  - Name: lawfinder-static-prod
    StorageAccount: lawfinderstorageprod
    PublicAccess: Blob  # 静的ホスティング用
    StaticWebsite:
      Enabled: true
      IndexDocument: index.html
      ErrorDocument404Path: error.html
    Versioning: Enabled
    LifecycleManagement:
      - Name: delete-old-versions
        Actions:
          Version:
            Delete:
              DaysAfterCreation: 30
          
  - Name: lawfinder-data-prod
    StorageAccount: lawfinderstorageprod
    PublicAccess: None
    Encryption:
      Services:
        Blob:
          Enabled: true
    LifecycleManagement:
      - Name: archive-old-data
        Actions:
          BaseBlob:
            TierToCool:
              DaysAfterModification: 90
            TierToArchive:
              DaysAfterModification: 180
            
  - Name: lawfinder-backup-prod
    StorageAccount: lawfinderstoragebackup
    PublicAccess: None
    Encryption:
      KeySource: Microsoft.Keyvault
      KeyVaultProperties:
        KeyName: storage-encryption-key
    ObjectReplication:
      - DestinationAccount: lawfinderstoragedr
        Rules:
          - SourceContainer: lawfinder-backup-prod
            DestinationContainer: lawfinder-backup-dr
            MinCreationTime: "2025-01-01T00:00:00Z"
```

## 4. セキュリティ設計

### 4.1 Azure RBACロール設計

```yaml
RBACRoles:
  - Name: lawfinder-container-role
    AssignableScopes:
      - /subscriptions/{subscription-id}
    Permissions:
      - DataActions:
          - Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read
          - Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write
        NotDataActions: []
      - Actions:
          - Microsoft.KeyVault/vaults/secrets/read
          - Microsoft.Insights/Logs/Write
        NotActions: []
        
  - Name: lawfinder-backup-role
    AssignableScopes:
      - /subscriptions/{subscription-id}
    Permissions:
      - Actions:
          - Microsoft.DBforPostgreSQL/servers/backups/write
          - Microsoft.DBforPostgreSQL/servers/backups/read
          - Microsoft.Cache/redis/export/action
          - Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems/backup/action
        NotActions: []
        
ManagedIdentities:
  - Name: lawfinder-container-identity
    Type: SystemAssigned
    ResourceTypes:
      - Microsoft.ContainerInstance/containerGroups
    RoleAssignments:
      - Role: lawfinder-container-role
        Scope: /subscriptions/{subscription-id}/resourceGroups/lawfinder-rg
```

### 4.2 ネットワークセキュリティ

#### 4.2.1 Azure WAF設定

```yaml
WAF:
  PolicyName: lawfinder-waf-policy
  PolicyMode: Prevention
  CustomRules:
    - Name: RateLimitRule
      Priority: 1
      RuleType: RateLimitRule
      RateLimitThreshold: 2000
      RateLimitDurationInMinutes: 1
      MatchConditions:
        - MatchVariable: RemoteAddr
          Operator: IPMatch
          MatchValues: ["0.0.0.0/0"]
      Action: Block
      
    - Name: GeoMatchRule
      Priority: 2
      RuleType: MatchRule
      MatchConditions:
        - MatchVariable: RemoteAddr
          Operator: GeoMatch
          NegationCondition: true
          MatchValues: ["JP", "US"]
      Action: Block
      
  ManagedRuleSets:
    - RuleSetType: OWASP
      RuleSetVersion: "3.2"
      RuleGroupOverrides:
        - RuleGroupName: REQUEST-942-APPLICATION-ATTACK-SQLI
          Rules:
            - RuleId: 942100
              Action: Block
```

#### 4.2.2 NSGフローログ

```yaml
NSGFlowLogs:
  Enabled: true
  Version: 2
  StorageAccount: lawfinderlogsstorage
  RetentionDays: 30
  TrafficAnalytics:
    Enabled: true
    WorkspaceId: lawfinder-la-workspace
    WorkspaceRegion: japaneast
    WorkspaceResourceId: /subscriptions/{subscription-id}/resourcegroups/lawfinder-rg/providers/microsoft.operationalinsights/workspaces/lawfinder-la-workspace
```

### 4.3 暗号化設計

```yaml
Encryption:
  AtRest:
    PostgreSQL:
      InfrastructureEncryption: Enabled
      CMKEnabled: true
    Storage:
      Services:
        Blob:
          Enabled: true
          KeyType: Account
    Disks:
      EncryptionAtHost: true
      DiskEncryptionSet: lawfinder-des
    CognitiveSearch:
      EncryptionWithCMK: Enabled
      
  InTransit:
    ApplicationGateway:
      Protocol: HTTPS
      SSLPolicy:
        PolicyType: Predefined
        PolicyName: AppGwSslPolicy20220101
        MinProtocolVersion: TLSv1_2
    PostgreSQL:
      SSLEnforcement: Enabled
      MinimalTLSVersion: TLS1_2
    CognitiveSearch:
      EnforceHTTPS: true
```

## 5. 監視・ログ設計

### 5.1 Azure Monitor設定

```yaml
AzureMonitor:
  Dashboards:
    - Name: lawfinder-overview
      ResourceGroup: lawfinder-rg
      Tiles:
        - Type: LineChart
          Metrics:
            - ResourceType: Microsoft.ContainerInstance/containerGroups
              MetricName: CpuUsage
              Aggregation: Average
              ContainerGroup: lawfinder-api-group
        - Type: SingleValue
          Metrics:
            - ResourceType: Microsoft.Network/applicationGateways
              MetricName: ResponseTime
              Aggregation: Average
              
  Alerts:
    - Name: high-cpu-api
      Scopes:
        - /subscriptions/{subscription-id}/resourceGroups/lawfinder-rg/providers/Microsoft.ContainerInstance/containerGroups/lawfinder-api-group
      Condition:
        MetricName: CpuUsage
        Operator: GreaterThan
        Threshold: 80
        TimeAggregation: Average
        WindowSize: PT5M
        Frequency: PT1M
      
    - Name: postgres-connection-count
      Scopes:
        - /subscriptions/{subscription-id}/resourceGroups/lawfinder-rg/providers/Microsoft.DBforPostgreSQL/servers/lawfinder-db
      Condition:
        MetricName: active_connections
        Operator: GreaterThan
        Threshold: 180
        TimeAggregation: Average
        WindowSize: PT5M
      
  LogAnalytics:
    WorkspaceName: lawfinder-la-workspace
    RetentionInDays: 30
    DailyQuotaGb: 5
    Tables:
      - ContainerInstanceLog_CL
      - AppGatewayAccessLog_CL
      - PostgreSQLLogs_CL
```

### 5.2 アプリケーションログ

```yaml
Logging:
  Format: JSON
  Fields:
    - timestamp
    - level
    - message
    - request_id
    - user_id
    - ip_address
    - user_agent
    - response_time
    - status_code
    
  Levels:
    Production: INFO
    Staging: DEBUG
    Development: DEBUG
    
  Destinations:
    - Azure Monitor Logs
    - Blob Storage (長期保管)
```

### 5.3 メトリクス収集

```yaml
Metrics:
  Application:
    - Name: api_request_count
      Type: Counter
      Tags: [endpoint, method, status]
    - Name: api_request_duration
      Type: Histogram
      Tags: [endpoint, method]
    - Name: database_query_duration
      Type: Histogram
      Tags: [query_type]
    - Name: cache_hit_rate
      Type: Gauge
      Tags: [cache_name]
      
  Custom:
    - Name: law_search_count
      Type: Counter
      Tags: [search_type, result_count]
    - Name: reference_analysis_duration
      Type: Histogram
      Tags: [depth, law_count]
```

## 6. バックアップ・災害復旧設計

### 6.1 バックアップ戦略

```yaml
BackupStrategy:
  PostgreSQL:
    AutomatedBackups:
      RetentionDays: 30
      BackupTime: "17:00"  # UTC
      GeoRedundant: true
    LongTermRetention:
      WeeklyRetention: P4W
      MonthlyRetention: P12M
      YearlyRetention: P5Y
      WeekOfYear: 1
        
  CognitiveSearch:
    Backup:
      Frequency: Daily
      Container: lawfinder-search-backup
      RetentionDays: 14
      
  BlobStorage:
    GeoReplication:
      Type: RA-GRS  # Read-Access Geo-Redundant Storage
      SecondaryRegion: japanwest
      
  ApplicationData:
    ExportFrequency: Weekly
    Format: JSON
    Destination: https://lawfinderstorage.blob.core.windows.net/exports/
    
  RecoveryServices:
    VaultName: lawfinder-rsv
    Policies:
      - Name: DailyBackupPolicy
        Schedule:
          ScheduleRunFrequency: Daily
          ScheduleRunTimes: ["2:00"]  # JST
        Retention:
          Daily: 30
          Weekly: 12
          Monthly: 12
          Yearly: 5
```

### 6.2 災害復旧計画

```yaml
DisasterRecovery:
  RPO: 24 hours  # Recovery Point Objective
  RTO: 4 hours   # Recovery Time Objective
  
  Strategy: Pilot Light
  
  DRRegion: japanwest (西日本)
  
  Components:
    Database:
      Method: Geo-Redundant Backups + Geo-Replica
      SwitchoverTime: 30 minutes
      
    Application:
      Method: Container Registry + Auto Scaling
      DeploymentTime: 45 minutes
      
    Static Assets:
      Method: Geo-Redundant Storage
      SwitchoverTime: Immediate
      
  Procedures:
    - Step: Detect Failure
      Time: 0-15 minutes
      Actions:
        - Azure Monitor Alerts trigger
        - Incident response team notified
        
    - Step: Assess Impact
      Time: 15-30 minutes
      Actions:
        - Determine scope of failure
        - Decision to activate DR
        
    - Step: Activate DR
      Time: 30-240 minutes
      Actions:
        - Failover to Geo-Replica
        - Deploy application stack
        - Update DNS records
        - Verify functionality
```

## 7. スケーリング設計

### 7.1 オートスケーリング設定

```yaml
AutoScaling:
  ContainerInstances:
    Frontend:
      ScaleType: Automatic
      TargetValue: 70
      Metrics:
        - CpuPercentage
        - MemoryPercentage
      CooldownPeriod: 60
      ScaleInCooldown: 300
      
    API:
      ScaleType: Automatic
      Rules:
        - Name: cpu-scaling
          MetricType: CpuPercentage
          Threshold: 60
          Operator: GreaterThan
          ScaleAction: Increase
          ChangeCount: 1
        - Name: request-count-scaling
          MetricType: Custom
          MetricName: RequestsPerSecond
          Threshold: 1000
          
  PostgreSQL:
    ReadReplicas:
      MinCount: 1
      MaxCount: 5
      AutoScaleTriggers:
        - cpu_percent > 70
        - io_consumption_percent > 80
        
  CognitiveSearch:
    Replicas:
      MinCount: 1
      MaxCount: 12
      AutoScaleTriggers:
        - SearchLatency > 100ms
        - IndexingRate < 1000docs/sec
```

### 7.2 負荷分散設計

```yaml
LoadBalancing:
  ApplicationGateway:
    RoutingRule:
      Type: PathBasedRouting
    HealthProbe:
      Path: /health
      Interval: 30
      Timeout: 30
      UnhealthyThreshold: 3
      PickHostNameFromBackendHttpSettings: true
      
    BackendPools:
      - Name: frontend-pool
        BackendAddresses:
          - IpAddress: Dynamic  # Container IPs
        BackendHttpSettings:
          Port: 3000
          Protocol: Http
          RequestTimeout: 30
          ConnectionDraining:
            Enabled: true
            DrainTimeoutInSec: 30
        
      - Name: api-pool
        BackendAddresses:
          - IpAddress: Dynamic  # Container IPs
        BackendHttpSettings:
          Port: 4000
          Protocol: Http
          RequestTimeout: 60
          ConnectionDraining:
            Enabled: true
            DrainTimeoutInSec: 60
        
  LoadDistribution: Default
  EnableHttp2: true
```

## 8. コスト最適化

### 8.1 リソース最適化

```yaml
CostOptimization:
  ComputeSavings:
    - Type: Spot Instances
      Usage: 70%
      SavingsEstimate: 50%
      
    - Type: Reserved Instances
      Coverage:
        PostgreSQL: 100%
        Redis: 100%
        CognitiveSearch: 50%
      Term: 1 year
      PaymentOption: All Upfront
      SavingsEstimate: 30%
      
  StorageSavings:
    - Type: Lifecycle Management
      ApplicableContainers:
        - lawfinder-data-prod
      Tiers:
        - Hot: 0-30 days
        - Cool: 31-90 days
        - Archive: 91+ days
      SavingsEstimate: 25%
      
    - Type: Reserved Capacity
      Service: Blob Storage
      ReservedGB: 10000
      Term: 1 year
      SavingsEstimate: 20%
      
  DataTransferSavings:
    - Type: Private Endpoints
      Services:
        - Storage
        - PostgreSQL
        - CognitiveSearch
      SavingsEstimate: $500/month
```

### 8.2 月間コスト見積もり

```yaml
MonthlyCostEstimate:
  Production:
    Compute:
      Container Instances: $480
      Application Gateway: $30
    Storage:
      PostgreSQL: $420
      Cognitive Search: $580
      Blob Storage: $95
      Managed Disks: $45
    Network:
      Data Transfer: $180
      Front Door: $90
    Others:
      DNS: $12
      Monitor: $55
    Total: $1,987/month
    
  Staging:
    Total: $480/month
    
  Development:
    Total: $190/month
    
  GrandTotal: $2,657/month
```

## 9. 環境別設定

### 9.1 本番環境

```yaml
Production:
  Characteristics:
    - High Availability (Multi-AZ)
    - Auto Scaling enabled
    - Full backup and DR
    - Enhanced monitoring
    - WAF protection
    
  Sizing:
    ContainerInstances:
      Frontend: 2-10 instances
      API: 3-20 instances
    PostgreSQL: GP_Gen5_4 (Zone Redundant)
    CognitiveSearch: Standard S3
    Redis: Premium P3
```

### 9.2 ステージング環境

```yaml
Staging:
  Characteristics:
    - Single AZ deployment
    - Limited Auto Scaling
    - Daily backups only
    - Basic monitoring
    
  Sizing:
    ContainerInstances:
      Frontend: 1 instance
      API: 2 instances
    PostgreSQL: B_Gen5_2
    CognitiveSearch: Basic
    Redis: Basic C0
```

### 9.3 開発環境

```yaml
Development:
  Characteristics:
    - Minimal resources
    - No HA requirements
    - On-demand only
    
  Sizing:
    ContainerInstances:
      Frontend: 1 instance
      API: 1 instance
    PostgreSQL: B_Gen5_1
    CognitiveSearch: Free
    Redis: Basic C0
```

## 10. デプロイメント設計

### 10.1 CI/CDパイプライン

```yaml
CICD:
  Source:
    Provider: GitHub
    Branches:
      Production: main
      Staging: staging
      Development: develop
      
  Build:
    Provider: GitHub Actions
    Steps:
      - Checkout code
      - Run tests
      - Build Docker images
      - Push to ACR
      - Update task definitions
      
  Deploy:
    Strategy: Blue/Green
    Provider: Container Instances with Azure DevOps
    ValidationTests:
      - Health check endpoints
      - Smoke tests
      - Performance tests
    RollbackTriggers:
      - Error rate > 5%
      - Response time > 3s
```

### 10.2 インフラストラクチャ as Code

```yaml
IaC:
  Tool: Terraform
  StateBackend: Blob Storage + Table Storage
  
  Modules:
    - networking/
      - vpc.tf
      - subnets.tf
      - security_groups.tf
    - compute/
      - container_instances.tf
      - auto_scaling.tf
    - data/
      - postgresql.tf
      - cognitive_search.tf
      - redis.tf
    - monitoring/
      - azure_monitor.tf
      - alarms.tf
      
  Environments:
    Managed: [dev, staging, prod]
    Workspaces: true
```

## 11. 運用手順書

### 11.1 日次運用

```yaml
DailyOperations:
  - Task: バックアップ確認
    Time: 09:00 JST
    Actions:
      - PostgreSQL自動バックアップの確認
      - Blob Storageレプリケーション状態の確認
      
  - Task: 監視ダッシュボード確認
    Time: 09:30 JST
    Actions:
      - Azure Monitorダッシュボードの確認
      - アラート履歴の確認
      
  - Task: コスト確認
    Time: 10:00 JST
    Actions:
      - Cost Managementで前日のコスト確認
      - 異常な増加がないか確認
```

### 11.2 週次運用

```yaml
WeeklyOperations:
  - Task: セキュリティ監査
    Day: Monday
    Actions:
      - Security Center alerts確認
      - Policy compliance確認
      - Azure AD Access Reviews確認
      
  - Task: パフォーマンスレビュー
    Day: Wednesday
    Actions:
      - Database Query Performance Insight確認
      - Container Instances metrics確認
      - 最適化提案の検討
      
  - Task: バックアップテスト
    Day: Friday
    Actions:
      - PostgreSQLバックアップからの復元テスト
      - Blob Storageオブジェクトの復元テスト
```

## 12. トラブルシューティング

### 12.1 一般的な問題と対処

| 問題 | 症状 | 対処方法 |
|------|------|----------|
| コンテナー起動失敗 | コンテナーがFailed状態 | 1. Container Instancesログ確認<br>2. イメージ設定の確認<br>3. マネージドID権限確認 |
| PostgreSQL接続エラー | Connection timeout | 1. NSG設定確認<br>2. PostgreSQLステータス確認<br>3. 接続数上限確認 |
| App Gatewayヘルスチェック失敗 | Unhealthy backends | 1. アプリケーションログ確認<br>2. ヘルスプローブパス確認<br>3. タイムアウト設定確認 |
| 高レイテンシ | 応答時間 > 3秒 | 1. Log Analyticsで分析<br>2. Query Performance Insight確認<br>3. オートスケーリング確認 |

### 12.2 緊急時対応

```yaml
IncidentResponse:
  Severity1:  # サービス全体停止
    ResponseTime: 15 minutes
    Escalation:
      - OnCall Engineer
      - Team Lead
      - CTO
    Actions:
      - 影響範囲の特定
      - 暫定対処の実施
      - ステークホルダーへの連絡
      
  Severity2:  # 部分的な機能停止
    ResponseTime: 30 minutes
    Escalation:
      - OnCall Engineer
      - Team Lead
    Actions:
      - 影響機能の切り離し
      - 代替手段の提供
      
  Severity3:  # パフォーマンス劣化
    ResponseTime: 1 hour
    Escalation:
      - OnCall Engineer
    Actions:
      - メトリクス分析
      - スケーリング調整
```

## 13. セキュリティ運用

### 13.1 定期的なセキュリティタスク

```yaml
SecurityOperations:
  Daily:
    - Security Center alerts review
    - WAF blocked requests analysis
    - Failed login attempts monitoring
    
  Weekly:
    - Security patches assessment
    - RBAC permissions audit
    - Unused resources cleanup
    
  Monthly:
    - Penetration testing
    - Compliance report generation
    - Security training
    
  Quarterly:
    - Full security audit
    - DR drill execution
    - Access key rotation
```

### 13.2 コンプライアンス

```yaml
Compliance:
  Standards:
    - ISO 27001
    - PCI DSS (該当する場合)
    - 個人情報保護法
    
  Controls:
    - データ暗号化（保存時・転送時）
    - アクセスログの記録
    - 定期的な脆弱性スキャン
    - インシデント対応手順
    
  Audit:
    Frequency: Annual
    Scope:
      - Infrastructure security
      - Application security
      - Data protection
      - Access management
```

## 14. 改訂履歴

| バージョン | 日付 | 変更内容 |
|----------|------|----------|
| 1.0 | 2025-08-03 | 初版作成 |

## 付録A: Terraformサンプルコード

```hcl
# リソースグループ
resource "azurerm_resource_group" "main" {
  name     = "lawfinder-${var.environment}-rg"
  location = "japaneast"
  
  tags = {
    Environment = var.environment
    Project     = "LawFinder"
  }
}

# VNet設定
resource "azurerm_virtual_network" "main" {
  name                = "lawfinder-vnet"
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name
  address_space       = ["10.0.0.0/16"]
  
  tags = {
    Environment = var.environment
    Project     = "LawFinder"
  }
}

# サブネット
resource "azurerm_subnet" "public" {
  count                = 3
  name                 = "public-subnet-${count.index + 1}"
  resource_group_name  = azurerm_resource_group.main.name
  virtual_network_name = azurerm_virtual_network.main.name
  address_prefixes     = ["10.0.${count.index + 1}.0/24"]
}

# Container Registry
resource "azurerm_container_registry" "main" {
  name                = "lawfinder${var.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  sku                 = "Premium"
  admin_enabled       = false
  
  georeplications {
    location                = "japanwest"
    zone_redundancy_enabled = true
  }
  
  tags = {
    Environment = var.environment
    Project     = "LawFinder"
  }
}
```

## 付録B: 監視ダッシュボード設定

```json
{
  "version": "1.0",
  "items": [
    {
      "type": "metric",
      "width": 12,
      "height": 6,
      "properties": {
        "metrics": [
          {
            "resourceId": "/subscriptions/{subscription-id}/resourceGroups/lawfinder-rg/providers/Microsoft.ContainerInstance/containerGroups/lawfinder-api-group",
            "metricName": "CpuUsage",
            "aggregation": "Average"
          },
          {
            "resourceId": "/subscriptions/{subscription-id}/resourceGroups/lawfinder-rg/providers/Microsoft.ContainerInstance/containerGroups/lawfinder-api-group",
            "metricName": "MemoryUsage",
            "aggregation": "Average"
          }
        ],
        "title": "Container Instances API Metrics",
        "timespan": "PT1H"
      }
    },
    {
      "type": "metric",
      "width": 12,
      "height": 6,
      "properties": {
        "metrics": [
          {
            "resourceId": "/subscriptions/{subscription-id}/resourceGroups/lawfinder-rg/providers/Microsoft.Network/applicationGateways/lawfinder-appgw",
            "metricName": "ResponseTime",
            "aggregation": "Average"
          },
          {
            "resourceId": "/subscriptions/{subscription-id}/resourceGroups/lawfinder-rg/providers/Microsoft.Network/applicationGateways/lawfinder-appgw",
            "metricName": "TotalRequests",
            "aggregation": "Total"
          }
        ],
        "title": "Application Gateway Performance",
        "timespan": "PT1H"
      }
    }
  ]
}
```